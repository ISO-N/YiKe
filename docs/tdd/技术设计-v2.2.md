# 忆刻 (YiKe) — 技术设计文档 (TDD) v2.2

## 文档信息

| 项目 | 忆刻 (YiKe) |
|------|-------------|
| 版本 | v2.2 |
| 类型 | 技术设计文档 |
| 创建日期 | 2026-02-26 |
| 技术栈 | Flutter |

---

## 0. PRD 功能点覆盖矩阵

> **版本范围声明**：本文档对应 PRD v2.2 版本，包含 F9.1 深色主题、F9.2 跟随系统主题、F9.3 主题设置入口三个功能的详细技术设计。

### 0.1 功能需求覆盖

| PRD 编号 | 功能描述 | v2.2 范围 | 技术实现要点 |
|----------|----------|-----------|--------------|
| **F9.1** | 深色主题 | ✅ **做** | 新增 `AppTheme.dark()`，扩展 `AppColors` 深色配色 |
| **F9.2** | 跟随系统主题 | ✅ **做** | 使用 `ThemeMode.system` 跟随系统（Flutter 自动响应，无需额外 observer） |
| **F9.3** | 主题设置入口 | ✅ **做** | 设置页提供三选项（跟随系统/浅色/深色） |
| **F1-F8** | 历史功能 | ✅ **保留** | v1.0/v2.0/v2.1 已实现 |

### 0.2 新增依赖

| 包 | 版本 | 用途 |
|----|------|------|
| 无 | - | 使用 Flutter 内置 `ThemeMode` 机制 |

---

## 1. 技术架构

### 1.1 整体架构（继承 v1.0/v2.0）

采用 **Clean Architecture** 分层架构，本次迭代新增主题相关模块：

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                   │
│  新增: ThemeProvider (主题状态管理)                      │
│  新增: GradientBackground (渐变背景)                     │
│  改动: GlassCard (支持深色动态适配)                      │
│  改动: App (根组件使用 ThemeProvider)                   │
│  改动: 设置页 (新增主题设置入口)                         │
├─────────────────────────────────────────────────────────┤
│                       Domain Layer                      │
│  新增: ThemeSettingsRepository (主题设置仓储接口)       │
│  新增: ThemeSettingsEntity (主题设置实体)               │
├─────────────────────────────────────────────────────────┤
│                        Data Layer                       │
│  新增: ThemeSettingsRepositoryImpl (主题设置仓储实现)   │
│  改动: AppColors (新增深色配色)                         │
├─────────────────────────────────────────────────────────┤
│                    Infrastructure                       │
│  改动: AppTheme (新增 dark() 方法 + Material3 组件主题) │
└─────────────────────────────────────────────────────────┘
```

### 1.2 目录结构变更

新增/改动以下文件：

```
lib/
├── core/
│   ├── constants/
│   │   └── app_colors.dart           # 修改：新增深色配色常量
│   └── theme/
│       └── app_theme.dart            # 修改：新增 dark() 方法
├── domain/
│   ├── repositories/
│   │   └── theme_settings_repository.dart  # 新增：仓储接口
│   └── entities/
│       └── theme_settings.dart            # 新增：实体
├── data/
│   └── repositories/
│       └── theme_settings_repository_impl.dart  # 新增：仓储实现
├── presentation/
│   ├── providers/
│   │   └── theme_provider.dart        # 新增：主题状态管理
│   └── widgets/
│       └── gradient_background.dart   # 新增：渐变背景组件
├── di/
│   └── providers.dart                # 修改：新增 ThemeProvider 导出
└── app.dart                         # 修改：使用 ThemeProvider
```

---

## 2. 数据库设计

### 2.1 设置表（已存在）

使用现有的 `app_settings` 表：

| 键名 (key) | 值 (value) 格式 | 说明 |
|------------|----------------|------|
| `theme_mode` | 加密 JSON | `{"mode":"system\|light\|dark"}` |

> **存储策略**：由 `ThemeSettingsRepositoryImpl` 负责加密/JSON 语义，使用现有的 `getValue`/`upsertValue` 方法，无需修改 DAO 层。
>
> **读取兼容策略**：若解密或 JSON 解析失败，尝试将原始值当作明文 `"system"|"light"|"dark"` 解析（兼容旧格式或灰度数据），解析失败时回退默认值 `system`。

---

## 3. 主题配置设计

### 3.1 AppColors 扩展

新增深色模式颜色常量：

```dart
/// 文件用途：统一管理应用颜色常量（v2.2 新增深色模式）。
/// 作者：Codex
/// 创建日期：2026-02-26
library;

import 'package:flutter/material.dart';

class AppColors {
  AppColors._();

  // ========== 浅色模式颜色（原有）==========

  static const Color primary = Color(0xFF0D9488);
  static const Color primaryLight = Color(0xFF14B8A6);
  static const Color primaryDark = Color(0xFF134E4A);

  static const Color cta = Color(0xFFF97316);

  static const Color success = Color(0xFF22C55E);
  static const Color warning = Color(0xFFF59E0B);
  static const Color error = Color(0xFFEF4444);

  static const Color background = Color(0xFFF0FDFA);
  static const Color textPrimary = Color(0xFF0F172A);
  static const Color textSecondary = Color(0xFF64748B);

  static const Color glassSurface = Color.fromRGBO(255, 255, 255, 0.80);
  static const Color glassBorder = Color.fromRGBO(255, 255, 255, 0.40);

  // ========== 深色模式颜色（新增）==========

  /// 深色背景色 - 深蓝黑
  static const Color darkBackground = Color(0xFF1A1A2E);

  /// 深色表面色 - 深蓝
  static const Color darkSurface = Color(0xFF16213E);

  /// 深色文字主色
  static const Color darkTextPrimary = Color(0xFFF1F5F9);

  /// 深色文字次色
  static const Color darkTextSecondary = Color(0xFF94A3B8);

  /// 深色毛玻璃底色
  static const Color darkGlassSurface = Color.fromRGBO(22, 33, 62, 0.80);

  /// 深色毛玻璃边框
  static const Color darkGlassBorder = Color.fromRGBO(255, 255, 255, 0.10);

  /// 深色分割线
  static const Color darkDivider = Color.fromRGBO(255, 255, 255, 0.10);
}
```

### 3.2 毛玻璃组件深色适配（GlassCard）

> **评审修订**：现有 `GlassCard` 组件使用固定浅色常量，需改造为根据主题动态适配。

**实现方案**：在 `GlassCard` 中使用 `Theme.of(context)` 判断主题，引用 `AppColors` 常量保持单一真源。

```dart
/// 文件用途：通用毛玻璃卡片组件（Glassmorphism），支持深色模式。
/// 作者：Codex
/// 创建日期：2026-02-25
/// 最后更新：2026-02-26（支持深色模式）
library;

import 'dart:ui';

import 'package:flutter/material.dart';

import '../../core/constants/app_colors.dart';

class GlassCard extends StatelessWidget {
  const GlassCard({
    super.key,
    required this.child,
    this.borderRadius = 16,
    this.blurSigma = 14,
  });

  final Widget child;
  final double borderRadius;
  final double blurSigma;

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return ClipRRect(
      borderRadius: BorderRadius.circular(borderRadius),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: blurSigma, sigmaY: blurSigma),
        child: DecoratedBox(
          decoration: // 引用 AppColors 常量，保持单一真源
            BoxDecoration(
            color: isDark ? AppColors.darkGlassSurface : AppColors.glassSurface,
            borderRadius: BorderRadius.circular(borderRadius),
            border: Border.all(
              color: isDark ? AppColors.darkGlassBorder : AppColors.glassBorder,
            ),
          ),
          child: child,
        ),
      ),
    );
  }
}
```

> **注意**：示例已引用 `AppColors.darkGlassSurface` / `AppColors.darkGlassBorder`，与 3.1 节定义的常量保持一致。
                  ? const Color.fromRGBO(255, 255, 255, 0.10)
                  : const Color.fromRGBO(255, 255, 255, 0.40),
            ),
          ),
          child: child,
        ),
      ),
    );
  }
}
```

### 3.3 页面渐变背景深色适配

> **评审修订**：现有页面使用硬编码浅色渐变背景 (`home_page.dart:99`)，需改为根据主题动态适配。

**实现方案**：创建 `GradientBackground` 组件，引用 `AppColors` 常量保持单一真源。

```dart
/// 文件用途：页面渐变背景组件，支持深色模式。
/// 作者：Codex
/// 创建日期：2026-02-26
library;

import 'package:flutter/material.dart';

import '../../core/constants/app_colors.dart';

class GradientBackground extends StatelessWidget {
  const GradientBackground({super.key, required this.child});

  final Widget child;

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      decoration: BoxDecoration(
        gradient: isDark
            ? const LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  AppColors.darkBackground,       // #1A1A2E
                  AppColors.darkSurface,          // #16213E
                  AppColors.darkBackground,       // #1A1A2E
                ],
              )
            : const LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Color(0xFFE6FFFB),
                  AppColors.background,           // #F0FDFA
                  Color(0xFFFFF7ED),
                ],
              ),
      ),
      child: child,
    );
  }
}
```

**需改造页面**：
- `home_page.dart` - 使用 `GradientBackground` 替代硬编码渐变
- `calendar_page.dart` - 同上
- `statistics_page.dart` - 同上

### 3.4 AppTheme 扩展

新增 `dark()` 方法：

```dart
/// 文件用途：应用主题配置（颜色、组件样式等）。
/// 作者：Codex
/// 创建日期：2026-02-25
/// 最后更新：2026-02-26（新增深色主题）
library;

import 'package:flutter/material.dart';

import '../constants/app_colors.dart';

class AppTheme {
  AppTheme._();

  /// 构建浅色主题。
  static ThemeData light() {
    final colorScheme = ColorScheme.fromSeed(
      seedColor: AppColors.primary,
      brightness: Brightness.light,
      primary: AppColors.primary,
      secondary: AppColors.cta,
      surface: Colors.white,
    );

    return ThemeData(
      useMaterial3: true,
      colorScheme: colorScheme,
      scaffoldBackgroundColor: AppColors.background,
      // ... 其他配置保持不变
    );
  }

  /// 构建深色主题。
  ///
  /// 返回值：ThemeData。
  /// 异常：无。
  static ThemeData dark() {
    final colorScheme = ColorScheme.fromSeed(
      seedColor: AppColors.primaryLight, // 使用稍亮的种子色
      brightness: Brightness.dark,
      primary: AppColors.primaryLight,
      secondary: AppColors.cta,
      surface: AppColors.darkSurface,
    );

    return ThemeData(
      useMaterial3: true,
      colorScheme: colorScheme,
      scaffoldBackgroundColor: AppColors.darkBackground,
      appBarTheme: const AppBarTheme(
        backgroundColor: Colors.transparent,
        elevation: 0,
        centerTitle: true,
        titleTextStyle: TextStyle(
          color: AppColors.darkTextPrimary,
          fontSize: 18,
          fontWeight: FontWeight.w600,
        ),
        iconTheme: IconThemeData(color: AppColors.darkTextPrimary),
      ),
      cardTheme: CardTheme(
        color: AppColors.darkSurface,
        elevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
          side: const BorderSide(
            color: AppColors.darkGlassBorder,
            width: 1,
          ),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: AppColors.darkSurface,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: AppColors.darkGlassBorder),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(color: AppColors.darkGlassBorder),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: const BorderSide(
            color: AppColors.primaryLight,
            width: 1.5,
          ),
        ),
        labelStyle: const TextStyle(color: AppColors.darkTextSecondary),
        hintStyle: const TextStyle(color: AppColors.darkTextSecondary),
      ),
      textTheme: const TextTheme(
        headlineLarge: TextStyle(color: AppColors.darkTextPrimary),
        headlineMedium: TextStyle(color: AppColors.darkTextPrimary),
        titleLarge: TextStyle(color: AppColors.darkTextPrimary),
        titleMedium: TextStyle(color: AppColors.darkTextPrimary),
        bodyLarge: TextStyle(color: AppColors.darkTextPrimary),
        bodyMedium: TextStyle(color: AppColors.darkTextPrimary),
        bodySmall: TextStyle(color: AppColors.darkTextSecondary),
      ),
      dividerTheme: const DividerThemeData(
        color: AppColors.darkDivider,
        thickness: 1,
      ),

      /// Material3 NavigationBar 主题（替代 BottomNavigationBar）。
      ///
      /// Flutter 版本兼容性：
      /// - Flutter 3.16+ 推荐使用 WidgetStateProperty
      /// - 若需兼容更早版本，可改用 MaterialStateProperty + withOpacity()
      navigationBarTheme: NavigationBarThemeData(
        backgroundColor: AppColors.darkSurface,
        indicatorColor: AppColors.primaryLight.withValues(alpha: 0.2),
        labelTextStyle: WidgetStateProperty.resolveWith((states) {
          if (states.contains(WidgetState.selected)) {
            return const TextStyle(
              color: AppColors.primaryLight,
              fontSize: 12,
              fontWeight: FontWeight.w500,
            );
          }
          return const TextStyle(
            color: AppColors.darkTextSecondary,
            fontSize: 12,
          );
        }),
        iconTheme: WidgetStateProperty.resolveWith((states) {
          if (states.contains(WidgetState.selected)) {
            return const IconThemeData(color: AppColors.primaryLight);
          }
          return const IconThemeData(color: AppColors.darkTextSecondary);
        }),
      ),

      /// 底部弹窗主题。
      bottomSheetTheme: const BottomSheetThemeData(
        backgroundColor: AppColors.darkSurface,
        modalBackgroundColor: AppColors.darkSurface,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
        ),
      ),

      /// 对话框主题。
      dialogTheme: DialogTheme(
        backgroundColor: AppColors.darkSurface,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
      ),

      snackBarTheme: SnackBarThemeData(
        backgroundColor: AppColors.darkSurface,
        contentTextStyle: const TextStyle(color: AppColors.darkTextPrimary),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }
}
```

---

## 4. 状态管理设计

### 4.1 ThemeRepository（新增）

> **评审修订**：主题设置必须走 Repository 层（与既有用法一致），而非直接依赖 SettingsDao。

新增主题设置仓储接口与实现：

```dart
/// 文件用途：主题设置仓储接口。
/// 作者：Codex
/// 创建日期：2026-02-26
library;

import '../entities/theme_settings.dart';

/// 主题设置仓储接口。
abstract class ThemeSettingsRepository {
  /// 获取主题模式。
  Future<ThemeSettingsEntity> getThemeSettings();

  /// 保存主题模式。
  Future<void> saveThemeSettings(ThemeSettingsEntity settings);
}
```

```dart
/// 文件用途：主题设置仓储实现。
/// 作者：Codex
/// 创建日期：2026-02-26
library;

import 'dart:convert';

import '../../domain/entities/theme_settings.dart';
import '../../domain/repositories/theme_settings_repository.dart';
import '../../infrastructure/storage/secure_storage_service.dart';
import '../../infrastructure/storage/settings_crypto.dart';
import '../database/daos/settings_dao.dart';

/// 主题设置仓储实现。
///
/// 存储策略：
/// - key: 'theme_mode'
/// - value: 加密的 JSON 字符串 '{"mode":"system|light|dark"}'
/// - 与现有设置项保持一致（加密 + JSON 包装）
class ThemeSettingsRepositoryImpl implements ThemeSettingsRepository {
  ThemeSettingsRepositoryImpl({
    required this.dao,
    required this.secureStorageService,
  }) : _crypto = SettingsCrypto(secureStorageService: secureStorageService);

  final SettingsDao dao;
  final SecureStorageService secureStorageService;
  final SettingsCrypto _crypto;

  static const String _key = 'theme_mode';

  @override
  Future<ThemeSettingsEntity> getThemeSettings() async {
    try {
      final stored = await dao.getValue(_key);
      if (stored == null) {
        return ThemeSettingsEntity.defaults();
      }
      final decrypted = await _crypto.decrypt(stored);
      final decoded = jsonDecode(decrypted) as Map<String, dynamic>;
      return ThemeSettingsEntity.fromJson(decoded);
    } catch (e) {
      return ThemeSettingsEntity.defaults();
    }
  }

  @override
  Future<void> saveThemeSettings(ThemeSettingsEntity settings) async {
    final json = jsonEncode(settings.toJson());
    final encrypted = await _crypto.encrypt(json);
    await dao.upsertValue(_key, encrypted);
  }
}
```

```dart
/// 文件用途：主题设置实体。
/// 作者：Codex
/// 创建日期：2026-02-26
library;

/// 主题设置实体。
class ThemeSettingsEntity {
  const ThemeSettingsEntity({required this.mode});

  final String mode; // 'system' | 'light' | 'dark'

  factory ThemeSettingsEntity.defaults() {
    return const ThemeSettingsEntity(mode: 'system');
  }

  factory ThemeSettingsEntity.fromJson(Map<String, dynamic> json) {
    return ThemeSettingsEntity(
      mode: json['mode'] as String? ?? 'system',
    );
  }

  Map<String, dynamic> toJson() => {'mode': mode};
}
```

### 4.2 ThemeProvider

> **评审修订**：
> - 走 Repository 层而非直接用 SettingsDao
> - "跟随系统"不需要额外监听，Flutter 的 `ThemeMode.system` 会自动响应 `platformBrightness` 变化

新增主题状态管理 Provider：

```dart
/// 文件用途：主题模式状态管理 Provider。
/// 作者：Codex
/// 创建日期：2026-02-26
/// 最后更新：2026-02-26（走 Repository 层，符合架构一致性）
library;

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../di/providers.dart';

/// 主题模式状态。
enum AppThemeMode {
  system('system', '跟随系统'),
  light('light', '浅色'),
  dark('dark', '深色');

  const AppThemeMode(this.value, this.label);
  final String value;
  final String label;

  /// 从字符串值转换。
  static AppThemeMode fromValue(String value) {
    return AppThemeMode.values.firstWhere(
      (e) => e.value == value,
      orElse: () => AppThemeMode.system,
    );
  }

  /// 转换为 Flutter ThemeMode。
  ThemeMode toThemeMode() {
    switch (this) {
      case AppThemeMode.system:
        return ThemeMode.system;
      case AppThemeMode.light:
        return ThemeMode.light;
      case AppThemeMode.dark:
        return ThemeMode.dark;
    }
  }
}

/// 主题模式 Provider。
final themeModeProvider =
    StateNotifierProvider<ThemeModeNotifier, AppThemeMode>((ref) {
  final repository = ref.read(themeSettingsRepositoryProvider);
  return ThemeModeNotifier(repository);
});

/// 主题模式状态管理器。
///
/// 负责：
/// 1. 启动时从 Repository 加载用户偏好
/// 2. 提供切换主题的方法
/// 3. 持久化用户选择到数据库
/// 4. "跟随系统"模式下，Flutter 会自动响应 platformBrightness 变化
class ThemeModeNotifier extends StateNotifier<AppThemeMode> {
  ThemeModeNotifier(this._repository) : super(AppThemeMode.system) {
    _loadThemeMode();
  }

  final ThemeSettingsRepository _repository;

  /// 从 Repository 加载主题模式。
  ///
  /// 返回值：Future（无返回值）。
  /// 异常：数据库异常时使用默认主题。
  Future<void> _loadThemeMode() async {
    try {
      final settings = await _repository.getThemeSettings();
      state = AppThemeMode.fromValue(settings.mode);
    } catch (e) {
      // 数据库异常时使用默认主题
      state = AppThemeMode.system;
    }
  }

  /// 切换主题模式。
  ///
  /// 参数：
  /// - [mode] 新的主题模式
  /// 返回值：Future（无返回值）。
  /// 异常：数据库写入失败时只更新内存状态。
  Future<void> setThemeMode(AppThemeMode mode) async {
    state = mode;
    try {
      await _repository.saveThemeSettings(
        ThemeSettingsEntity(mode: mode.value),
      );
    } catch (e) {
      // 数据库写入失败时只更新内存状态，下次启动会恢复默认
    }
  }
}
```

### 4.2 providers.dart 扩展

新增 Provider 定义与导出：

```dart
// 在 providers.dart 中添加

// ========== Theme Settings Repository ==========
import '../domain/repositories/theme_settings_repository.dart';
import '../data/repositories/theme_settings_repository_impl.dart';
import '../infrastructure/storage/secure_storage_service.dart';

/// ThemeSettingsRepository Provider。
///
/// 依赖：SettingsDao、SecureStorageService（在现有 providers 中已定义）
final themeSettingsRepositoryProvider = Provider<ThemeSettingsRepository>((ref) {
  final dao = ref.read(settingsDaoProvider);
  final secureStorage = ref.read(secureStorageServiceProvider);
  return ThemeSettingsRepositoryImpl(
    dao: dao,
    secureStorageService: secureStorage,
  );
});

// ========== Theme Mode Provider ==========
import '../presentation/providers/theme_provider.dart';
export '../presentation/providers/theme_provider.dart';
```

> **依赖说明**：
> - `settingsDaoProvider` - 已在 providers.dart 中定义
> - `secureStorageServiceProvider` - 已在 infrastructure 层定义
> - 注入方式与现有 Repository（如 `SettingsRepositoryImpl`）保持一致

---

## 5. 页面改动设计

### 5.1 App 根组件改动

```dart
/// 文件用途：App 根组件，提供主题与路由。
/// 作者：Codex
/// 创建日期：2026-02-25
/// 最后更新：2026-02-26（新增主题支持）
library;

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'core/theme/app_theme.dart';
import 'di/providers.dart';
import 'infrastructure/router/app_router.dart';
import 'presentation/providers/theme_provider.dart';

class YiKeApp extends ConsumerWidget {
  const YiKeApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final router = ref.watch(appRouterProvider);
    final themeMode = ref.watch(themeModeProvider);

    return MaterialApp.router(
      title: '忆刻',
      theme: AppTheme.light(),
      darkTheme: AppTheme.dark(),
      themeMode: themeMode.toThemeMode(),
      routerConfig: router,
      debugShowCheckedModeBanner: false,
    );
  }
}
```

### 5.2 设置页新增主题入口

在现有设置页中添加主题设置项：

```dart
/// 文件用途：设置页面。
/// 作者：Codex
/// 创建日期：2026-02-25
/// 最后更新：2026-02-26（新增主题设置）
library;

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../providers/theme_provider.dart';
import 'widgets/theme_mode_sheet.dart';

class SettingsPage extends ConsumerWidget {
  const SettingsPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentThemeMode = ref.watch(themeModeProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('设置')),
      body: ListView(
        children: [
          // ... 其他设置项保持不变

          // 新增：外观设置
          const _SectionHeader(title: '外观设置'),
          ListTile(
            leading: const Icon(Icons.palette_outlined),
            title: const Text('主题模式'),
            subtitle: Text(currentThemeMode.label),
            trailing: const Icon(Icons.chevron_right),
            onTap: () => _showThemeModeSheet(context),
          ),

          // ... 其他设置项
        ],
      ),
    );
  }

  void _showThemeModeSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      builder: (context) => const ThemeModeSheet(),
    );
  }
}
```

### 5.3 主题模式选择底部 Sheet

```dart
/// 文件用途：主题模式选择底部弹窗。
/// 作者：Codex
/// 创建日期：2026-02-26
library;

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../providers/theme_provider.dart';

/// 主题模式选择底部弹窗。
class ThemeModeSheet extends ConsumerWidget {
  const ThemeModeSheet({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentMode = ref.watch(themeModeProvider);

    return SafeArea(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          const SizedBox(height: 8),
          Container(
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: Colors.grey[300],
              borderRadius: BorderRadius.circular(2),
            ),
          ),
          const SizedBox(height: 16),
          const Text(
            '选择主题模式',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
          ),
          const SizedBox(height: 16),
          ...AppThemeMode.values.map((mode) => RadioListTile<AppThemeMode>(
                value: mode,
                groupValue: currentMode,
                title: Text(mode.label),
                subtitle: Text(_getSubtitle(mode)),
                onChanged: (value) {
                  if (value != null) {
                    ref.read(themeModeProvider.notifier).setThemeMode(value);
                    Navigator.pop(context);
                  }
                },
              )),
          const SizedBox(height: 16),
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16),
            child: SizedBox(
              width: double.infinity,
              child: TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('取消'),
              ),
            ),
          ),
          const SizedBox(height: 16),
        ],
      ),
    );
  }

  String _getSubtitle(AppThemeMode mode) {
    switch (mode) {
      case AppThemeMode.system:
        return '自动跟随手机设置';
      case AppThemeMode.light:
        return '明亮模式';
      case AppThemeMode.dark:
        return '护眼模式，适配夜间';
    }
  }
}
```

---

## 6. 路由设计

### 6.1 路由变更（无）

本次迭代不涉及路由变更，设置页使用现有路由 `/settings`。

---

## 7. 实现步骤

### 步骤 1：扩展颜色常量（0.5 天）

1. 修改 `lib/core/constants/app_colors.dart`，添加深色模式颜色常量
2. 验证颜色值符合设计稿

### 步骤 2：实现深色主题（1 天）

1. 修改 `lib/core/theme/app_theme.dart`，新增 `dark()` 方法
2. 适配所有组件样式（Card、Input、Text 等）
3. 在 `app.dart` 中集成 `darkTheme` 参数

### 步骤 3：实现主题状态管理（0.5 天）

1. 新增 `lib/presentation/providers/theme_provider.dart`
2. 在 `providers.dart` 中导出
3. 修改 `app.dart` 使用 `ThemeProvider`

### 步骤 4：实现主题设置入口（0.5 天）

1. 在设置页添加主题设置项
2. 新增 `ThemeModeSheet` 组件
3. 集成数据库持久化

### 步骤 5：测试与调优（0.5 天）

1. 深色模式全页面回归测试
2. 跟随系统功能测试
3. 主题切换动画优化
4. 对比度无障碍验证

---

## 8. 验收标准

### 8.1 功能验收

- [ ] 深色主题 `AppTheme.dark()` 正确返回深色 `ThemeData`
- [ ] `themeModeProvider` 正确加载和保存主题设置
- [ ] 设置页主题选项点击后弹出底部 Sheet
- [ ] 选择主题后立即生效，无需重启
- [ ] 退出应用后再次进入，保持上次选择

### 8.2 跟随系统验收

- [ ] 选择"跟随系统"时，应用主题与系统主题一致
- [ ] 切换系统主题后，应用在 500ms 内同步变化

### 8.3 视觉验收

- [ ] 深色模式下所有页面背景为 #1A1A2E
- [ ] 卡片背景为 #16213E，带有可见边框
- [ ] 文字颜色符合对比度要求（≥ 4.5:1）

### 8.4 兼容性验收

- [ ] Android 8.0+ 深色主题正常
- [ ] iOS 14+ 深色主题正常

---

## 9. 风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| 第三方组件不支持深色 | 部分组件显示异常 | 使用 Material 3 组件，自定义主题覆盖 |
| 系统主题监听失败 | 跟随系统失效 | 提供手动切换兜底方案 |
| 数据库写入失败 | 主题设置丢失 | 内存状态更新，异常静默处理 |

---

## 10. 相关文件清单

### 10.1 改动文件

| 文件路径 | 改动类型 | 说明 |
|----------|----------|------|
| `lib/core/constants/app_colors.dart` | 修改 | 新增深色颜色常量 |
| `lib/core/theme/app_theme.dart` | 修改 | 新增 `dark()` 方法、NavigationBarThemeData 等 |
| `lib/presentation/widgets/glass_card.dart` | 修改 | 支持深色模式动态适配 |
| `lib/app.dart` | 修改 | 集成主题 Provider |
| `lib/di/providers.dart` | 修改 | 导出 ThemeProvider + ThemeSettingsRepository |
| `lib/presentation/pages/home/home_page.dart` | 修改 | 使用 GradientBackground |
| `lib/presentation/pages/calendar/calendar_page.dart` | 修改 | 使用 GradientBackground |
| `lib/presentation/pages/statistics/statistics_page.dart` | 修改 | 使用 GradientBackground |

### 10.2 新增文件

| 文件路径 | 说明 |
|----------|------|
| `lib/domain/repositories/theme_settings_repository.dart` | 主题设置仓储接口 |
| `lib/domain/entities/theme_settings.dart` | 主题设置实体 |
| `lib/data/repositories/theme_settings_repository_impl.dart` | 主题设置仓储实现 |
| `lib/presentation/widgets/gradient_background.dart` | 渐变背景组件 |
| `lib/presentation/providers/theme_provider.dart` | 主题状态管理 |
| `lib/presentation/pages/settings/widgets/theme_mode_sheet.dart` | 主题选择底部弹窗 |
