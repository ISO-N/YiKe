# 忆刻 (YiKe) — 技术设计文档 v2.1

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v2.1 |
| 类型 | 技术设计文档 |
| 创建日期 | 2026-02-26 |
| 技术栈 | Flutter |

---

## 1. PRD 功能点覆盖矩阵

### 1.1 功能需求覆盖

| PRD 编号 | 功能描述 | 范围 | 技术实现要点 |
|----------|----------|------|-------------|
| F1.1 | 批量导入 | ✅ 做 | 文件解析器 (txt/csv/md)，导入预览页 |
| F1.2 | 快速模板 | ✅ 做 | 模板表/DAO/Repository，占位符替换 |
| F1.3 | 语音输入 | ✅ 做 | speech_to_text 封装，语音输入组件 |
| F1.4 | OCR 识别 | ✅ 做 | ML Kit 文字识别，图片选择 |
| F1.5 | 复习预览 | ✅ 做 | 预览面板，自定义间隔配置 |
| F1.6 | 内容关联 | ✅ 做 | 主题表/DAO/Repository，主题管理页 |

### 1.2 新增依赖

| 包 | 版本 | 用途 |
|----|------|------|
| file_picker | ^8.0.0 | 文件选择（批量导入） |
| csv | ^6.0.0 | CSV 解析 |
| speech_to_text | ^6.0.0 | 语音识别 |
| google_mlkit_text_recognition | ^0.11.0 | OCR 文字识别 |
| image_picker | ^1.0.0 | 图片选择（相册/相机） |
| permission_handler | ^11.0.0 | 权限管理 |

---

## 2. 技术架构

### 2.1 整体架构

采用 **Clean Architecture** 分层架构：

```
Presentation Layer
├── Pages: InputPage, ImportPreviewPage, TemplatesPage
│         TopicsPage, TopicDetailPage, OcrResultPage
├── Widgets: ReviewPreviewPanel, SpeechInputField
└── Providers: TemplateProvider, TopicProvider, ImportProvider, ReviewConfigProvider

Domain Layer
└── UseCases: ImportLearningItems, ManageTemplate
              OcrRecognition, ManageTopic

Data Layer
├── Tables: LearningTemplates, LearningTopics, TopicItemRelations
├── DAOs: LearningTemplateDao, LearningTopicDao
└── Repositories: LearningTemplateRepository, LearningTopicRepository
```

### 2.2 目录结构变更

新增文件清单：

```
lib/
├── core/utils/
│   └── file_parser.dart          # F1.1 文件解析
├── infrastructure/
│   ├── speech/
│   │   └── speech_service.dart   # F1.3 语音服务
│   └── ocr/
│       └── ocr_service.dart      # F1.4 OCR 服务
├── data/database/
│   ├── tables/
│   │   ├── learning_template.dart # F1.2 模板表
│   │   └── learning_topic.dart   # F1.6 主题表
│   └── daos/
│       ├── learning_template_dao.dart
│       └── learning_topic_dao.dart
├── data/repositories/
│   ├── learning_template_repository_impl.dart
│   └── learning_topic_repository_impl.dart
├── domain/
│   ├── entities/
│   │   ├── learning_template.dart
│   │   └── learning_topic.dart
│   ├── repositories/
│   │   ├── learning_template_repository.dart
│   │   └── learning_topic_repository.dart
│   └── usecases/
│       ├── import_learning_items_usecase.dart
│       ├── manage_template_usecase.dart
│       ├── ocr_recognition_usecase.dart
│       └── manage_topic_usecase.dart
├── presentation/pages/
│   ├── input/
│   │   ├── import_preview_page.dart
│   │   ├── templates_page.dart
│   │   └── ocr_result_page.dart
│   └── topics/
│       ├── topics_page.dart
│       └── topic_detail_page.dart
├── presentation/widgets/
│   ├── review_preview_panel.dart
│   └── speech_input_field.dart
└── di/providers.dart
```

---

## 3. 数据库设计

### 3.1 新增数据表

#### 3.1.1 学习模板表 (learning_templates)

```dart
/// 学习模板表。
/// 存储用户保存的常用内容模板，支持占位符替换。
class LearningTemplates extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text().withLength(min: 1, max: 30)();      // 模板名称
  TextColumn get titlePattern => text().withLength(min: 1, max: 50)(); // 标题模板
  TextColumn get notePattern => text().nullable()();                // 备注模板
  TextColumn get tags => text().withDefault(const Constant('[]'))(); // 标签 JSON
  IntColumn get sortOrder => integer().withDefault(const Constant(0))(); // 排序
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();
  DateTimeColumn get updatedAt => dateTime().nullable()();
}
```

#### 3.1.2 学习主题表 (learning_topics)

```dart
/// 学习主题表。
/// 将多个相关学习内容关联成主题复习。
class LearningTopics extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text().withLength(min: 1, max: 50)();    // 主题名称
  TextColumn get description => text().nullable()();                // 主题描述
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();
  DateTimeColumn get updatedAt => dateTime().nullable()();
}

/// 主题-内容关联表（多对多）。
/// 包含外键约束和复合唯一索引，防止重复关联。
class TopicItemRelations extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get topicId => integer().references(LearningTopics, #id)();
  IntColumn get learningItemId => integer().references(LearningItems, #id)();
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();

  @override
  List<Set<Column>> get uniqueKeys => [
    {topicId, learningItemId}  // 复合唯一索引，防止重复关联
  ];
}
```

### 3.2 数据库迁移

修改 `lib/data/database/database.dart`：

```dart
@DriftDatabase(tables: [
  LearningItems,
  ReviewTasks,
  AppSettingsTable,
  LearningTemplates,    // 新增
  LearningTopics,       // 新增
  TopicItemRelations,   // 新增
])
class AppDatabase extends _$AppDatabase {
  @override
  int get schemaVersion => 2;

  @override
  MigrationStrategy get migration => MigrationStrategy(
    onUpgrade: (migrator, from, to) async {
      if (from < 2) {
        await migrator.createTable(learningTemplates);
        await migrator.createTable(learningTopics);
        await migrator.createTable(topicItemRelations);
      }
    },
  );
}
```

---

## 4. 领域层设计

### 4.1 实体定义

#### LearningTemplateEntity

```dart
class LearningTemplateEntity {
  const LearningTemplateEntity({
    this.id,
    required this.name,
    required this.titlePattern,
    this.notePattern,
    required this.tags,
    this.sortOrder = 0,
    required this.createdAt,
    this.updatedAt,
  });

  final int? id;
  final String name;
  final String titlePattern;
  final String? notePattern;
  final List<String> tags;
  final int sortOrder;
  final DateTime createdAt;
  final DateTime? updatedAt;
}
```

#### LearningTopicEntity

```dart
class LearningTopicEntity {
  const LearningTopicEntity({
    this.id,
    required this.name,
    this.description,
    required this.createdAt,
    this.updatedAt,
    this.itemIds = const [],
  });

  final int? id;
  final String name;
  final String? description;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final List<int> itemIds;
}
```

### 4.2 仓储接口

#### LearningTemplateRepository

```dart
abstract class LearningTemplateRepository {
  Future<LearningTemplateEntity> create(LearningTemplateEntity template);
  Future<LearningTemplateEntity> update(LearningTemplateEntity template);
  Future<void> delete(int id);
  Future<LearningTemplateEntity?> getById(int id);
  Future<List<LearningTemplateEntity>> getAll();
}
```

#### LearningTopicRepository

```dart
abstract class LearningTopicRepository {
  Future<LearningTopicEntity> create(LearningTopicEntity topic);
  Future<LearningTopicEntity> update(LearningTopicEntity topic);
  Future<void> delete(int id);
  Future<LearningTopicEntity?> getById(int id);
  Future<List<LearningTopicEntity>> getAll();
  Future<void> addItemToTopic(int topicId, int learningItemId);
  Future<void> removeItemFromTopic(int topicId, int learningItemId);
  Future<List<int>> getItemIdsByTopicId(int topicId);
}
```

---

## 5. 用例设计

### 5.1 ImportLearningItemsUseCase

```dart
class ImportResult {
  final int successCount;
  final int failedCount;
  final List<String> errors;
}

class ImportLearningItemsUseCase {
  /// 执行批量导入。
  ///
  /// 策略：
  /// - 复用现有 CreateLearningItemUseCase 生成复习任务
  /// - 逐条失败不中断，累计失败数后统一返回
  /// - 大文件（>1000条）分批处理（每批100条）
  Future<ImportResult> execute(List<LearningItemEntity> items) async {
    // 1. 分批处理（每批100条）
    // 2. 遍历每批，逐条调用 CreateLearningItemUseCase
    // 3. 失败时记录错误，继续处理下一条
    // 4. 返回 ImportResult（含成功/失败统计）
  }
}
```

**关键决策**：
- **事务策略**：逐条失败不中断，单条失败不影响其他条目
- **性能优化**：大文件分批处理，避免内存溢出
- **复用**：调用现有 CreateLearningItemUseCase，确保复习任务生成逻辑一致

### 5.2 ManageTemplateUseCase

```dart
class TemplateParams {
  final String name;
  final String titlePattern;
  final String? notePattern;
  final List<String> tags;
  final int sortOrder;
}

class ManageTemplateUseCase {
  Future<LearningTemplateEntity> create(TemplateParams params);

  /// 应用模板（替换占位符）
  Map<String, String> applyTemplate(LearningTemplateEntity template) {
    // {date} → 2026-02-26
    // {day} → 2026-2-26
    // {weekday} → 周三
  }
}
```

### 5.3 复习间隔配置（F1.5）

复习间隔配置使用现有的 AppSettingsTable 存储：

```dart
/// 复习间隔配置存储
/// - Key: 'review_intervals'
/// - 存储格式: JSON 数组
/// - 默认值: [1, 2, 4, 7, 15]
///
/// 示例：
/// [
///   {"round": 1, "interval": 1, "enabled": true},
///   {"round": 2, "interval": 2, "enabled": true},
///   {"round": 3, "interval": 4, "enabled": true},
///   {"round": 4, "interval": 7, "enabled": true},
///   {"round": 5, "interval": 15, "enabled": true}
/// ]
```

**使用方式**：
- 通过 AppSettingsRepository 获取/设置
- 每次录入时读取配置，生成对应复习任务
- 仅影响**新录入内容**，不对历史任务进行回算

### 5.4 OcrRecognitionUseCase

```dart
class OcrResult {
  final String text;
  final double confidence;
}

class OcrRecognitionUseCase {
  Future<OcrResult> execute(String imagePath) async {
    // 调用 Google ML Kit 进行 OCR
  }
}
```

---

## 6. 路由配置

新增路由：

```dart
GoRoute(
  path: '/input/import',
  builder: (context, state) => ImportPreviewPage(...),
),
GoRoute(
  path: '/input/templates',
  builder: (context, state) => TemplatesPage(),
),
GoRoute(
  path: '/input/ocr',
  builder: (context, state) => OcrResultPage(),
),
GoRoute(
  path: '/topics',
  builder: (context, state) => TopicsPage(),
),
GoRoute(
  path: '/topics/:id',
  builder: (context, state) => TopicDetailPage(topicId: int.parse(...)),
),
```

---

## 7. 组件设计

### 7.1 复习预览面板 (ReviewPreviewPanel)

```dart
class ReviewPreviewPanel extends StatefulWidget {
  // 显示 5 个艾宾浩斯复习节点
  // 支持启用/禁用特定轮次
  // 支持自定义间隔调整
}
```

### 7.2 语音输入组件 (SpeechInputField)

```dart
class SpeechInputField extends StatefulWidget {
  // 集成 speech_to_text
  // 显示录音状态
  // 识别结果自动填充
}
```

---

## 8. 工具类

### 8.1 FileParser 文件解析器

```dart
class FileParser {
  // 解析 TXT（每行一条）
  static List<ParsedItem> _parseTxt(String content);

  // 解析 CSV（标题,备注,标签）
  static List<ParsedItem> _parseCsv(String content);

  // 解析 Markdown（# 标题作为标题行）
  static List<ParsedItem> _parseMarkdown(String content);
}
```

---

## 9. 实现顺序

| 阶段 | 功能 | 工作量 |
|------|------|--------|
| Phase 1 | F1.2 快速模板 | 2-3 天 |
| Phase 2 | F1.5 复习预览 | 1-2 天 |
| Phase 3 | F1.1 批量导入 | 2-3 天 |
| Phase 4 | F1.3 语音输入 | 1-2 天 |
| Phase 5 | F1.4 OCR 识别 | 2-3 天 |
| Phase 6 | F1.6 内容关联 | 3-4 天 |

**总计：11-17 天**

---

## 10. 验证方式

| 功能 | 验证点 |
|------|--------|
| F1.1 | TXT/CSV/MD 导入成功，预览可编辑 |
| F1.2 | 模板保存/填充正常，占位符替换正确 |
| F1.3 | 语音识别准确，权限处理正常 |
| F1.4 | OCR 识别准确，编辑后保存正常 |
| F1.5 | 预览面板显示正确，间隔调整生效 |
| F1.6 | 主题 CRUD 正常，关联功能正常 |

---

## 11. 关键文件清单

| 优先级 | 文件 | 说明 |
|--------|------|------|
| P0 | database.dart | 新增表和迁移 |
| P0 | providers.dart | 新增 Provider |
| P0 | app_router.dart | 新增路由 |
| P1 | input_page.dart | 集成新功能入口 |
| P2 | create_learning_item_usecase.dart | 扩展支持自定义间隔 |
