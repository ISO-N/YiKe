# 忆刻 (YiKe) — 技术设计文档 (TDD) v2.0

## 文档信息

| 项目 | 忆刻 (YiKe) |
|------|-------------|
| 版本 | v2.0 |
| 类型 | 技术设计文档 |
| 创建日期 | 2026-02-25 |
| 技术栈 | Flutter |

---

## 0. PRD 功能点覆盖矩阵

> **版本范围声明**：本文档对应 PRD v2.0 版本，包含 F6 日历视图、F7 学习统计、F8 数据导出三个功能的详细技术设计。

### 0.1 功能需求覆盖

| PRD 编号 | 功能描述 | v2.0 范围 | 技术实现要点 |
|----------|----------|-----------|--------------|
| **F6** | 日历视图 | ✅ **做** | 月历 + 任务列表，颜色区分状态，点击日期查看详情 |
| **F7** | 学习统计 | ✅ **做** | 打卡天数、环形进度、标签分布饼图 |
| **F8** | 数据导出与备份 | ✅ **做** | JSON/CSV 文件生成，系统分享 |
| **F1-F5** | MVP 功能 | ✅ **保留** | v1.0 已实现 |

### 0.2 新增依赖

| 包 | 版本 | 用途 |
|----|------|------|
| `table_calendar` | ^3.0.0 | 日历组件 |
| `fl_chart` | ^0.66.0 | 饼图、环形图 |
| `share_plus` | ^7.0.0 | 系统分享 |

---

## 1. 技术架构

### 1.1 整体架构（继承 v1.0）

采用 **Clean Architecture** 分层架构，新增内容：

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                   │
│  Pages: HomePage, CalendarPage, StatisticsPage, ExportPage│
├─────────────────────────────────────────────────────────┤
│  新增 UseCase: GetCalendarTasks, GetStatistics, ExportData│
├─────────────────────────────────────────────────────────┤
│  新增 Provider: CalendarProvider, StatisticsProvider    │
└─────────────────────────────────────────────────────────┘
```

### 1.2 路由壳策略

**决策**：沿用现有 `ShellRoute` + `NavigationBar` 方案，扩展到 4 个 Tab。

原因：
- 现有实现是 `ShellRoute` + `ShellScaffold`（`lib/infrastructure/router/app_router.dart`）
- 重构为 `StatefulShellRoute` 成本较高且收益不大
- 保持一致性，减少引入风险

**扩展方案**：
- 在 `ShellScaffold` 的 `NavigationBar.destinations` 新增 2 个 Tab
- 在 `app_router.dart` 新增 2 个 `GoRoute` 分支

### 1.2 目录结构变更

新增以下文件：

```
lib/
├── presentation/pages/
│   ├── calendar/
│   │   ├── calendar_page.dart          # F6 日历视图
│   │   └── widgets/
│   │       ├── calendar_grid.dart
│   │       └── day_task_list.dart
│   ├── statistics/
│   │   └── statistics_page.dart         # F7 学习统计
│   └── settings/
│       └── export_page.dart             # F8 数据导出
├── presentation/providers/
│   ├── calendar_provider.dart           # F6 状态管理
│   └── statistics_provider.dart         # F7 状态管理
└── domain/usecases/
    ├── get_calendar_tasks_usecase.dart  # F6 获取日历数据
    ├── get_statistics_usecase.dart     # F7 获取统计数据
    └── export_data_usecase.dart       # F8 导出数据
```

---

## 2. 数据库设计

### 2.1 现有表结构（无需改动）

| 表名 | 用途 | 状态 |
|------|------|------|
| `learning_items` | 学习内容 | v1.0 已定义 |
| `review_tasks` | 复习任务 | v1.0 已定义 |
| `app_settings` | 应用设置 | v1.0 已定义 |

### 2.2 新增 DAO 方法

#### ReviewTaskDao 新增方法

```dart
/// F6: 获取指定月份每天的任务统计（用于日历气泡）
/// 返回: Map<DateTime, (pending, done, skipped)>
Future<Map<DateTime, TaskDayStats>> getMonthlyTaskStats(int year, int month);

/// F6: 获取指定日期范围的任务列表（用于日历点击详情）
Future<List<ReviewTaskWithItemModel>> getTasksInRange(DateTime start, DateTime end);

/// F7: 获取连续打卡天数（从今天往前计算连续完成的天数）
/// 跳过(skip)的日期不算断签
Future<int> getConsecutiveCompletedDays();

/// F7: 获取指定日期范围的完成率
Future<(int completed, int total)> getTaskStatsInRange(DateTime start, DateTime end);

/// F6: 获取指定日期的任务（含学习内容信息）
Future<List<ReviewTaskWithItemModel>> getTasksByDateWithItem(DateTime date);
```

#### LearningItemDao 新增方法

```dart
/// F7: 获取各标签的学习内容数量（用于饼图）
Future<Map<String, int>> getTagDistribution();

/// F7: 获取日期范围内的学习内容数量
Future<int> getLearningItemCountInRange(DateTime start, DateTime end);
```

### 2.3 数据模型

```dart
/// F6: 日统计模型
class TaskDayStats {
  final int pending;
  final int done;
  final int skipped;
  final int total;
}

/// F7: 统计结果模型
class StatisticsResult {
  final int consecutiveDays;      // 连续打卡天数
  final int weekCompleted;         // 本周完成数
  final int weekTotal;            // 本周总数
  final int monthCompleted;        // 本月完成数
  final int monthTotal;           // 本月总数
  final Map<String, int> tagDistribution;  // 标签分布
}
```

### 2.4 日期 Key 规范

**重要**：所有 `Map<DateTime, ...>` 作为 key 时，必须归一化到 `DateTime(year, month, day, 0, 0, 0)`。

```dart
/// 归一化日期辅助函数
DateTime normalizeDateKey(DateTime date) {
  return DateTime(date.year, date.month, date.day);
}
```

**原因**：避免 `table_calendar` 或数据库返回的时间带有时区/时分秒差异导致 key 匹配失败。

---

## 3. 领域层设计

### 3.1 新增 UseCase

#### GetCalendarTasksUseCase (F6)

```dart
/// 获取日历任务用例
/// 用于日历视图的数据展示
class GetCalendarTasksUseCase {
  final ReviewTaskRepository _reviewTaskRepo;

  /// 获取指定月份的日历数据
  Future<CalendarMonthResult> execute({
    required int year,
    required int month,
  }) async {
    // 1. 获取当月每天的任务统计
    final dayStats = await _reviewTaskRepo.getMonthlyTaskStats(year, month);

    return CalendarMonthResult(
      year: year,
      month: month,
      dayStats: dayStats,
    );
  }

  /// 获取指定日期的任务列表
  Future<List<ReviewTaskEntity>> executeByDate(DateTime date) async {
    return await _reviewTaskRepo.getTasksByDate(date);
  }
}
```

#### GetStatisticsUseCase (F7)

```dart
/// 获取学习统计用例
/// 用于统计面板的数据展示
class GetStatisticsUseCase {
  final ReviewTaskRepository _reviewTaskRepo;
  final LearningItemRepository _learningItemRepo;

  Future<StatisticsResult> execute() async {
    final now = DateTime.now();

    // 1. 连续打卡天数
    final consecutiveDays = await _reviewTaskRepo.getConsecutiveCompletedDays();

    // 2. 本周完成率（[start, end) 半开区间）
    final weekStart = DateTime(now.year, now.month, now.day).subtract(Duration(days: now.weekday - 1));
    final weekEnd = weekStart.add(const Duration(days: 7));
    final weekStats = await _reviewTaskRepo.getTaskStatsInRange(
      weekStart,
      weekEnd,
    );

    // 3. 本月完成率
    final monthStart = DateTime(now.year, now.month, 1);
    final monthEnd = DateTime(now.year, now.month + 1, 1);
    final monthStats = await _reviewTaskRepo.getTaskStatsInRange(
      monthStart,
      monthEnd,
    );

    // 4. 标签分布
    final tagDistribution = await _learningItemRepo.getTagDistribution();

    return StatisticsResult(
      consecutiveDays: consecutiveDays,
      weekCompleted: weekStats.completed,
      weekTotal: weekStats.total,
      monthCompleted: monthStats.completed,
      monthTotal: monthStats.total,
      tagDistribution: tagDistribution,
    );
  }
}
```

##### 连续打卡算法伪代码

```dart
/// 获取连续打卡天数
///
/// 规则：
/// 1. 从今天往前计算
/// 2. 每天至少完成 1 条任务算打卡成功
/// 3. 跳过(skip)的任务不算断签，也不算完成
/// 4. 某天如果没有任务，不中断打卡链
///
/// 示例：
/// - 今天完成、昨天完成、前天跳过、大前天完成 = 连续 3 天
/// - 今天完成、昨天无任务、前天完成 = 连续 2 天
Future<int> getConsecutiveCompletedDays() async {
  int consecutiveDays = 0;
  DateTime currentDate = DateTime.now();

  while (true) {
    final dayStart = DateTime(currentDate.year, currentDate.month, currentDate.day);
    final dayEnd = dayStart.add(const Duration(days: 1));

    // 查询该天的已完成任务
    final tasks = await reviewTaskRepo.getTasksInRange(dayStart, dayEnd);
    final doneTasks = tasks.where((t) => t.status == ReviewTaskStatus.done).toList();

    if (doneTasks.isNotEmpty) {
      consecutiveDays++;
    }
    // else: 无任务，不中断，继续往前

    currentDate = currentDate.subtract(const Duration(days: 1));

    // 最多查一年，防止无限循环
    if (consecutiveDays >= 365) break;
  }

  return consecutiveDays;
}
```

##### 完成率计算公式

```
完成率 = 已完成任务数 / (已完成任务数 + 待复习任务数)
       = done / (done + pending)

注：跳过的任务 (skipped) 不参与计算
```

#### ExportDataUseCase (F8)

```dart
/// 数据导出用例
/// 支持 JSON 和 CSV 格式
class ExportDataUseCase {
  final LearningItemRepository _learningItemRepo;
  final ReviewTaskRepository _reviewTaskRepo;

  /// 导出参数
  final ExportParams params;

  /// 执行导出
  Future<ExportResult> execute() async {
    // 1. 收集数据
    final exportData = await _collectData();

    // 2. 根据格式序列化
    final content = params.format == ExportFormat.json
        ? _toJson(exportData)
        : _toCsv(exportData);

    // 3. 写入文件
    final file = await _saveToFile(
      content,
      params.format,
    );

    return ExportResult(
      file: file,
      recordCount: exportData.totalCount,
    );
  }

  /// 收集导出数据
  Future<ExportData> _collectData() async {
    final items = params.includeItems
        ? await _learningItemRepo.getAll()
        : [];

    final tasks = params.includeTasks
        ? await _reviewTaskRepo.getAllTasks()
        : [];

    return ExportData(
      items: items,
      tasks: tasks,
      exportedAt: DateTime.now(),
    );
  }

  /// 序列化为 JSON
  String _toJson(ExportData data) {
    return jsonEncode({
      'version': '2.0',
      'exportedAt': data.exportedAt.toIso8601String(),
      'items': data.items.map((i) => i.toJson()).toList(),
      'tasks': data.tasks.map((t) => t.toJson()).toList(),
    });
  }

  /// 序列化为 CSV
  String _toCsv(ExportData data) {
    final buffer = StringBuffer();

    // 学习内容表头
    if (data.items.isNotEmpty && params.includeItems) {
      buffer.writeln('学习内容');
      buffer.writeln('ID,标题,备注,标签,学习日期,创建时间');
      for (final item in data.items) {
        buffer.writeln('${item.id},"${item.title}","${item.note ?? ''}","${item.tags.join(',')}",${item.learningDate.toIso8601String()},${item.createdAt?.toIso8601String() ?? ""}');
      }
      buffer.writeln();
    }

    // 复习任务表头
    if (data.tasks.isNotEmpty && params.includeTasks) {
      buffer.writeln('复习任务');
      buffer.writeln('ID,学习内容ID,复习轮次,计划日期,状态,完成时间');
      for (final task in data.tasks) {
        buffer.writeln('${task.id},${task.learningItemId},${task.reviewRound},${task.scheduledDate.toIso8601String()},${task.status},${task.completedAt?.toIso8601String() ?? ""}');
      }
    }

    return buffer.toString();
  }

  /// 保存到文件
  Future<File> _saveToFile(String content, ExportFormat format) async {
    final dir = await getApplicationDocumentsDirectory();
    final timestamp = DateTime.now().toIso8601String().replaceAll(':', '-');
    final ext = format == ExportFormat.json ? 'json' : 'csv';
    final file = File('${dir.path}/yike_export_$timestamp.$ext');
    await file.writeAsString(content);
    return file;
  }
}

/// 导出参数
class ExportParams {
  final ExportFormat format;      // JSON / CSV
  final bool includeItems;         // 包含学习内容
  final bool includeTasks;         // 包含复习任务
}

/// 导出格式
enum ExportFormat { json, csv }

/// 导出结果
class ExportResult {
  final File file;
  final int recordCount;
}
```

---

## 4. 状态管理 (Riverpod)

### 4.1 新增 Provider

#### CalendarProvider

```dart
/// 日历视图状态
class CalendarState {
  final int selectedYear;
  final int selectedMonth;
  final DateTime? selectedDate;
  final Map<DateTime, TaskDayStats> monthStats;
  final List<ReviewTaskEntity> selectedDateTasks;
  final bool isLoading;
  final String? errorMessage;
}

/// 日历 Provider
final calendarProvider = StateNotifierProvider<CalendarNotifier, CalendarState> {
  (ref) => CalendarNotifier(ref.read(getCalendarTasksUseCase)),
};

class CalendarNotifier extends StateNotifier<CalendarState> {
  final GetCalendarTasksUseCase _getCalendarTasksUseCase;

  CalendarNotifier(this._getCalendarTasksUseCase)
      : super(CalendarState(
          selectedYear: DateTime.now().year,
          selectedMonth: DateTime.now().month,
        ));

  /// 加载月份数据
  Future<void> loadMonth(int year, int month) async {
    state = state.copyWith(isLoading: true);
    try {
      final result = await _getCalendarTasksUseCase.execute(
        year: year,
        month: month,
      );
      state = state.copyWith(
        monthStats: result.dayStats,
        isLoading: false,
      );
    } catch (e) {
      state = state.copyWith(
        errorMessage: e.toString(),
        isLoading: false,
      );
    }
  }

  /// 选择日期
  Future<void> selectDate(DateTime date) async {
    state = state.copyWith(selectedDate: date);
    // 加载该日期的任务
    final tasks = await _getCalendarTasksUseCase.executeByDate(date);
    state = state.copyWith(selectedDateTasks: tasks);
  }

  /// 切换月份
  void changeMonth(int delta) {
    var newMonth = state.selectedMonth + delta;
    var newYear = state.selectedYear;

    if (newMonth > 12) {
      newMonth = 1;
      newYear++;
    } else if (newMonth < 1) {
      newMonth = 12;
      newYear--;
    }

    state = state.copyWith(
      selectedMonth: newMonth,
      selectedYear: newYear,
    );
    loadMonth(newYear, newMonth);
  }
}
```

#### StatisticsProvider

```dart
/// 统计面板状态
class StatisticsState {
  final int consecutiveDays;
  final double weekCompletionRate;
  final double monthCompletionRate;
  final Map<String, int> tagDistribution;
  final bool isLoading;
  final String? errorMessage;
}

/// 统计 Provider
final statisticsProvider = StateNotifierProvider<StatisticsNotifier, StatisticsState> {
  (ref) => StatisticsNotifier(ref.read(getStatisticsUseCase)),
};

class StatisticsNotifier extends StateNotifier<StatisticsState> {
  final GetStatisticsUseCase _getStatisticsUseCase;

  StatisticsNotifier(this._getStatisticsUseCase)
      : super(StatisticsState());

  /// 加载统计数据
  Future<void> load() async {
    state = state.copyWith(isLoading: true);
    try {
      final result = await _getStatisticsUseCase.execute();
      state = state.copyWith(
        consecutiveDays: result.consecutiveDays,
        weekCompletionRate: result.weekTotal > 0
            ? result.weekCompleted / result.weekTotal
            : 0.0,
        monthCompletionRate: result.monthTotal > 0
            ? result.monthCompleted / result.monthTotal
            : 0.0,
        tagDistribution: result.tagDistribution,
        isLoading: false,
      );
    } catch (e) {
      state = state.copyWith(
        errorMessage: e.toString(),
        isLoading: false,
      );
    }
  }
}
```

---

## 5. 路由设计 (GoRouter)

### 5.1 路由结构更新

**决策**：沿用现有 `ShellRoute` 方案，扩展到 4 个 Tab。

```dart
final appRouter = GoRouter(
  initialLocation: '/home',
  routes: [
    // 底部导航（4个 Tab）
    ShellRoute(
      builder: (context, state, child) {
        return ShellScaffold(child: child);
      },
      routes: [
        // 首页 - 今日任务
        GoRoute(
          path: '/home',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: HomePage(),
          ),
        ),
        // 日历视图 (F6)
        GoRoute(
          path: '/calendar',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: CalendarPage(),
          ),
        ),
        // 学习统计 (F7)
        GoRoute(
          path: '/statistics',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: StatisticsPage(),
          ),
        ),
        // 设置
        GoRoute(
          path: '/settings',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: SettingsPage(),
          ),
        ),
      ],
    ),
    // 录入页面（Modal）
    GoRoute(
      path: '/input',
      pageBuilder: (context, state) => CustomTransitionPage(
        child: const InputPage(),
        transitionsBuilder: _slideUpTransition,
      ),
    ),
    // 数据导出页面（Modal）(F8)
    GoRoute(
      path: '/settings/export',
      pageBuilder: (context, state) => CustomTransitionPage(
        child: const ExportPage(),
        transitionsBuilder: _slideUpTransition,
      ),
    ),
  ],
);
```

> **注意**：现有代码使用 `ShellRoute` + `ShellScaffold`（见 `lib/infrastructure/router/app_router.dart`），本设计保持一致，仅扩展 `destinations` 数量。

### 5.2 路由参数

| 路由 | 参数 | 说明 |
|------|------|------|
| `/home` | - | 今日任务首页 |
| `/calendar` | - | 日历视图 |
| `/statistics` | - | 学习统计 |
| `/settings` | - | 设置页 |
| `/settings/export` | - | 数据导出（Modal） |
| `/input` | - | 录入页面（Modal） |
      path: '/input',
      pageBuilder: (context, state) => CustomTransitionPage(
        child: const InputPage(),
        transitionsBuilder: _slideUpTransition,
      ),
    ),
    // 数据导出页面（Modal）(F8)
    GoRoute(
      path: '/settings/export',
      pageBuilder: (context, state) => CustomTransitionPage(
        child: const ExportPage(),
        transitionsBuilder: _slideUpTransition,
      ),
    ),
  ],
);
```

---

## 6. 页面设计

### 6.1 日历视图 (CalendarPage)

**技术要点：**
- 使用 `table_calendar` 包
- 自定义日历单元格渲染（显示任务状态圆点）
- 点击日期更新底部任务列表

```dart
/// 日历视图页面
class CalendarPage extends ConsumerWidget {
  const CalendarPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final state = ref.watch(calendarProvider);
    final notifier = ref.read(calendarProvider.notifier);

    return Scaffold(
      appBar: AppBar(
        title: const Text('日历'),
      ),
      body: Column(
        children: [
          // 日历组件
          TableCalendar(
            firstDay: DateTime(2020),
            lastDay: DateTime(2030),
            focusedDay: DateTime(state.selectedYear, state.selectedMonth),
            onPageChanged: (focusedDay) {
              notifier.loadMonth(focusedDay.year, focusedDay.month);
            },
            onDaySelected: (selectedDay, focusedDay) {
              notifier.selectDate(selectedDay);
            },
            calendarBuilders: CalendarBuilders(
              markerBuilder: (context, date, events) {
                // 显示任务状态圆点
                final stats = state.monthStats[DateTime(date.year, date.month, date.day)];
                if (stats == null || stats.total == 0) return null;
                return _buildTaskMarker(stats);
              },
            ),
          ),
          const Divider(),
          // 选中日期的任务列表
          Expanded(
            child: _TaskList(tasks: state.selectedDateTasks),
          ),
        ],
      ),
    );
  }

  Widget _buildTaskMarker(TaskDayStats stats) {
    Color color;
    if (stats.done == stats.total) {
      color = const Color(0xFF22C55E); // 全部完成 - 绿色
    } else if (stats.pending > 0) {
      final now = DateTime.now();
      final dateStats = DateTime(now.year, now.month, now.day);
      if (dateStats.isAfter(DateTime(stats...))) {
        color = const Color(0xFFF59E0B); // 逾期 - 黄色
      } else {
        color = const Color(0xFF0D9488); // 待复习 - 蓝色
      }
    } else {
      color = const Color(0xFF22C55E); // 跳过也算完成
    }
    return Positioned(
      bottom: 1,
      child: Container(
        width: 6,
        height: 6,
        decoration: BoxDecoration(
          color: color,
          shape: BoxShape.circle,
        ),
      ),
    );
  }
}
```

### 6.2 统计面板 (StatisticsPage)

**技术要点：**
- 使用 `fl_chart` 绘制饼图
- 环形进度使用 `PieChart` 实现
- 页面加载时调用 `statisticsProvider.load()`

```dart
/// 统计面板页面
class StatisticsPage extends ConsumerWidget {
  const StatisticsPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final state = ref.watch(statisticsProvider);

    if (state.isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    return Scaffold(
      appBar: AppBar(
        title: const Text('学习统计'),
      ),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // 连续打卡卡片
          _StreakCard(days: state.consecutiveDays),
          const SizedBox(height: 16),
          // 完成率卡片
          Row(
            children: [
              Expanded(
                child: _CompletionCard(
                  title: '本周',
                  rate: state.weekCompletionRate,
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: _CompletionCard(
                  title: '本月',
                  rate: state.monthCompletionRate,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          // 标签分布饼图
          _TagPieChart(distribution: state.tagDistribution),
        ],
      ),
    );
  }
}
```

### 6.3 数据导出页面 (ExportPage)

**技术要点：**
- 使用 `share_plus` 分享文件
- 先导出到临时文件，再调用系统分享
- 支持 JSON/CSV 格式选择

```dart
/// 数据导出页面
class ExportPage extends ConsumerStatefulWidget {
  const ExportPage({super.key});

  @override
  ConsumerState<ExportPage> createState() => _ExportPageState();
}

class _ExportPageState extends ConsumerState<ExportPage> {
  ExportFormat _format = ExportFormat.json;
  bool _includeItems = true;
  bool _includeTasks = true;
  bool _isExporting = false;

  Future<void> _doExport() async {
    setState(() => _isExporting = true);

    try {
      final params = ExportParams(
        format: _format,
        includeItems: _includeItems,
        includeTasks: _includeTasks,
      );

      final result = await ref.read(exportDataUseCaseProvider).execute(params);

      // 分享文件
      await Share.shareXFiles(
        [XFile(result.file.path)],
        text: '忆刻数据导出',
      );

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('导出成功，共 ${result.recordCount} 条记录')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('导出失败: $e')),
        );
      }
    } finally {
      setState(() => _isExporting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('数据导出'),
      ),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // 格式选择
          _SectionTitle('导出格式'),
          RadioListTile<ExportFormat>(
            title: const Text('JSON'),
            subtitle: const Text('完整数据，含所有字段'),
            value: ExportFormat.json,
            groupValue: _format,
            onChanged: (v) => setState(() => _format = v!),
          ),
          RadioListTile<ExportFormat>(
            title: const Text('CSV'),
            subtitle: const Text('表格数据，通用格式'),
            value: ExportFormat.csv,
            groupValue: _format,
            onChanged: (v) => setState(() => _format = v!),
          ),
          const SizedBox(height: 16),
          // 内容选择
          _SectionTitle('导出内容'),
          CheckboxListTile(
            title: const Text('学习内容'),
            value: _includeItems,
            onChanged: (v) => setState(() => _includeItems = v!),
          ),
          CheckboxListTile(
            title: const Text('复习任务'),
            value: _includeTasks,
            onChanged: (v) => setState(() => _includeTasks = v!),
          ),
          const SizedBox(height: 24),
          // 导出按钮
          FilledButton(
            onPressed: _isExporting ? null : _doExport,
            child: _isExporting
                ? const SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(strokeWidth: 2),
                  )
                : const Text('导出数据'),
          ),
        ],
      ),
    );
  }
}
```

---

## 7. 依赖配置

### 7.1 pubspec.yaml 新增依赖

```yaml
dependencies:
  flutter:
    sdk: flutter

  # 新增依赖
  table_calendar: ^3.0.0    # 日历组件
  fl_chart: ^0.66.0        # 图表组件
  share_plus: ^7.0.0       # 系统分享
```

---

## 8. 错误处理

### 8.1 新增异常类型

| 异常类型 | 说明 | 处理方式 |
|----------|------|----------|
| `ExportException` | 数据导出失败 | 显示错误提示，提供重试 |
| `CalendarException` | 日历数据加载失败 | 显示错误提示，底部导航 |

---

## 9. 性能优化

### 9.1 日历视图优化

- 月份切换时懒加载数据
- 使用 `const` 构造 Calendar builders
- 任务列表使用 `ListView.builder`

### 9.2 统计页面优化

- 统计数据缓存在 Provider 中
- 标签数据量小，可一次性加载

---

## 10. 测试策略

### 10.1 单元测试

- `GetCalendarTasksUseCase` 逻辑测试
- `GetStatisticsUseCase` 连续打卡计算测试
- `ExportDataUseCase` JSON/CSV 序列化测试

### 10.2 Widget 测试

- 日历组件渲染测试
- 饼图数据绑定测试
- 导出页面交互测试

---

*文档版本：v2.0*
*创建日期：2026-02-25*
*基于 Clean Architecture + Riverpod + Drift*
