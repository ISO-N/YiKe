# 忆刻 (YiKe) — 技术设计文档 (TDD)

## 文档信息

| 项目 | 忆刻 (YiKe) |
|------|-------------|
| 版本 | v1.0 |
| 类型 | 技术设计文档 |
| 创建日期 | 2025-02-25 |
| 技术栈 | Flutter |

---

## 0. PRD 功能点覆盖矩阵

> **版本范围声明**：本文档对应 PRD v1.0 MVP 版本，以下矩阵明确本版本**做**与**不做**的功能点，避免开发范围误解。

### 0.1 功能需求覆盖

| PRD 编号 | 功能描述 | MVP 范围 | 技术实现要点 |
|----------|----------|----------|--------------|
| **F1** | 学习内容录入 | ✅ **做** | 标题（必填）+ 备注（纯文本 v1.0）+ 标签 |
| **F2** | 艾宾浩斯复习计划自动生成 | ✅ **做** | 默认间隔 [1,2,4,7,15]，固定使用默认值 |
| **F3** | 复习任务勾选完成 | ✅ **做** | 完成/跳过状态、批量操作、逾期识别 |
| **F4** | 通知提醒 | ⚠️ **降级** | 每日固定时间提醒（09:00），允许 ±30 分钟误差 |
| **F5** | 桌面小组件（Widget） | ✅ **v1.0 仅 Android** | 2×2/4×2 展示，**仅展示不交互**（点击打开 App） |
| **F6** | 日历视图 | ❌ **不做**（v1.1 规划） | 月历 + 任务列表，颜色区分状态 |
| **F7** | 学习统计 | ❌ **不做** | v2.0 规划 |
| **F8** | 数据导出与备份 | ❌ **不做** | v2.0 规划 |

### 0.2 非功能需求覆盖

| 类别 | 需求 | MVP 范围 |
|------|------|----------|
| 性能 | 冷启动 ≤ 2s | ✅ 目标一致 |
| 存储 | SQLite 本地存储 | ✅ 目标一致 |
| 兼容性 | Android 8.0+ / iOS 14+ | ✅ 目标一致 |
| 离线 | 核心功能离线可用 | ✅ 目标一致 |
| 安全 | 本地数据加密存储 | ⚠️ **降级**：仅加密设置项，任务数据不加密 |
| 自定义复习间隔 | 设置中可自定义 | ❌ **不做**：v2.0 规划 |

### 0.3 与 PRD 不一致说明

| 差异点 | PRD 描述 | TDD 实现 | 说明 |
|--------|----------|----------|------|
| 备注附件 | 支持富文本/图片 | 纯文本 | v1.0 MVP 降级 |
| 小组件交互 | 支持直接勾选 | 仅展示 | v1.0 MVP 降级 |
| 通知准时性 | "按时提醒" | 允许 ±30 分钟 | 受系统后台策略限制 |
| 统计面板 | PRD 信息架构包含 | 无对应路由/页面 | v2.0 规划 |

---

## 1. 技术架构

### 1.1 整体架构

采用 **Clean Architecture** 分层架构，确保代码可维护、可测试、可扩展。

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                   │
│  (Pages, Widgets, ViewModels / Controllers, States)    │
├─────────────────────────────────────────────────────────┤
│                      Domain Layer                        │
│  (Entities, Use Cases, Repository Interfaces)            │
├─────────────────────────────────────────────────────────┤
│                       Data Layer                         │
│  (Repository Implementations, Data Sources, Models)     │
├─────────────────────────────────────────────────────────┤
│                    Infrastructure                         │
│  (Database, Notifications, Widget, Platform Services)    │
└─────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

| 类别 | 技术方案 | 版本/说明 |
|------|----------|-----------|
| **跨端框架** | Flutter | SDK ^3.11.0 |
| **状态管理** | Riverpod | flutter_riverpod ^2.5.1 |
| **本地数据库** | Drift (SQLite) | drift ^2.16.0 |
| **路由管理** | GoRouter | go_router ^14.0.0 |
| **日期处理** | intl | intl ^0.19.0 |
| **本地通知** | flutter_local_notifications | ^17.0.0 |
| **桌面小组件** | home_widget | ^0.6.0 |
| **加密存储** | flutter_secure_storage | ^9.0.0 |
| **文件处理** | path_provider | ^2.1.2 |
| **UUID 生成** | uuid | ^4.3.3 |
| **权限处理** | permission_handler | ^11.3.0 |

---

## 2. 目录结构

```
lib/
├── main.dart                         # 应用入口
├── app.dart                          # App 根组件
│
├── core/                             # 核心模块
│   ├── constants/
│   │   ├── app_colors.dart           # 颜色常量
│   │   ├── app_typography.dart       # 字体样式
│   │   ├── app_spacing.dart          # 间距常量
│   │   └── app_strings.dart          # 字符串常量
│   ├── theme/
│   │   └── app_theme.dart            # 应用主题
│   ├── utils/
│   │   ├── date_utils.dart           # 日期工具函数
│   │   └── ebbinghaus_utils.dart     # 艾宾浩斯曲线计算
│   └── extensions/
│       └── context_extensions.dart   # BuildContext 扩展
│
├── data/                             # 数据层
│   ├── database/
│   │   ├── database.dart             # Drift 数据库定义
│   │   ├── database.g.dart            # 生成的代码
│   │   ├── tables/
│   │   │   ├── learning_items_table.dart
│   │   │   ├── review_tasks_table.dart
│   │   │   └── settings_table.dart
│   │   └── daos/
│   │       ├── learning_item_dao.dart
│   │       ├── review_task_dao.dart
│   │       └── settings_dao.dart
│   ├── repositories/
│   │   ├── learning_item_repository_impl.dart
│   │   ├── review_task_repository_impl.dart
│   │   └── settings_repository_impl.dart
│   └── models/
│       └── review_config_model.dart
│
├── domain/                           # 领域层
│   ├── entities/
│   │   ├── learning_item.dart        # 学习内容实体
│   │   ├── review_task.dart          # 复习任务实体
│   │   ├── review_config.dart        # 复习配置实体
│   │   └── app_settings.dart         # 应用设置实体
│   ├── repositories/
│   │   ├── learning_item_repository.dart
│   │   ├── review_task_repository.dart
│   │   └── settings_repository.dart
│   └── usecases/
│       ├── create_learning_item_usecase.dart
│       ├── get_today_tasks_usecase.dart
│       ├── complete_review_task_usecase.dart
│       └── generate_review_plan_usecase.dart
│
├── presentation/                      # 展示层
│   ├── providers/
│   │   ├── learning_item_provider.dart
│   │   ├── review_task_provider.dart
│   │   ├── settings_provider.dart
│   │   └── navigation_provider.dart
│   ├── pages/
│   │   ├── home/
│   │   │   ├── home_page.dart
│   │   │   └── widgets/
│   │   │       ├── date_header.dart
│   │   │       ├── progress_card.dart
│   │   │       ├── task_list.dart
│   │   │       ├── task_card.dart
│   │   │       └── floating_action_button.dart
│   │   ├── input/
│   │   │   ├── input_page.dart
│   │   │   └── widgets/
│   │   │       ├── title_input.dart
│   │   │       ├── note_input.dart
│   │   │       └── tag_selector.dart
│   │   ├── calendar/                        # [v1.1] 日历视图
│   │   │   ├── calendar_page.dart          # [v1.1]
│   │   │   └── widgets/
│   │   │       ├── calendar_grid.dart      # [v1.1]
│   │   │       └── day_task_list.dart      # [v1.1]
│   │   └── settings/
│   │       ├── settings_page.dart
│   │       └── widgets/
│   │           ├── settings_tile.dart
│   │           └── time_picker_dialog.dart
│   └── widgets/
│       ├── glass_card.dart           # 毛玻璃卡片组件
│       ├── custom_button.dart        # 自定义按钮
│       ├── custom_checkbox.dart      # 自定义复选框
│       ├── tag_chip.dart             # 标签组件
│       └── loading_indicator.dart    # 加载指示器
│
├── infrastructure/                   # 基础设施层
│   ├── notification/
│   │   └── notification_service.dart # 通知服务
│   ├── widget/
│   │   └── widget_service.dart      # 桌面小组件服务
│   ├── storage/
│   │   └── secure_storage_service.dart
│   └── router/
│       └── app_router.dart           # 路由配置
│
└── di/                              # 依赖注入
    └── injection.dart               # Provider/Inject 配置
```

---

## 3. 数据库详细设计

### 3.1 数据库概览

使用 **Drift** (原 Moor) 作为 SQLite ORM，支持：
- 类型安全的 SQL 查询
- 自动生成 DAO
- 响应式数据流
- 数据库迁移

**数据库文件：** `yike.db`

### 3.2 表结构

#### 3.2.1 学习内容表 (learning_items)

```dart
/// 学习内容表
/// 存储用户录入的每条学习内容
class LearningItems extends Table {
  // 主键 ID
  IntColumn get id => integer().autoIncrement()();

  // 学习内容标题（必填，≤50字）
  TextColumn get title => text().withLength(min: 1, max: 50)();

  // 备注内容（可选，支持富文本/图片路径）
  TextColumn get note => text().nullable()();

  // 标签列表（JSON 格式存储，如 ["Java", "Spring"]）
  TextColumn get tags => text().withDefault(const Constant('[]'))();

  // 学习日期（首次录入日期）
  DateTimeColumn get learningDate => dateTime()();

  // 创建时间
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();

  // 更新时间
  DateTimeColumn get updatedAt => dateTime().nullable()();
}
```

**索引：**
- `idx_learning_date` on `learningDate` — 查询特定日期的学习内容

#### 3.2.2 复习任务表 (review_tasks)

```dart
/// 复习任务表
/// 存储每条学习内容对应的复习计划任务
class ReviewTasks extends Table {
  // 主键 ID
  IntColumn get id => integer().autoIncrement()();

  // 外键：关联的学习内容 ID
  IntColumn get learningItemId => integer().references(LearningItems, #id)();

  // 复习轮次（1-5）
  IntColumn get reviewRound => integer().check(reviewRound.isBetweenValues(1, 5))();

  // 计划复习日期
  DateTimeColumn get scheduledDate => dateTime()();

  // 任务状态：pending(待复习)/done(已完成)/skipped(已跳过)
  TextColumn get status => text().withDefault(const Constant('pending'))();

  // 完成时间（任务完成后记录）
  DateTimeColumn get completedAt => dateTime().nullable()();

  // 跳过时间
  DateTimeColumn get skippedAt => dateTime().nullable()();

  // 创建时间
  DateTimeColumn get createdAt => dateTime().withDefault(currentDateAndTime)();
}
```

**索引：**
- `idx_scheduled_date` on `scheduledDate` — 查询特定日期的复习任务
- `idx_status` on `status` — 查询特定状态的任务
- `idx_learning_item_id` on `learningItemId` — 关联查询

#### 3.2.3 应用设置表 (app_settings)

```dart
/// 应用设置表
/// 存储用户的应用配置
class AppSettings extends Table {
  // 主键 ID
  IntColumn get id => integer().autoIncrement()();

  // 设置键名
  TextColumn get key => text().unique()();

  // 设置值（JSON 格式）
  TextColumn get value => text()();

  // 更新时间
  DateTimeColumn get updatedAt => dateTime().withDefault(currentDateAndTime)();
}
```

**预设设置项：**

| key | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `reminder_time` | String | "09:00" | 每日提醒时间 |
| `do_not_disturb_start` | String | "22:00" | 免打扰开始时间 |
| `do_not_disturb_end` | String | "08:00" | 免打扰结束时间 |
| `custom_intervals` | JSON | null | 自定义复习间隔（覆盖默认） |
| `notifications_enabled` | Boolean | true | 通知开关 |

### 3.3 复习配置

**默认复习间隔（艾宾浩斯曲线）：**

```dart
/// 复习间隔配置
/// 基于首次学习后的天数
class ReviewConfig {
  static const List<int> defaultIntervals = [1, 2, 4, 7, 15];

  /// 计算第 N 次复习的日期
  static DateTime calculateReviewDate(DateTime learningDate, int round) {
    final interval = defaultIntervals[round - 1];
    return learningDate.add(Duration(days: interval));
  }
}
```

### 3.4 DAO 层设计

#### LearningItemDao

```dart
/// 学习内容数据访问对象
abstract class LearningItemDao {
  /// 插入学习内容
  Future<int> insertLearningItem(LearningItem item);

  /// 更新学习内容
  Future<bool> updateLearningItem(LearningItem item);

  /// 删除学习内容（级联删除关联的复习任务）
  Future<int> deleteLearningItem(int id);

  /// 根据 ID 查询学习内容
  Future<LearningItem?> getLearningItemById(int id);

  /// 查询所有学习内容
  Future<List<LearningItem>> getAllLearningItems();

  /// 根据日期查询学习内容
  Future<List<LearningItem>> getLearningItemsByDate(DateTime date);

  /// 根据标签查询学习内容
  Future<List<LearningItem>> getLearningItemsByTag(String tag);

  /// 获取所有标签
  Future<List<String>> getAllTags();
}
```

#### ReviewTaskDao

```dart
/// 复习任务数据访问对象
abstract class ReviewTaskDao {
  /// 插入复习任务
  Future<int> insertReviewTask(ReviewTask task);

  /// 批量插入复习任务
  Future<void> insertReviewTasks(List<ReviewTask> tasks);

  /// 更新复习任务
  Future<bool> updateReviewTask(ReviewTask task);

  /// 更新任务状态
  Future<int> updateTaskStatus(int id, String status, {DateTime? completedAt});

  /// 根据 ID 查询复习任务
  Future<ReviewTask?> getReviewTaskById(int id);

  /// 查询指定日期的所有复习任务
  Future<List<ReviewTask>> getTasksByDate(DateTime date);

  /// 查询今日待复习任务（状态为 pending）
  Future<List<ReviewTask>> getTodayPendingTasks();

  /// 查询逾期任务（状态为 pending 且日期 < 今日）
  Future<List<ReviewTask>> getOverdueTasks();

  /// 查询学习内容关联的所有复习任务
  Future<List<ReviewTask>> getTasksByLearningItemId(int learningItemId);

  /// 统计指定日期任务完成情况
  Future<(int completed, int total)> getTaskStats(DateTime date);

  /// 删除学习内容关联的复习任务
  Future<int> deleteTasksByLearningItemId(int learningItemId);
}
```

---

## 4. 领域层设计

### 4.1 实体类

#### LearningItem 实体

```dart
/// 学习内容实体
/// 领域层核心实体之一
class LearningItemEntity {
  final int? id;
  final String title;
  final String? note;
  final List<String> tags;
  final DateTime learningDate;
  final DateTime? createdAt;
  final DateTime? updatedAt;

  // 关联的复习任务（用于展示）
  final List<ReviewTaskEntity>? reviewTasks;

  LearningItemEntity({
    this.id,
    required this.title,
    this.note,
    this.tags = const [],
    required this.learningDate,
    this.createdAt,
    this.updatedAt,
    this.reviewTasks,
  });

  LearningItemEntity copyWith({...});
}
```

#### ReviewTask 实体

```dart
/// 复习任务实体
class ReviewTaskEntity {
  final int? id;
  final int learningItemId;
  final int reviewRound;
  final DateTime scheduledDate;
  final ReviewTaskStatus status;
  final DateTime? completedAt;
  final DateTime? skippedAt;
  final DateTime? createdAt;

  // 关联的学习内容（用于展示）
  final LearningItemEntity? learningItem;

  // 便捷属性
  bool get isOverdue =>
      status == ReviewTaskStatus.pending &&
      scheduledDate.isBefore(DateTime.now());

  int get daysUntilDue => scheduledDate.difference(DateTime.now()).inDays;
}
```

#### ReviewTaskStatus 枚举

```dart
/// 复习任务状态
enum ReviewTaskStatus {
  pending,   // 待复习
  done,      // 已完成
  skipped,   // 已跳过
}
```

### 4.2 Repository 接口

```dart
/// 学习内容仓储接口
abstract class LearningItemRepository {
  Future<LearningItemEntity> create(LearningItemEntity item);
  Future<LearningItemEntity> update(LearningItemEntity item);
  Future<void> delete(int id);
  Future<LearningItemEntity?> getById(int id);
  Future<List<LearningItemEntity>> getAll();
  Future<List<LearningItemEntity>> getByDate(DateTime date);
  Future<List<LearningItemEntity>> getByTag(String tag);
  Future<List<String>> getAllTags();
}
```

```dart
/// 复习任务仓储接口
abstract class ReviewTaskRepository {
  Future<ReviewTaskEntity> create(ReviewTaskEntity task);
  Future<List<ReviewTaskEntity>> createBatch(List<ReviewTaskEntity> tasks);
  Future<ReviewTaskEntity> update(ReviewTaskEntity task);
  Future<void> completeTask(int id);
  Future<void> skipTask(int id);
  Future<ReviewTaskEntity?> getById(int id);
  Future<List<ReviewTaskEntity>> getByDate(DateTime date);
  Future<List<ReviewTaskEntity>> getTodayTasks();
  Future<List<ReviewTaskEntity>> getOverdueTasks();
  Future<List<ReviewTaskEntity>> getByLearningItemId(int learningItemId);
  Future<(int completed, int total)> getTaskStats(DateTime date);
}
```

### 4.3 UseCase 业务逻辑

#### CreateLearningItemUseCase

```dart
/// 创建学习内容用例
/// 1. 保存学习内容到数据库
/// 2. 自动生成复习计划（5次复习任务）
class CreateLearningItemUseCase {
  final LearningItemRepository _learningItemRepo;
  final ReviewTaskRepository _reviewTaskRepo;

  Future<LearningItemEntity> execute(CreateLearningItemParams params) async {
    // 1. 创建学习内容
    final learningItem = LearningItemEntity(
      title: params.title,
      note: params.note,
      tags: params.tags,
      learningDate: params.learningDate ?? DateTime.now(),
    );
    final savedItem = await _learningItemRepo.create(learningItem);

    // 2. 自动生成复习计划
    final reviewTasks = _generateReviewPlan(savedItem);
    await _reviewTaskRepo.createBatch(reviewTasks);

    // 3. 刷新小组件数据
    await WidgetService.updateWidgetData();

    // 4. 调度通知
    await NotificationService.scheduleReviewNotifications(reviewTasks);

    return savedItem;
  }

  /// 生成复习计划
  ///
  /// [NOTE] v1.0 MVP：固定使用默认间隔 [1, 2, 4, 7, 15] 天
  /// 自定义复习间隔在 v2.0 实现
  List<ReviewTaskEntity> _generateReviewPlan(LearningItemEntity item) {
    final config = ReviewConfig.defaultIntervals;
    return List.generate(5, (index) {
      final interval = config[index];
      return ReviewTaskEntity(
        learningItemId: item.id!,
        reviewRound: index + 1,
        scheduledDate: item.learningDate.add(Duration(days: interval)),
        status: ReviewTaskStatus.pending,
      );
    });
  }
}

/// [v2.0] 自定义复习间隔用例（暂不实现）
///
/// ```dart
/// class CreateCustomReviewPlanUseCase {
///   Future<List<ReviewTaskEntity>> execute({
///     required LearningItemEntity item,
///     required List<int> customIntervals,
///   }) async {
///     // 1. 校验间隔有效性
///     // 2. 读取用户自定义配置
///     // 3. 生成自定义复习计划
///   }
/// }
/// ```
}
```

#### CompleteReviewTaskUseCase

```dart
/// 完成复习任务用例
class CompleteReviewTaskUseCase {
  final ReviewTaskRepository _reviewTaskRepo;

  Future<void> execute(int taskId) async {
    await _reviewTaskRepo.completeTask(taskId);

    // 更新小组件数据
    await WidgetService.updateWidgetData();
  }
}
```

#### GetTodayTasksUseCase

```dart
/// 获取今日任务用例
class GetTodayTasksUseCase {
  final ReviewTaskRepository _reviewTaskRepo;

  Future<TodayTasksResult> execute() async {
    final today = DateTime.now();
    final todayStart = DateTime(today.year, today.month, today.day);
    final todayEnd = todayStart.add(const Duration(days: 1));

    // 今日任务 = 今日待复习 + 逾期任务
    final todayTasks = await _reviewTaskRepo.getByDate(today);
    final overdueTasks = await _reviewTaskRepo.getOverdueTasks();

    // 合并并按状态排序（逾期优先）
    final allTasks = [...overdueTasks, ...todayTasks];
    allTasks.sort((a, b) {
      // 逾期在前，同状态按复习轮次排序
      if (a.isOverdue && !b.isOverdue) return -1;
      if (!a.isOverdue && b.isOverdue) return 1;
      return a.reviewRound.compareTo(b.reviewRound);
    });

    // 统计
    final allTaskIds = allTasks.map((t) => t.id).toSet();
    final completedCount = allTasks.where((t) => t.status == ReviewTaskStatus.done).length;

    return TodayTasksResult(
      tasks: allTasks,
      totalCount: allTaskIds.length,
      completedCount: completedCount,
    );
  }
}
```

---

## 5. 状态管理 (Riverpod)

### 5.1 Provider 结构

```dart
/// 学习内容 Provider
final learningItemProvider = StateNotifierProvider<LearningItemNotifier, AsyncValue<List<LearningItemEntity>>> {
  (ref) => LearningItemNotifier(ref.read(learningItemRepository)),
};

class LearningItemNotifier extends StateNotifier<AsyncValue<List<LearningItemEntity>>> {
  final LearningItemRepository _repository;

  // 增删改查方法
  Future<void> createItem(LearningItemEntity item) async { ... }
  Future<void> deleteItem(int id) async { ... }
  Future<void> refresh() async { ... }
}
```

```dart
/// 今日任务 Provider
final todayTasksProvider = StateNotifierProvider<TodayTasksNotifier, AsyncValue<TodayTasksResult>> {
  (ref) => TodayTasksNotifier(ref.read(getTodayTasksUseecase)),
};

/// 任务完成 Provider（副作用）
final completeTaskProvider = Provider<CompleteReviewTaskUseCase> { ... };
```

```dart
/// 设置 Provider
final settingsProvider = StateNotifierProvider<SettingsNotifier, AppSettings> {
  (ref) => SettingsNotifier(ref.read(settingsRepository)),
};
```

### 5.2 状态分类

| Provider | 类型 | 用途 |
|----------|------|------|
| `learningItemProvider` | StateNotifier | 学习内容列表 |
| `todayTasksProvider` | StateNotifier | 今日复习任务 |
| `settingsProvider` | StateNotifier | 应用设置 |
| `calendarTasksProvider` | StateNotifier | [v1.1] 日历视图任务 |
| `selectedDateProvider` | StateProvider | 当前选中日期 |

---

## 6. 路由设计 (GoRouter)

### 6.1 路由结构

```dart
final appRouter = GoRouter(
  initialLocation: '/home',
  routes: [
    // 底部导航路由
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) {
        return MainScaffold(navigationShell: navigationShell);
      },
      branches: [
        // 首页 - 今日任务
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/home',
              name: 'home',
              builder: (context, state) => const HomePage(),
            ),
          ],
        ),
        // [v1.1] 日历视图
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/calendar',
              name: 'calendar',
              builder: (context, state) => const CalendarPage(),  // v1.1 实现
            ),
          ],
        ),
        // 设置
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/settings',
              name: 'settings',
              builder: (context, state) => const SettingsPage(),
            ),
          ],
        ),
      ],
    ),
    // 录入页面（Modal 路由）
    GoRoute(
      path: '/input',
      name: 'input',
      pageBuilder: (context, state) => CustomTransitionPage(
        child: const InputPage(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return SlideTransition(
            position: Tween<Offset>(
              begin: const Offset(0, 1),
              end: Offset.zero,
            ).animate(CurvedAnimation(
              parent: animation,
              curve: Curves.easeOutCubic,
            )),
            child: child,
          );
        },
      ),
    ),
  ],
);
```

### 6.2 路由参数

| 路由 | 参数 | 说明 |
|------|------|------|
| `/home` | - | 今日任务首页 |
| `/calendar` | - | [v1.1] 日历视图 |
| `/calendar?date=2025-02-25` | date (可选) | [v1.1] 指定日期视图 |
| `/settings` | - | 设置页 |
| `/input` | - | 录入页面（Modal） |
| `/input?itemId=1` | itemId (可选) | 编辑模式 |

---

## 7. 通知服务

### 7.1 通知类型

| 类型 | 用途 | 触发条件 |
|------|------|----------|
| **每日提醒** | 提醒当日有复习任务 | 每日固定时间（默认 09:00） |
| **复习提醒** | 特定任务到期提醒 | 任务计划日期当天 |

### 7.2 通知实现

```dart
/// 通知服务
/// 使用 flutter_local_notifications 实现本地推送
class NotificationService {
  static final NotificationService _instance = NotificationService._internal();
  factory NotificationService() => _instance;

  /// 初始化通知服务
  Future<void> initialize() async {
    // 请求权限
    await flutterLocalNotificationsPlugin
        .resolvePlatformSpecificImplementation<AndroidFlutterLocalNotificationsPlugin>()
        ?.requestNotificationsPermission();

    // 配置通知通道（Android）
    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');
    const initSettings = InitializationSettings(android: androidSettings);

    await flutterLocalNotificationsPlugin.initialize(initSettings);
  }

  /// 调度每日复习提醒
  Future<void> scheduleDailyReminder(TimeOfDay time) async {
    // 使用 WorkManager 调度每日任务
    // 每天指定时间触发通知
  }

  /// 显示复习任务通知
  Future<void> showReviewNotification({
    required int id,
    required String title,
    required String body,
  }) async {
    const androidDetails = AndroidNotificationDetails(
      'review_reminder',
      '复习提醒',
      channelDescription: '复习任务提醒通知',
      importance: Importance.high,
      priority: Priority.high,
    );

    await flutterLocalNotificationsPlugin.show(
      id,
      title,
      body,
      const NotificationDetails(android: androidDetails),
    );
  }
}
```

### 7.3 WorkManager 集成

```dart
/// 后台任务调度
/// 使用 workmanager 定期检查并发送通知
///
/// [NOTE] 通知准时性说明：
/// - v1.0 MVP 使用 WorkManager 定时检查，精度约 ±30 分钟
/// - 受 Android 后台策略限制，无法保证 100% 精确时间
/// - iOS 可使用 BGTaskScheduler 获得更精确的调度
class BackgroundTaskService {
  /// 初始化后台任务
  static Future<void> initialize() async {
    await Workmanager().initialize(
      callbackDispatcher,
      isInDebugMode: true,
    );

    // 注册每日检查任务
    await Workmanager().registerPeriodicTask(
      'daily_review_check',
      'dailyReviewCheck',
      frequency: const Duration(hours: 1),  // 每小时检查一次
      constraints: Constraints(
        networkType: NetworkType.not_required,
      ),
    );
  }
}

/// WorkManager 回调
@pragma('vm:entry-point')
void callbackDispatcher() {
  Workmanager().execute((task, inputData) async {
    switch (task) {
      case 'dailyReviewCheck':
        await _checkAndSendNotification();
        break;
    }
  });
}

/// 检查并发送通知
///
/// 逻辑：
/// 1. 查询今日待复习任务
/// 2. 检查是否在免打扰时段
/// 3. 发送通知
Future<void> _checkAndSendNotification() async {
  // 1. 获取当前时间
  final now = TimeOfDay.now();
  final settings = await SettingsRepository.getSettings();

  // 2. 检查免打扰时段
  final doNotDisturbStart = _parseTimeOfDay(settings.doNotDisturbStart);
  final doNotDisturbEnd = _parseTimeOfDay(settings.doNotDisturbEnd);
  if (_isInDoNotDisturb(now, doNotDisturbStart, doNotDisturbEnd)) {
    return; // 跳过发送
  }

  // 3. 获取今日任务
  final todayTasks = await ReviewTaskRepository.getTodayTasks();
  if (todayTasks.isEmpty) return;

  // 4. 发送通知
  await NotificationService.showReviewNotification(
    id: 1,
    title: '今日复习提醒',
    body: '你有 ${todayTasks.length} 条复习任务待完成',
  );
}
```

---

## 8. 桌面小组件

### 8.1 Android Glance Widget

使用 **Jetpack Glance** 实现 Android 桌面小组件：

```
android/app/src/main/kotlin/.../yike/
├── YikeWidget.kt          # Widget 主类
├── YikeWidgetReceiver.kt  # Widget 接收器
└── glance/                # Glance UI 定义
    ├── SmallWidget.kt     # 2×2 小组件
    └── LargeWidget.kt     # 4×2 小组件
```

### 8.2 Flutter 端数据同步

```dart
/// 小组件服务
/// 使用 home_widget 实现 Flutter 与原生 Widget 数据同步
class WidgetService {
  static const String _appGroupId = 'group.com.yike.app';
  static const String _widgetDataKey = 'widget_data';

  /// 更新小组件数据
  static Future<void> updateWidgetData() async {
    // 1. 获取今日任务统计
    final todayStats = await getTodayTaskStats();

    // 2. 构建小组件数据
    final widgetData = {
      'totalCount': todayStats.totalCount,
      'completedCount': todayStats.completedCount,
      'tasks': todayStats.taskTitles,  // 任务标题列表（最多3条）
      'lastUpdated': DateTime.now().toIso8601String(),
    };

    // 3. 写入 SharedPreferences（Android）或 UserDefaults（iOS）
    await HomeWidget.saveWidgetData(_widgetDataKey, jsonEncode(widgetData));

    // 4. 触发 Widget 刷新
    await HomeWidget.updateWidget(
      androidName: 'YikeWidgetReceiver',
    );
  }

  /// 获取今日任务统计
  static Future<WidgetData> getTodayTaskStats() async {
    final tasks = await reviewTaskRepo.getTodayTasks();
    final completed = tasks.where((t) => t.status == ReviewTaskStatus.done).length;

    return WidgetData(
      totalCount: tasks.length,
      completedCount: completed,
      taskTitles: tasks
          .where((t) => t.status == ReviewTaskStatus.pending)
          .take(3)
          .map((t) => t.learningItem?.title ?? '')
          .toList(),
    );
  }
}
```

### 8.3 小组件布局

**2×2 小组件：**
- 显示：应用图标 + 「今日复习」+ 任务数量

**4×2 小组件：**
- 显示：进度条 + 任务列表（最多3条）
- **[NOTE] v1.0 MVP**：仅展示数据，不支持点击交互

---

## 9. 依赖注入配置

```dart
/// 依赖注入配置
/// 使用 Riverpod 实现依赖管理
class DependencyInjection {
  static void setup() {
    // Database
    final database = AppDatabase();
    provider<AppDatabase>((ref) => database);

    // DAOs
    provider<LearningItemDao>((ref) => database.learningItemDao);
    provider<ReviewTaskDao>((ref) => database.reviewTaskDao);
    provider<AppSettingsDao>((ref) => database.appSettingsDao);

    // Repositories
    provider<LearningItemRepository>(
      (ref) => LearningItemRepositoryImpl(ref.read(learningItemDao)),
    );
    provider<ReviewTaskRepository>(
      (ref) => ReviewTaskRepositoryImpl(ref.read(reviewTaskDao)),
    );
    provider<SettingsRepository>(
      (ref) => SettingsRepositoryImpl(ref.read(appSettingsDao)),
    );

    // UseCases
    provider<CreateLearningItemUseCase>(
      (ref) => CreateLearningItemUseCase(
        ref.read(learningItemRepository),
        ref.read(reviewTaskRepository),
      ),
    );
    provider<GetTodayTasksUseCase>(
      (ref) => GetTodayTasksUseCase(ref.read(reviewTaskRepository)),
    );
    provider<CompleteReviewTaskUseCase>(
      (ref) => CompleteReviewTaskUseCase(ref.read(reviewTaskRepository)),
    );
  }
}
```

---

## 10. pubspec.yaml 依赖配置

```yaml
dependencies:
  flutter:
    sdk: flutter

  # UI
  cupertino_icons: ^1.0.8
  google_fonts: ^6.1.0
  flutter_svg: ^2.0.10+1

  # State Management
  flutter_riverpod: ^2.5.1
  riverpod_annotation: ^2.3.5

  # Database
  drift: ^2.16.0
  sqlite3_flutter_libs: ^0.5.20
  path_provider: ^2.1.2
  path: ^1.9.0

  # Router
  go_router: ^14.0.0

  # Notifications
  flutter_local_notifications: ^17.0.0
  workmanager: ^0.5.2

  # Widget
  home_widget: ^0.6.0

  # Utils
  intl: ^0.19.0
  uuid: ^4.3.3
  collection: ^1.18.0

  # Storage
  flutter_secure_storage: ^9.0.0

  # Permissions
  permission_handler: ^11.3.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^6.0.0

  # Code Generation
  build_runner: ^2.4.8
  drift_dev: ^2.16.0
  riverpod_generator: ^2.4.0
  json_serializable: ^6.7.1
```

---

## 11. 错误处理

### 11.1 异常分类

| 异常类型 | 说明 | 处理方式 |
|----------|------|----------|
| `DatabaseException` | 数据库操作失败 | 显示错误提示，提供重试 |
| `NotificationException` | 通知权限/发送失败 | 引导用户开启权限 |
| `StorageException` | 本地存储失败 | 提示并记录日志 |
| `ValidationException` | 数据验证失败 | 输入框显示错误信息 |

### 11.2 全局错误捕获

```dart
/// 全局错误处理
void setupErrorHandling() {
  FlutterError.onError = (details) {
    // 记录错误日志
    logError(details.exception, details.stackTrace);

    // 显示错误提示
    if (details.exception is DatabaseException) {
      showSnackBar('数据保存失败，请重试');
    }
  };

  // 捕获未处理的 Promise 错误
  PlatformDispatcher.instance.onUncaughtException = (error) {
    logError(error, null);
  };
}
```

---

## 12. 性能优化

### 12.1 性能指标

| 指标 | 目标值 |
|------|--------|
| 冷启动时间 | ≤ 2s |
| 页面切换 | ≤ 300ms |
| 列表滚动 | 60 FPS |
| 数据库查询 | ≤ 100ms |

### 12.2 优化策略

1. **数据库查询优化**
   - 使用索引加速日期查询
   - 批量插入减少事务次数
   - 懒加载关联数据

2. **UI 渲染优化**
   - 使用 `const` 构造函数
   - 合理使用 `RepaintBoundary`
   - 图片/图标缓存

3. **状态管理优化**
   - 使用 `select` 减少不必要的重建
   - 按需加载数据（分页）

---

## 13. 安全考虑

### 13.1 数据安全

| 措施 | 说明 |
|------|------|
| **本地加密** | 使用 flutter_secure_storage 加密敏感配置 |
| **数据库加密** | SQLite 支持加密（可选） |
| **导出数据** | 提供 JSON 格式导出 |

### 13.2 权限处理

| 权限 | 用途 | 说明 |
|------|------|------|
| `NOTIFICATIONS` | 通知提醒 | 必须，核心功能 |
| `POST_NOTIFICATIONS` | Android 13+ 通知权限 | 必须 |
| `SCHEDULE_EXACT_ALARM` | 精确定时提醒 | 必须 |
| `RECEIVE_BOOT_COMPLETED` | 开机自启 | 可选 |

---

## 14. 测试策略

### 14.1 单元测试

- Repository 实现测试
- UseCase 业务逻辑测试
- 工具函数测试（日期计算、艾宾浩斯曲线）

### 14.2 Widget 测试

- 关键组件渲染测试
- 交互行为测试

### 14.3 集成测试

- 数据库读写测试
- 通知发送测试

---

## 15. 后续扩展

### v1.1 计划

| 功能 | 技术要点 |
|------|----------|
| 日历视图 | 自定义 Calendar 组件 + 数据聚合 |
| 标签管理 | 多选筛选、标签 CRUD |
| iOS 小组件 | WidgetKit 实现 |

### v2.0 计划

| 功能 | 技术要点 |
|------|----------|
| 云端同步 | Firebase / 自建后端 |
| 数据导出 | JSON/CSV 文件生成 |
| 自定义间隔 | 用户配置存储 + 动态计算 |

---

*文档版本：v1.0*
*创建日期：2025-02-25*
*基于 Clean Architecture + Riverpod + Drift*
