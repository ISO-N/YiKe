# 忆刻 (YiKe) v3.1 技术设计文档 (TDD)

## 概述

本文档定义忆刻 v3.1 版本（Debug 工具与体验优化）的技术实现方案。

---

## 一、F13 Debug 模拟数据生成器

### 1.1 技术方案

#### 功能设计

仅在 Debug 模式下提供模拟数据生成功能，通过 `kDebugMode` 判断环境。

```dart
import 'package:flutter/foundation.dart';

/// 判断是否为 Debug 模式
bool get isDebugMode => kDebugMode;
```

#### 依赖配置

无需新增依赖，复用现有库。

### 1.2 文件改动

| 文件 | 改动类型 | 说明 |
|------|----------|------|
| `settings_page.dart` | 修改 | 新增开发工具入口（Debug 条件渲染） |
| `home_page.dart` | 修改 | 新增搜索栏、进度展示 |
| `calendar_page.dart` | 修改 | 新增筛选栏 |

### 1.3 新增文件

| 文件 | 说明 |
|------|------|
| `lib/presentation/pages/debug/mock_data_generator_page.dart` | 模拟数据生成器页面 |
| `lib/presentation/widgets/search_bar.dart` | 搜索栏组件 |
| `lib/presentation/widgets/review_progress.dart` | 复习进度组件 |
| `lib/presentation/widgets/task_filter_bar.dart` | 任务筛选栏 |
| `lib/presentation/providers/mock_data_provider.dart` | 模拟数据 Provider |
| `lib/infrastructure/debug/mock_data_service.dart` | 模拟数据服务 |

### 1.4 模拟数据服务实现

```dart
// 文件：lib/infrastructure/debug/mock_data_service.dart

import 'dart:math';
import 'package:flutter/foundation.dart';
import 'package:drift/drift.dart';

/// 模拟数据配置
class MockDataConfig {
  final int contentCount;
  final int taskCount;
  final int daysRange;
  final MockDataTemplate template;
  final bool includeCompleted;
  final bool includeSkipped;

  const MockDataConfig({
    this.contentCount = 10,
    this.taskCount = 50,
    this.daysRange = 30,
    this.template = MockDataTemplate.englishWords,
    this.includeCompleted = true,
    this.includeSkipped = false,
  });
}

/// 模拟数据模板
enum MockDataTemplate {
  englishWords,
  historyEvents,
  custom,
}

/// 模拟数据服务
class MockDataService {
  final LearningContentDao _contentDao;
  final ReviewTaskDao _taskDao;
  final Random _random = Random();

  MockDataService(this._contentDao, this._taskDao);

  /// 生成模拟数据
  Future<void> generateMockData(MockDataConfig config) async {
    assert(kDebugMode, 'Mock data generation is only available in debug mode');

    final contentIds = <int>[];

    // 1. 生成学习内容
    for (int i = 0; i < config.contentCount; i++) {
      final id = await _generateContent(config.template, i);
      contentIds.add(id);
    }

    // 2. 生成复习任务（符合艾宾浩斯曲线）
    await _generateReviewTasks(contentIds, config);

    // 3. 标记为模拟数据（便于清理）
    await _markMockData(contentIds);
  }

  /// 生成单条学习内容
  Future<int> _generateContent(MockDataTemplate template, int index) async {
    final now = DateTime.now();
    final title = _generateTitle(template, index);
    final content = _generateContentText(template, index);

    return await _contentDao.insertLearningContent(
      LearningContentsCompanion.insert(
        title: title,
        content: content,
        contentType: 'text',
        reviewTemplate: const Value('default'),
        createdAt: now.subtract(Duration(days: _random.nextInt(90))),
        isMockData: const Value(true), // 标记为模拟数据
      ),
    );
  }

  /// 生成标题
  String _generateTitle(MockDataTemplate template, int index) {
    switch (template) {
      case MockDataTemplate.englishWords:
        return _englishWords[index % _englishWords.length];
      case MockDataTemplate.historyEvents:
        return _historyEvents[index % _historyEvents.length];
      case MockDataTemplate.custom:
        return '测试内容 ${index + 1}';
    }
  }

  /// 生成内容文本
  String _generateContentText(MockDataTemplate template, int index) {
    switch (template) {
      case MockDataTemplate.englishWords:
        return _englishContents[index % _englishContents.length];
      case MockDataTemplate.historyEvents:
        return _historyContents[index % _historyContents.length];
      case MockDataTemplate.custom:
        return '这是第 ${index + 1} 条测试内容，用于调试和测试。';
    }
  }

  /// 生成复习任务（符合艾宾浩斯曲线分布）
  Future<void> _generateReviewTasks(
    List<int> contentIds,
    MockDataConfig config,
  ) async {
    // 艾宾浩斯复习间隔：1, 2, 4, 7, 15, 30 天
    final intervals = [1, 2, 4, 7, 15, 30];
    final now = DateTime.now();

    for (int i = 0; i < config.taskCount; i++) {
      final contentId = contentIds[_random.nextInt(contentIds.length)];
      final interval = intervals[_random.nextInt(intervals.length)];
      final daysAgo = _random.nextInt(config.daysRange);

      final plannedDate = now.subtract(Duration(days: daysAgo));

      ReviewTaskStatus status;
      ReviewResult? result;

      if (config.includeCompleted && _random.nextDouble() > 0.3) {
        status = ReviewTaskStatus.completed;
        result = ReviewResult.values[_random.nextInt(3)];
      } else if (config.includeSkipped && _random.nextDouble() > 0.5) {
        status = ReviewTaskStatus.skipped;
      } else {
        // 部分为待复习（计划日期在今天或之前）
        if (daysAgo <= 0) {
          status = ReviewTaskStatus.pending;
        } else {
          status = ReviewTaskStatus.completed;
          result = ReviewResult.values[_random.nextInt(3)];
        }
      }

      await _taskDao.insertReviewTask(
        ReviewTasksCompanion.insert(
          contentId: contentId,
          plannedDate: plannedDate,
          status: status,
          reviewResult: result != null ? Value(result) : const Value.absent(),
          reviewDate: status == ReviewTaskStatus.completed
              ? Value(plannedDate.add(Duration(hours: _random.nextInt(12))))
              : const Value.absent(),
          isMockData: const Value(true), // 标记为模拟数据
        ),
      );
    }
  }

  /// 标记为模拟数据
  Future<void> _markMockData(List<int> contentIds) async {
    // 数据已在上一步标记，这里无需额外操作
  }

  /// 清理模拟数据
  Future<void> clearMockData() async {
    await _contentDao.clearMockData();
    await _taskDao.clearMockData();
  }

  /// 英语单词数据
  static const _englishWords = [
    'abandon', 'ability', 'able', 'about', 'above',
    'absence', 'absolute', 'academic', 'accept', 'access',
  ];

  static const _englishContents = [
    'v. 放弃；遗弃\nn. 放任',
    'n. 能力；才能',
    'adj. 能够的；有能力的',
    'prep. 关于；大约',
    'adv. 在上面；在高处',
  ];

  /// 历史事件数据
  static const _historyEvents = [
    '秦始皇统一六国', '赤壁之战', '玄武门之变',
    '安史之乱', '靖康之变', '辛亥革命',
  ];

  static const _historyContents = [
    '公元前221年，秦始皇统一六国，建立秦朝',
    '208年，孙权、刘备联军大败曹操于赤壁',
    '626年，李世民在玄武门发动政变',
    '755-763年，安禄山发动的叛乱',
    '1127年，金朝攻破北宋都城汴京',
    '1911年，辛亥革命爆发，推翻清朝',
  ];
}
```

### 1.5 DAO 扩展

```dart
// 文件：lib/data/database/daos/learning_content_dao.dart 新增方法

part 'learning_content_dao.g.dart';

@DriftAccessor(tables: [LearningContents])
class LearningContentDao extends DatabaseAccessor<AppDatabase>
    with _$LearningContentDaoMixin {
  LearningContentDao(super.db);

  /// 插入学习内容
  Future<int> insertLearningContent(LearningContentsCompanion content) {
    return into(learningContents).insert(content);
  }

  /// 清理模拟数据
  Future<void> clearMockData() async {
    await (delete(learningContents)
          ..where((t) => t.isMockData.equals(true)))
        .go();
  }

  /// 搜索学习内容
  Future<List<LearningContent>> searchContents(String keyword) async {
    return (select(learningContents)
          ..where((t) =>
              t.title.contains(keyword) |
              t.content.contains(keyword) |
              t.notes.contains(keyword)))
        .get();
  }
}
```

```dart
// 文件：lib/data/database/daos/review_task_dao.dart 新增方法

part 'review_task_dao.g.dart';

@DriftAccessor(tables: [ReviewTasks])
class ReviewTaskDao extends DatabaseAccessor<AppDatabase>
    with _$ReviewTaskDaoMixin {
  ReviewTaskDao(super.db);

  /// 清理模拟数据
  Future<void> clearMockData() async {
    await (delete(reviewTasks)..where((t) => t.isMockData.equals(true)))
        .go();
  }

  /// 按状态筛选任务
  Future<List<ReviewTask>> getTasksByStatus(
    DateTime date, {
    ReviewTaskStatus? status,
  }) async {
    final startOfDay = DateTime(date.year, date.month, date.day);
    final endOfDay = startOfDay.add(const Duration(days: 1));

    var query = select(reviewTasks)
      ..where((t) => t.plannedDate.isBetweenValues(startOfDay, endOfDay));

    if (status != null) {
      query = query..where((t) => t.status.equals(status.name));
    }

    return query.get();
  }
}
```

### 1.6 Provider 实现

```dart
// 文件：lib/presentation/providers/mock_data_provider.dart

import 'package:flutter/foundation.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../infrastructure/debug/mock_data_service.dart';
import '../../data/database/daos/learning_content_dao.dart';
import '../../data/database/daos/review_task_dao.dart';

/// 模拟数据生成状态
enum MockDataState {
  idle,
  generating,
  success,
  error,
}

/// 模拟数据 Provider
final mockDataProvider =
    StateNotifierProvider<MockDataNotifier, MockDataState>((ref) {
  return MockDataNotifier();
});

class MockDataNotifier extends StateNotifier<MockDataState> {
  MockDataService? _service;

  MockDataNotifier() : super(MockDataState.idle);

  /// 初始化服务
  void init(LearningContentDao contentDao, ReviewTaskDao taskDao) {
    _service = MockDataService(contentDao, taskDao);
  }

  /// 生成模拟数据
  Future<void> generate(MockDataConfig config) async {
    if (!kDebugMode) return;

    state = MockDataState.generating;

    try {
      await _service?.generateMockData(config);
      state = MockDataState.success;

      // 2 秒后重置状态
      Future.delayed(const Duration(seconds: 2), () {
        if (mounted) state = MockDataState.idle;
      });
    } catch (e) {
      state = MockDataState.error;
    }
  }

  /// 清理模拟数据
  Future<void> clear() async {
    if (!kDebugMode) return;

    try {
      await _service?.clearMockData();
      state = MockDataState.success;
    } catch (e) {
      state = MockDataState.error;
    }
  }

  /// 重置状态
  void reset() {
    state = MockDataState.idle;
  }
}
```

---

## 二、F14.1 学习内容搜索

### 2.1 技术方案

#### 搜索策略

| 方案 | 优点 | 缺点 |
|------|------|------|
| 前端过滤 | 无需网络请求 | 数据量大时性能差 |
| **数据库 LIKE 查询** | 支持全文搜索 | 需要索引优化 |
| FTS (Full-Text Search) | 性能最好 | 需要额外配置 |

**推荐方案**：数据库 LIKE 查询 + 索引优化

#### 防抖处理

```dart
import 'dart:async';

/// 防抖辅助类
class Debouncer {
  final Duration delay;
  Timer? _timer;

  Debouncer({this.delay = const Duration(milliseconds: 300)});

  void run(void Function() action) {
    _timer?.cancel();
    _timer = Timer(delay, action);
  }

  void dispose() {
    _timer?.cancel();
  }
}
```

### 2.2 搜索栏组件

```dart
// 文件：lib/presentation/widgets/search_bar.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

/// 搜索栏组件
class LearningSearchBar extends ConsumerStatefulWidget {
  final ValueChanged<String> onSearch;
  final VoidCallback? onClear;

  const LearningSearchBar({
    super.key,
    required this.onSearch,
    this.onClear,
  });

  @override
  ConsumerState<LearningSearchBar> createState() => _LearningSearchBarState();
}

class _LearningSearchBarState extends ConsumerState<LearningSearchBar> {
  final _controller = TextEditingController();
  final _focusNode = FocusNode();
  final _debouncer = Debouncer();

  @override
  void dispose() {
    _controller.dispose();
    _focusNode.dispose();
    _debouncer.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.08),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: TextField(
        controller: _controller,
        focusNode: _focusNode,
        decoration: InputDecoration(
          hintText: '搜索学习内容...',
          prefixIcon: const Icon(Icons.search, size: 20, color: Colors.grey),
          suffixIcon: _controller.text.isNotEmpty
              ? IconButton(
                  icon: const Icon(Icons.clear, size: 20),
                  onPressed: () {
                    _controller.clear();
                    widget.onClear?.call();
                    widget.onSearch('');
                  },
                )
              : null,
          border: InputBorder.none,
          contentPadding: const EdgeInsets.symmetric(
            horizontal: 16,
            vertical: 12,
          ),
        ),
        onChanged: (value) {
          setState(() {}); // 更新清除按钮显示
          _debouncer.run(() => widget.onSearch(value));
        },
      ),
    );
  }
}
```

### 2.3 搜索结果 Provider

```dart
// 文件：lib/presentation/providers/search_provider.dart

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../data/database/daos/learning_content_dao.dart';
import '../../data/models/learning_content.dart';

/// 搜索关键词 Provider
final searchKeywordProvider = StateProvider<String>((ref) => '');

/// 搜索结果 Provider
final searchResultsProvider = FutureProvider<List<LearningContent>>((ref) async {
  final keyword = ref.watch(searchKeywordProvider);

  if (keyword.isEmpty) {
    return [];
  }

  // 获取 DAO（需要通过其他 Provider 注入）
  final dao = ref.read(learningContentDaoProvider);
  return await dao.searchContents(keyword);
});

/// 搜索历史 Provider
final searchHistoryProvider =
    StateNotifierProvider<SearchHistoryNotifier, List<String>>((ref) {
  return SearchHistoryNotifier();
});

class SearchHistoryNotifier extends StateNotifier<List<String>> {
  static const _maxHistory = 5;

  SearchHistoryNotifier() : super([]);

  void add(String keyword) {
    if (keyword.isEmpty) return;

    // 移除已存在的相同关键词
    final newState = state.where((k) => k != keyword).toList();

    // 添加到开头
    newState.insert(0, keyword);

    // 限制数量
    state = newState.take(_maxHistory).toList();
  }

  void clear() {
    state = [];
  }

  void remove(String keyword) {
    state = state.where((k) => k != keyword).toList();
  }
}
```

---

## 三、F14.2 复习任务状态筛选

### 3.1 筛选状态定义

```dart
/// 复习任务筛选状态
enum ReviewTaskFilter {
  all,       // 全部
  pending,   // 待复习
  completed, // 已完成
  skipped,   // 已跳过
}

/// 筛选状态扩展
extension ReviewTaskFilterExtension on ReviewTaskFilter {
  String get label {
    switch (this) {
      case ReviewTaskFilter.all:
        return '全部';
      case ReviewTaskFilter.pending:
        return '待复习';
      case ReviewTaskFilter.completed:
        return '已完成';
      case ReviewTaskFilter.skipped:
        return '已跳过';
    }
  }

  IconData get icon {
    switch (this) {
      case ReviewTaskFilter.all:
        return Icons.list;
      case ReviewTaskFilter.pending:
        return Icons.schedule;
      case ReviewTaskFilter.completed:
        return Icons.check_circle;
      case ReviewTaskFilter.skipped:
        return Icons.skip_next;
    }
  }
}
```

### 3.2 筛选栏组件

```dart
// 文件：lib/presentation/widgets/task_filter_bar.dart

import 'package:flutter/material.dart';

/// 任务筛选栏组件
class TaskFilterBar extends StatelessWidget {
  final ReviewTaskFilter selectedFilter;
  final Map<ReviewTaskFilter, int> counts;
  final ValueChanged<ReviewTaskFilter> onFilterChanged;

  const TaskFilterBar({
    super.key,
    required this.selectedFilter,
    required this.counts,
    required this.onFilterChanged,
  });

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: Row(
        children: ReviewTaskFilter.values.map((filter) {
          final isSelected = filter == selectedFilter;
          final count = counts[filter] ?? 0;

          return Padding(
            padding: const EdgeInsets.only(right: 8),
            child: FilterChip(
              label: Text('${filter.label}($count)'),
              selected: isSelected,
              onSelected: (_) => onFilterChanged(filter),
              selectedColor: Theme.of(context).primaryColor,
              labelStyle: TextStyle(
                color: isSelected ? Colors.white : Colors.grey[700],
              ),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
            ),
          );
        }).toList(),
      ),
    );
  }
}
```

### 3.3 筛选 Provider

```dart
/// 当前筛选状态 Provider
final taskFilterProvider =
    StateProvider<ReviewTaskFilter>((ref) => ReviewTaskFilter.all);

/// 筛选后任务统计 Provider
final taskCountsProvider = FutureProvider<Map<ReviewTaskFilter, int>>((ref) async {
  final dao = ref.read(reviewTaskDaoProvider);
  final date = ref.watch(selectedDateProvider);

  final allTasks = await dao.getTasksByDate(date);
  final pendingTasks = await dao.getTasksByStatus(date, status: ReviewTaskStatus.pending);
  final completedTasks = await dao.getTasksByStatus(date, status: ReviewTaskStatus.completed);
  final skippedTasks = await dao.getTasksByStatus(date, status: ReviewTaskStatus.skipped);

  return {
    ReviewTaskFilter.all: allTasks.length,
    ReviewTaskFilter.pending: pendingTasks.length,
    ReviewTaskFilter.completed: completedTasks.length,
    ReviewTaskFilter.skipped: skippedTasks.length,
  };
});
```

---

## 四、F14.3 首页复习进度展示

### 4.1 进度数据模型

```dart
/// 复习进度数据
class ReviewProgress {
  final int completed;
  final int total;
  final int weekCompleted;
  final int weekTotal;
  final int monthCompleted;
  final int monthTotal;
  final int totalReviews;
  final int streakDays;

  const ReviewProgress({
    required this.completed,
    required this.total,
    required this.weekCompleted,
    required this.weekTotal,
    required this.monthCompleted,
    required this.monthTotal,
    required this.totalReviews,
    required this.streakDays,
  });

  double get progressPercent => total > 0 ? completed / total : 0;

  ReviewProgressStatus get status {
    if (total == 0 || completed == 0) {
      return ReviewProgressStatus.notStarted;
    } else if (completed >= total) {
      return ReviewProgressStatus.completed;
    } else if (completed > total) {
      return ReviewProgressStatus.overCompleted;
    } else {
      return ReviewProgressStatus.inProgress;
    }
  }
}

/// 复习进度状态
enum ReviewProgressStatus {
  notStarted,    // 未开始
  inProgress,    // 进行中
  completed,     // 已完成
  overCompleted, // 超额完成
}
```

### 4.2 进度环组件

```dart
// 文件：lib/presentation/widgets/review_progress.dart

import 'package:flutter/material.dart';
import 'dart:math' as math;

/// 复习进度组件
class ReviewProgressWidget extends StatelessWidget {
  final ReviewProgress progress;
  final VoidCallback? onTap;

  const ReviewProgressWidget({
    super.key,
    required this.progress,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.all(16),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.08),
              blurRadius: 8,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              '今日复习进度',
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w600,
              ),
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                _ProgressRing(
                  progress: progress.progressPercent,
                  status: progress.status,
                  size: 100,
                ),
                const SizedBox(width: 16),
                Text(
                  '${progress.completed} / ${progress.total}',
                  style: const TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

/// 进度环组件
class _ProgressRing extends StatelessWidget {
  final double progress;
  final ReviewProgressStatus status;
  final double size;

  const _ProgressRing({
    required this.progress,
    required this.status,
    this.size = 100,
  });

  Color get _ringColor {
    switch (status) {
      case ReviewProgressStatus.notStarted:
        return Colors.grey;
      case ReviewProgressStatus.inProgress:
        return Colors.blue;
      case ReviewProgressStatus.completed:
        return Colors.green;
      case ReviewProgressStatus.overCompleted:
        return Colors.amber;
    }
  }

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      width: size,
      height: size,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // 背景环
          SizedBox(
            width: size,
            height: size,
            child: CircularProgressIndicator(
              value: 1,
              strokeWidth: 10,
              backgroundColor: _ringColor.withOpacity(0.1),
              valueColor: AlwaysStoppedAnimation(_ringColor.withOpacity(0.1)),
            ),
          ),
          // 进度环
          SizedBox(
            width: size,
            height: size,
            child: TweenAnimationBuilder<double>(
              tween: Tween(begin: 0, end: progress.clamp(0, 1)),
              duration: const Duration(milliseconds: 600),
              curve: Curves.easeInOut,
              builder: (context, value, child) {
                return CircularProgressIndicator(
                  value: value,
                  strokeWidth: 10,
                  backgroundColor: Colors.transparent,
                  valueColor: AlwaysStoppedAnimation(_ringColor),
                );
              },
            ),
          ),
          // 百分比文字
          TweenAnimationBuilder<double>(
            tween: Tween(begin: 0, end: (progress * 100).round()),
            duration: const Duration(milliseconds: 600),
            builder: (context, value, child) {
              return Text(
                '${value.toInt()}%',
                style: TextStyle(
                  fontSize: size * 0.28,
                  fontWeight: FontWeight.bold,
                  color: _ringColor,
                ),
              );
            },
          ),
        ],
      ),
    );
  }
}
```

### 4.3 进度 Provider

```dart
// 文件：lib/presentation/providers/progress_provider.dart

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../data/database/daos/review_task_dao.dart';

/// 今日复习进度 Provider
final todayProgressProvider = FutureProvider<ReviewProgress>((ref) async {
  final dao = ref.read(reviewTaskDaoProvider);
  final now = DateTime.now();
  final startOfDay = DateTime(now.year, now.month, now.day);
  final endOfDay = startOfDay.add(const Duration(days: 1));

  // 今日数据
  final todayTasks = await dao.getTasksByDateRange(startOfDay, endOfDay);
  final todayCompleted = todayTasks
      .where((t) => t.status == ReviewTaskStatus.completed)
      .length;

  // 本周数据
  final weekStart = startOfDay.subtract(Duration(days: now.weekday - 1));
  final weekTasks = await dao.getTasksByDateRange(weekStart, endOfDay);
  final weekCompleted = weekTasks
      .where((t) => t.status == ReviewTaskStatus.completed)
      .length;

  // 本月数据
  final monthStart = DateTime(now.year, now.month, 1);
  final monthTasks = await dao.getTasksByDateRange(monthStart, endOfDay);
  final monthCompleted = monthTasks
      .where((t) => t.status == ReviewTaskStatus.completed)
      .length;

  // 总复习次数
  final totalReviews = await dao.getTotalCompletedCount();

  // 连续学习天数
  final streakDays = await dao.getStreakDays();

  return ReviewProgress(
    completed: todayCompleted,
    total: todayTasks.length,
    weekCompleted: weekCompleted,
    weekTotal: weekTasks.length,
    monthCompleted: monthCompleted,
    monthTotal: monthTasks.length,
    totalReviews: totalReviews,
    streakDays: streakDays,
  );
});
```

---

## 五、数据库表扩展

### 5.1 学习内容表扩展

```dart
// 文件：lib/data/database/tables/learning_contents_table.dart

class LearningContents extends Table {
  // ... 现有字段 ...

  /// 是否为模拟数据（用于 Debug 模式清理）
  BoolColumn get isMockData => boolean().withDefault(const Constant(false))();
}
```

### 5.2 复习任务表扩展

```dart
// 文件：lib/data/database/tables/review_tasks_table.dart

class ReviewTasks extends Table {
  // ... 现有字段 ...

  /// 是否为模拟数据（用于 Debug 模式清理）
  BoolColumn get isMockData => boolean().withDefault(const Constant(false))();
}
```

---

## 六、文件改动汇总

### 6.1 修改文件

| 文件 | 改动 |
|------|------|
| `lib/data/database/tables/learning_contents_table.dart` | 新增 isMockData 字段 |
| `lib/data/database/tables/review_tasks_table.dart` | 新增 isMockData 字段 |
| `lib/data/database/daos/learning_content_dao.dart` | 新增搜索、清理方法 |
| `lib/data/database/daos/review_task_dao.dart` | 新增筛选、统计方法 |
| `lib/presentation/pages/settings/settings_page.dart` | 新增 Debug 入口 |
| `lib/presentation/pages/home/home_page.dart` | 新增搜索栏、进度展示 |
| `lib/presentation/pages/calendar/calendar_page.dart` | 新增筛选栏 |

### 6.2 新增文件

| 文件 | 说明 |
|------|------|
| `lib/presentation/pages/debug/mock_data_generator_page.dart` | 模拟数据生成器页面 |
| `lib/presentation/widgets/search_bar.dart` | 搜索栏组件 |
| `lib/presentation/widgets/review_progress.dart` | 复习进度组件 |
| `lib/presentation/widgets/task_filter_bar.dart` | 任务筛选栏 |
| `lib/presentation/providers/mock_data_provider.dart` | 模拟数据 Provider |
| `lib/presentation/providers/search_provider.dart` | 搜索 Provider |
| `lib/presentation/providers/progress_provider.dart` | 进度 Provider |
| `lib/infrastructure/debug/mock_data_service.dart` | 模拟数据服务 |

---

## 七、验收检查点

### 7.1 Debug 模拟数据生成器

- [ ] Release 模式下设置页不显示开发工具入口
- [ ] Debug 模式下可配置生成参数
- [ ] 生成的数据符合艾宾浩斯曲线分布
- [ ] 清理功能只删除标记为模拟的数据

### 7.2 学习内容搜索

- [ ] 搜索栏显示在首页顶部
- [ ] 输入关键词实时搜索（防抖 300ms）
- [ ] 搜索结果正确高亮匹配词
- [ ] 搜索历史记录正确保存

### 7.3 复习任务筛选

- [ ] 日历视图正确显示筛选栏
- [ ] 筛选后任务列表正确更新
- [ ] 各状态统计数量正确

### 7.4 复习进度展示

- [ ] 进度环正确显示百分比
- [ ] 进度状态颜色正确
- [ ] 点击展开显示详细统计

---

*本文档为忆刻 v3.1 技术设计文档，与 PRD v3.1 和 UI/UX v3.1 配合使用。*
