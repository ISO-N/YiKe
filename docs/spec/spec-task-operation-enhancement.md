# 规格变更文档 - 任务操作增强与复习计划调整

## 文档信息

- 用途：记录用户反馈的产品改进需求与对应规格变更
- 作者：YiKe 团队
- 创建日期：2026-02-28
- 变更类型：功能增强
- 版本：v1.4

---

## 0. 设计决策澄清（新增）

在实现前，需要先澄清以下"定义不清"的点：

### 0.1 编辑备注的对象

**决策**：编辑的是**学习内容（LearningItem）的备注**，不是复习任务的备注。

**依据**：
- `note` 字段实际存储在 `learning_items` 表中（`lib/data/database/tables/learning_items_table.dart:19`）
- 视图实体中 `note` 也属于学习内容信息（`lib/domain/entities/review_task.dart:125`）
- 一个学习内容会生成多轮复习任务，编辑备注应该统一修改学习内容

**影响**：
- UseCase 命名：`UpdateLearningItemNoteUseCase`（不是 UpdateTaskNoteUseCase）
- 后端操作：更新 `learning_items` 表的 `note` 字段
- 视图展示：所有轮次的任务都会显示更新后的备注

### 0.2 删除任务的语义

**决策**：删除操作是**停用/归档整个学习内容**（连带所有轮次的复习任务），不是删除某一轮复习记录。

**依据**：
- 当前表结构是"每条学习内容生成多轮复习任务"（默认 5 轮）
- 学习内容删除会级联删除任务（`lib/data/database/tables/review_tasks_table.dart:12` 外键约束）
- 用户需求描述"删除后不会生成后续复习计划"更符合"停用学习内容"

**语义定义**：
| 场景 | 操作对象 | 影响 |
|------|----------|------|
| 删除复习任务 | 单条 review_tasks 记录 | 不允许（会破坏复习计划完整性） |
| 删除/停用学习内容 | learning_item + 所有关联任务 | 停止生成后续轮次，关联任务通过 join + is_deleted=0 过滤不可见 |

### 0.3 增加复习轮次的约束

**决策**：允许用户增加复习轮次，但设置**最大轮次上限为 10 轮**。

**依据**：
- 现有约束 `review_round BETWEEN 1 AND 5`（`lib/data/database/tables/review_tasks_table.dart:51`）
- 艾宾浩斯默认间隔只有 5 个（`lib/core/utils/ebbinghaus_utils.dart:9`）
- 用户需求是"遗忘慢可以延后"，说明有额外复习需求

**实现规则**：
- 当前轮次 < 10 时，允许增加轮次
- 新增轮次的日期计算：使用艾宾浩斯公式扩展间隔数组（需要修改算法支持 > 5 轮）
- 当前轮次 >= 10 时，禁用"增加轮次"按钮，提示"已达到最大轮次"

### 0.4 路由参数设计

**决策**：详情页使用 `learningItemId` 作为路由参数，而不是 `taskId`。

**理由**：
- 详情 Sheet 需要展示"学习内容信息 + 全部轮次计划"
- 用 `learningItemId` 可以直接关联 learning_items 表和所有 review_tasks
- 避免处理"task 已被删/软删"的边界问题

---

## 1. 问题陈述

### 1.1 用户反馈

用户在使用过程中提出以下不满：

| 序号 | 问题描述 | 影响 |
|------|----------|------|
| P1 | 今日页面的复习任务不能点开查看详情 | 用户无法查看任务的备注信息，无法确认任务内容 |
| P2 | 误操作点击跳过或完成后，无法恢复原状态 | 1. 误操作后只能等待下一次复习周期<br>2. 无法快速纠正错误操作 |
| P3 | 任务页面（任务中心）可以点开看备注，但缺少编辑按钮 | 用户无法修改任务备注 |
| P4 | 任务页面缺少删除/停用入口（软删除） | 用户无法停用不需要的学习内容 |
| P5 | 缺少调整复习计划的功能 | 遗忘快的任务无法提前复习，遗忘慢的任务无法延后复习 |
| P6 | 缺少增加复习轮次的功能 | 用户无法根据记忆情况增加复习轮数 |

### 1.2 根本原因分析

1. **今日页面交互限制**：首页设计为快速操作导向，任务卡片不支持展开查看详情
2. **撤销功能缺失**：已完成/已跳过任务未提供撤销入口
3. **任务管理功能不完整**：任务中心页面仅提供查看功能，缺少编辑和删除能力
4. **复习计划调整能力缺失**：系统按照艾宾浩斯遗忘曲线自动计算复习日期，但未提供用户手动调整的入口

---

## 2. 变更方案概述

### 2.1 核心策略

| 策略 | 说明 |
|------|------|
| 今日页面任务支持展开详情 | 点击任务卡片可展开查看备注、标签等信息 |
| 今日页面支持撤销操作 | 已完成/已跳过任务增加撤销按钮 |
| 任务中心增加编辑功能 | 任务详情页增加编辑备注功能 |
| 任务中心增加停用功能 | 任务详情页增加停用学习内容功能（软删除 LearningItem） |
| 复习计划调整功能 | 支持手动调整后续复习日期和增加复习轮次 |

### 2.2 涉及模块

- **首页 (HomePage)**：任务卡片展开详情、撤销操作
- **任务中心页面 (TaskHubPage)**：编辑学习内容备注、停用学习内容、调整复习计划
- **数据库层**：learning_items 表新增 isDeleted/deletedAt 字段，调整 review_round 约束
- **业务逻辑层**：新增复习计划调整 UseCase，扩展艾宾浩斯算法支持 6-10 轮

---

## 3. 详细功能设计

### 3.1 今日页面任务操作增强

#### 3.1.1 任务卡片展开详情

**位置**：首页任务卡片

**UI 规格**：
- 点击任务卡片展开详情区域
- 详情区域显示：任务标题、备注内容（如有）、标签列表
- 再次点击收起详情

**交互逻辑**：
- 待复习任务：点击展开详情，操作按钮（完成/跳过）保持可见
- 已完成任务：点击展开详情，显示完成时间，显示撤销按钮
- 已跳过任务：点击展开详情，显示跳过时间，显示撤销按钮

#### 3.1.2 撤销操作

**触发场景**：用户点击「撤销」按钮

**确认方式**：弹出确认对话框
- 标题：「撤销任务状态？」
- 内容：「该任务将恢复为待复习状态，是否确认撤销？」
- 按钮：「取消」「确认撤销」

**后端逻辑**：
1. 校验关联的 learning_item.is_deleted = 0，若已停用则返回错误
2. 更新 `status` 为 `pending`
3. 清空 `completedAt`（如果是已完成撤销）
4. 清空 `skippedAt`（如果是已跳过撤销）
5. 更新 `updatedAt` 为当前时间戳
6. 触发相关页面数据刷新

**副作用处理规则**：
- 撤销时**不自动生成下一轮任务**（如果当前轮次已完成/跳过，系统不会因为撤销而删除下一轮）
- 统计口径采用**方案A：实时按当前状态/时间戳聚合**
  - 统计页面实时查询当前数据库状态
  - 撤销后，该任务记录从"今日完成"中移除，统计数实时减少
  - 统计不保留历史事件日志，撤销会回滚统计
- 日历圆点：撤销后该任务不再计入当天的完成/跳过统计

**停用后的行为规范**：
- 停用后，该学习内容的所有任务**不主动展示**在首页/任务中心/日历等列表页
- 用户仍可通过路由（如 `/tasks/detail/:learningItemId`）访问详情页
- 详情页检测到 `is_deleted = 1` 时，显示"已停用"状态，并**禁用或隐藏所有操作按钮**（撤销、调整计划、增加轮次、编辑备注、停用）
- 停用后**不允许任何状态变更操作**

**路由访问边界处理**：
| 场景 | 页面行为 |
|------|----------|
| learningItemId 不存在 | 显示空态页面，包含"返回"入口，无任务信息 |
| learningItemId 存在但 is_deleted = 1 | 显示详情页，顶部显示"已停用"标签，所有操作按钮禁用，仅支持查看（只读模式） |
| learningItemId 存在且 is_deleted = 0 | 正常显示详情页，操作按钮可用 |

---

### 3.2 任务中心页面功能增强

#### 3.2.1 编辑备注功能

**位置**：任务详情弹窗/底部Sheet

**UI 规格**：
- 点击任务卡片展开详情操作区
- 新增「编辑」按钮，点击弹出编辑弹窗
- 编辑弹窗包含：备注文本框（多行）、保存按钮、取消按钮

**交互逻辑**：
1. 点击「编辑」按钮，弹出编辑弹窗
2. 弹窗内显示当前备注内容（可为空）
3. 用户修改备注后点击「保存」
4. 保存成功后关闭弹窗，刷新任务列表
5. 取消则关闭弹窗不做修改

**后端逻辑**（见 0.1 决策澄清）：
1. 更新 `learning_items` 表的 `note` 字段
2. 刷新任务列表数据（所有轮次任务都显示新备注）

**注意**：不是更新 `review_tasks` 表的字段，而是更新关联的 `learning_items` 表。

#### 3.2.2 停用学习内容功能（软删除 LearningItem）

**位置**：任务详情操作区

**UI 规格**：
- 「停用」按钮显示在操作区
- 点击后弹出确认对话框

**确认对话框**（见 0.2 决策澄清）：
- 标题：「停用该学习内容？」
- 内容：「停用后该学习内容的所有复习任务将不再出现，且不会生成后续复习轮次。是否确认停用？」
- 按钮：「取消」「确认停用」

**后端逻辑**：
1. 软删除：在 `learning_items` 表更新 `is_deleted = 1`（Dart 业务层用 isDeleted）
2. 同时写入 `deleted_at` 为当前时间戳
3. 查询时通过 `JOIN learning_items WHERE is_deleted = 0` 过滤，使关联任务不可见（不是级联删除）
4. 刷新任务列表

---

### 3.3 复习计划调整功能

#### 3.3.1 功能概述

为用户提供手动调整复习计划的能力，适应个性化学习需求：

| 功能 | 说明 |
|------|------|
| 调整后续复习日期 | 将某次复习提前或延后 |
| 增加复习轮次 | 在当前轮次基础上增加额外复习轮次 |
| 查看复习计划 | 查看该任务完整的复习计划（后续所有日期） |

#### 3.3.2 调整后续复习日期

**入口**：任务详情操作区新增「调整计划」按钮

**UI 规格**：
- 点击「调整计划」弹出底部 Sheet
- Sheet 展示该任务的后续复习计划列表
- 每条复习记录显示：轮次、计划日期、状态（待复习/已完成/已跳过）
- 每条记录提供「提前」「延后」操作按钮

**提前/延后操作约束**：
- 最小日期：明天（不能选今天或过去的日期）
- 最大日期：无硬性限制（UI 提示建议不超过1年，但不做强制拦截）
- 轮次约束：
  - 第 N 轮的日期不能早于第 N-1 轮的日期（防止逻辑歧义）
  - 第 N 轮的日期不能晚于第 N+1 轮的日期（若第 N+1 轮存在）
  - 即：新日期必须落在 [第 N-1 轮日期 + 1天, 第 N+1 轮日期 - 1天] 范围内
- 状态约束：**仅待复习（pending）状态的记录可调整**，已完成/已跳过状态不可修改

**提前/延后操作**：
- 点击后弹出日期选择器
- 日期选择器显示可选范围：明天 ~ 无限（但不提供历史日期）
- 选择日期后更新 `scheduledDate`

**交互流程**：
```
点击「调整计划」→ 展示后续复习计划列表 → 点击某条待复习记录的「提前/延后」 →
日期选择器 → 选择新日期 → 确认更新 → 刷新计划列表
```

**后端逻辑**：
1. 校验关联的 learning_item.is_deleted = 0，若已停用则返回错误
2. 找到对应的复习记录（根据 learningItemId + reviewRound，参见 4.1 新增唯一索引）
3. 校验新日期满足 4.3.2 的约束条件
4. 更新该记录的 `scheduledDate`
5. 刷新任务列表和日历数据

#### 3.3.3 增加复习轮次

**入口**：任务详情操作区或调整计划 Sheet 内

**UI 规格**：
- 「增加轮次」按钮
- 点击后弹出确认对话框，显示当前轮次和将增加的轮次
- 确认后自动计算新的复习日期（基于艾宾浩斯遗忘曲线）

**确认对话框**（见 0.3 决策澄清）：
- 标题：「增加复习轮次」
- 内容：「当前轮次为第 {N} 轮，将增加 1 轮复习。系统将自动计算新的复习日期，是否确认？」
- 按钮：「取消」「确认增加」

**后端逻辑**：
1. 校验关联的 learning_item.is_deleted = 0，若已停用则返回错误
2. 获取当前学习内容的最大复习轮次（maxRound）
3. 检查 maxRound < 10，否则返回错误提示
4. 根据艾宾浩斯遗忘曲线计算下一轮的复习日期：
   - nextRound = maxRound + 1
   - interval = intervals[nextRound - 1]  // 下标从 0 开始
   - baseDate = 最后一轮的 scheduledDate（不是学习日期）
   - nextDate = baseDate + interval 天
5. 创建新的复习任务记录（scheduledDate = nextDate，reviewRound = nextRound）
6. 刷新任务列表

**约束**：
- 最大轮次上限：10 轮
- 当前轮次 >= 10 时，禁用"增加轮次"按钮，提示"已达到最大轮次"

**艾宾浩斯间隔扩展规则**（第 6-10 轮）：
- 当前基线（v1.0）：[1, 2, 4, 7, 15]（见 lib/core/utils/ebbinghaus_utils.dart:10）
- 扩展后第 6-10 轮：30, 60, 90, 120, 180 天（新增）
- 完整间隔列表（v1.2+）：[1, 2, 4, 7, 15, 30, 60, 90, 120, 180]

> **注意**：此为算法变更，仅影响**新建学习内容**的默认复习计划。**对已存在任务/已调整日期不回算**。

**数据库约束调整**（SQLite/Drift 兼容性）：
- SQLite 不支持 DROP/ADD CONSTRAINT，需重建表
- Drift 迁移方案（推荐）：
  1. 移除 `review_tasks` 表的 review_round CHECK 约束（Drift 表定义中删除该约束）
  2. 由应用层代码控制最大轮次为 10
- 不推荐方案（需重建表）：
  1. 创建新表 `review_tasks_new`（不定义 review_round CHECK 约束）
  2. 拷贝数据：`INSERT INTO review_tasks_new SELECT * FROM review_tasks`
  3. 删除旧表：`DROP TABLE review_tasks`
  4. 重命名新表：`ALTER TABLE review_tasks_new RENAME TO review_tasks`

#### 3.3.4 查看完整复习计划

**入口**：任务详情操作区

**UI 规格**：
- 「查看计划」按钮
- 点击弹出底部 Sheet，展示该任务的所有复习记录
- 按轮次正序排列，显示每轮的日期和状态

---

## 4. 数据模型设计

### 4.1 数据库变更

根据 0.1 和 0.2 的决策，需要在 `learning_items` 表新增字段：

```sql
-- 迁移 SQL（Drift 字段名：isDeleted，数据库列名：is_deleted）
-- deleted_at 存储 Unix epoch 毫秒，与现有 createdAt/updatedAt 保持一致
ALTER TABLE learning_items ADD COLUMN is_deleted INTEGER DEFAULT 0;
ALTER TABLE learning_items ADD COLUMN deleted_at INTEGER;
```

**注意**：
- Drift 字段名：`isDeleted`
- 数据库列名：`is_deleted`
- 不是加在 `review_tasks` 表，而是加在 `learning_items` 表

**新增索引**：
```sql
-- 调整计划/增加轮次时需要定位唯一记录
CREATE UNIQUE INDEX idx_review_tasks_learning_item_round
ON review_tasks(learning_item_id, review_round);
```

### 4.2 视图实体复用

复用现有 `ReviewTaskViewEntity`，通过 join learning_items 表获取 `isDeleted` 状态：

```dart
// 任务视图实体（复用现有，通过 join 获取 isDeleted）
class ReviewTaskViewEntity {
  final int taskId;
  final int learningItemId;
  final String title;
  final String? note;
  final List<String> tags;
  final int reviewRound;
  final DateTime scheduledDate;
  final ReviewTaskStatus status;
  final DateTime? completedAt;
  final DateTime? skippedAt;
  // isDeleted（Dart 字段名）从 learning_items join 获取 is_deleted 列
}
```

### 4.3 查询过滤规则

所有涉及学习内容/任务列表的查询**必须默认过滤已删除的记录**：

```sql
-- 正确的查询示例
SELECT * FROM review_tasks rt
JOIN learning_items li ON rt.learning_item_id = li.id
WHERE li.is_deleted = 0;  -- 必须过滤
```

### 4.4 新增 UseCase

| UseCase | 用途 | 备注 |
|---------|------|------|
| `UpdateLearningItemNoteUseCase` | 更新学习内容备注 | 操作对象为 LearningItem |
| `DeactivateLearningItemUseCase` | 停用学习内容（软删除） | 操作对象为 LearningItem |
| `UndoTaskStatusUseCase` | 撤销任务状态 | 现有，保持不变 |
| `AdjustReviewDateUseCase` | 调整后续复习日期 | 定位键改为 learningItemId + reviewRound |
| `AddReviewRoundUseCase` | 增加复习轮次 | 需扩展艾宾浩斯算法支持 6-10 轮 |
| `GetReviewPlanUseCase` | 获取完整复习计划 | 现有，保持不变 |

---

## 5. 路由配置

### 5.1 路由路径

| 路径 | 页面 | 说明 |
|------|------|------|
| `/tasks` | TaskHubPage | 任务中心页面（现有） |
| `/tasks/detail/:learningItemId` | TaskDetailSheet | 任务详情底部Sheet（新增，使用 learningItemId） |

### 5.2 交互方式

- 首页：任务卡片内展开详情（不跳转页面）
- 任务中心：点击任务卡片展开操作区，或弹出底部Sheet

---

## 6. 验收标准

### 6.1 今日页面增强

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC1.1 | 首页任务卡片可点击展开，显示备注和标签 | 点击任务卡片，验证详情展开 |
| AC1.2 | 展开后的待复习任务仍显示完成/跳过按钮 | 展开待复习任务，检查按钮存在 |
| AC1.3 | 已完成任务显示撤销按钮 | 完成一条任务后展开，检查撤销按钮 |
| AC1.4 | 已跳过任务显示撤销按钮 | 跳过一条任务后展开，检查撤销按钮 |
| AC1.5 | 点击撤销弹出确认对话框 | 点击撤销按钮，验证弹窗 |
| AC1.6 | 确认撤销后任务恢复为待复习 | 确认撤销，验证状态变更 |

### 6.2 任务中心页面增强

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC2.1 | 任务详情包含编辑按钮 | 点击任务展开，检查编辑按钮 |
| AC2.2 | 点击编辑可修改备注 | 编辑备注，保存后验证更新 |
| AC2.3 | 任务详情包含停用按钮 | 点击任务展开，检查停用按钮 |
| AC2.4 | 点击停用弹出确认对话框 | 点击停用，验证弹窗内容 |
| AC2.5 | 确认停用后该学习内容的所有任务不再显示 | 停用后，验证首页/任务中心/日历都不再显示 |

### 6.3 复习计划调整

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC3.1 | 任务详情包含「调整计划」按钮 | 查看任务详情，检查按钮 |
| AC3.2 | 点击调整计划显示后续复习列表 | 点击按钮，验证列表展示 |
| AC3.3 | 可选择日期提前复习 | 选择提前，验证日期变更 |
| AC3.4 | 可选择日期延后复习 | 选择延后，验证日期变更 |
| AC3.5 | 「增加轮次」功能正常 | 增加轮次，验证新记录生成 |
| AC3.6 | 「查看计划」展示完整复习计划 | 查看计划，验证所有轮次显示 |

### 6.4 通用验收

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC4.1 | 状态变更后 Snackbar 提示用户 | 执行操作，检查提示 |
| AC4.2 | 数据变更后相关页面同步刷新 | 操作后切换页面，验证数据更新 |

### 6.5 数据模型验收

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC5.1 | 所有列表查询默认仅查询 is_deleted = 0（排除 is_deleted = 1）的学习内容 | 停用学习内容后，检查 DAO 层 SQL 包含 `WHERE learning_items.is_deleted = 0`，且首页/任务中心/日历/统计页面都不显示该学习内容的所有任务 |
| AC5.2 | 编辑备注后，所有轮次任务都显示新备注 | 编辑备注，查看不同轮次的任务卡片 |
| AC5.3 | 路由参数使用 learningItemId 可正常打开详情 | 访问 /tasks/detail/1，验证页面正常显示 |
| AC5.4 | 已停用的学习内容禁用撤销/调整计划/增加轮次/编辑备注/停用按钮 | 停用后打开详情，验证操作按钮（撤销、调整计划、增加轮次、编辑备注、停用）全部被禁用或隐藏 |

### 6.6 复习计划约束验收

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC6.1 | 调整日期时不能早于第 N-1 轮 | 尝试将第 3 轮调到第 2 轮之前，验证被阻止 |
| AC6.2 | 调整日期时不能晚于第 N+1 轮（若存在） | 尝试将第 3 轮调到第 4 轮之后，验证被阻止 |
| AC6.3 | 只能调整 pending 状态的任务 | 尝试调整已完成/已跳过任务，验证按钮禁用 |
| AC6.4 | 轮次达到 10 轮时禁用增加轮次 | 增加轮次到 10 轮后，验证按钮禁用并提示 |

---

## 7. 优先级与排期

| 优先级 | 功能 | 说明 |
|--------|------|------|
| P0 | 今日页面任务展开详情 | 解决 P1 核心痛点 |
| P0 | 今日页面撤销功能 | 解决 P2 核心痛点 |
| P0 | 任务中心编辑学习内容备注 | 解决 P3 |
| P0 | 任务中心停用学习内容 | 解决 P4 |
| P1 | 调整复习日期 | 解决 P5 |
| P1 | 增加复习轮次 | 解决 P6 |
| P2 | 查看完整复习计划 | 辅助功能 |

---

## 8. 附录

### 8.1 相关文件

- 首页实现：`lib/presentation/pages/home/home_page.dart`
- 任务中心：`lib/presentation/pages/tasks/task_hub_page.dart`
- 学习内容表：`lib/data/database/tables/learning_items_table.dart`
- 复习任务表：`lib/data/database/tables/review_tasks_table.dart`
- 任务实体：`lib/domain/entities/review_task.dart`
- 路由配置：`lib/infrastructure/router/app_router.dart`
- 艾宾浩斯算法：`lib/core/utils/ebbinghaus_utils.dart`

### 8.2 术语表

| 术语 | 定义 |
|------|------|
| 软删除 | 不物理删除数据，而是标记 is_deleted = 1（Dart 层 isDeleted），查询时过滤 |
| 复习轮次 | 任务的第 N 次复习，每轮根据艾宾浩斯曲线计算日期 |
| 调整计划 | 手动修改某次复习的日期 |
| 增加轮次 | 在当前轮次基础上新增一轮复习 |

### 8.3 修订历史

| 版本 | 日期 | 修订内容 |
|------|------|----------|
| v1.0 | 2026-02-28 | 初始版本 |
| v1.1 | 2026-02-28 | 新增设计决策澄清章节（0.1-0.4），明确：编辑备注对象为 LearningItem、删除语义为停用 LearningItem、最大轮次上限 10、路由参数用 learningItemId；补充撤销副作用规则、调整计划约束（补充第 N 轮不能晚于第 N+1 轮）、数据模型变更（字段加在 learning_items 表 + 迁移SQL + 新增唯一索引）、查询过滤规则、验收用例；修正 TaskHubPage 文件路径；补充艾宾浩斯第 6-10 轮间隔列表；统一 Drift 字段名 isDeleted 与数据库列名 is_deleted |
| v1.2 | 2026-02-28 | 文案统一为"停用学习内容"；修正外键级联表述为 join+过滤；调整计划定位键改为 learningItemId+reviewRound；补充复习计划约束验收用例（AC6.1-AC6.4）；补充已停用时禁用操作的边界验收 |
| v1.3 | 2026-02-28 | 修正验收标准 AC5.1 描述为"仅查询 is_deleted=0"；删除不可用的 DROP/ADD CONSTRAINT 示例；修正 0.2 语义为"关联任务通过过滤不可见"；补充停用后禁用编辑备注/停用按钮验收；补充算法变更影响范围"仅影响新建学习内容"；补充增加轮次日期计算方式为"最后一轮 scheduledDate+间隔"；修正修订历史 v1.3 条目文字 |
| v1.4 | 2026-02-28 | 明确统计口径采用方案A（实时按当前状态聚合）；补充路由访问边界处理（空态/已停用只读/正常）；简化增加轮次变量名（nextRound/interval/nextDate）；撤销/调整计划/增加轮次接口补充校验 is_deleted=0；补充 Drift 迁移推荐方案（移除 CHECK 约束，应用层控制） |
