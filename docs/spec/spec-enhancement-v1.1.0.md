# 忆刻（YiKe）体验增强迭代 - 规格文档

**版本**: v1.1.0
**日期**: 2026-03-01
**状态**: 规划中

---

## 一、概述

本文档描述忆刻（YiKe）应用的体验增强迭代，主要包含三个方向的优化：
1. 首页体验优化
2. 复习体验增强
3. 交互细节完善

---

## 二、术语与口径定义

为确保实现一致性，明确以下核心术语的判定口径：

| 术语 | 定义 | 判定口径 |
|------|------|----------|
| **任务（ReviewTask）** | 一次具体的复习行为记录 | 对应 review_tasks 表单条记录 |
| **学习内容（LearningItem）** | 用户添加的待复习内容 | 对应 learning_items 表单条记录 |
| **轮次（ReviewRound）** | 艾宾浩斯遗忘曲线的第N轮复习 | 从1开始，最大值为配置的最大轮次数 |
| **下次复习** | 当前任务完成后下一次复习的时间 | 以下一轮任务的 scheduledDate 为准 |
| **今日任务已完成** | 当天的复习任务全部完成 | 以 scheduledDate = 今日 且 状态为 done 为准 |
| **完成率** | 完成任务数 / 应完成任务数 | 进度环按 scheduledDate 统计：done / (done + pending)，跳过不计入 total |

> 注：
> - 内部状态码使用 `done`（对应现有代码），展示文案用「已完成」
> - 进度环口径：按 scheduledDate 统计 done/(done+pending)，跳过不计入 total

---

## 三、范围与非目标

### 3.1 范围定义

本次迭代为**纯体验优化**，具体范围如下：

**允许的变更：**
- Presentation 层引入临时 UI 状态（如 `removingIds` Set 用于动画期间临时隐藏任务）
- 为列表中的任务批量查询补充展示字段（如下一轮复习日期）
- 新增 UI 组件和交互状态
- 调整动效参数

**不属于本次迭代：**
- 修改 Domain 层业务规则
- 修改数据库表结构
- 修改现有 API 接口签名

### 3.2 非目标

以下功能明确不在本版本范围内：
- 标签管理完整闭环（创建/编辑/删除标签）- 仅提供查看入口
- 拖拽排序
- 快速回顾模式
- 全局搜索扩展

---

## 四、交互优先级（冲突处理）

为确保交互一致性，明确各操作之间的优先级关系：

| 模式 | 点击 | 长按 | 左滑 | 右键 |
|------|------|------|------|------|
| **普通模式** | 展开详情/选择 | 快捷菜单 | 完成/跳过 | 快捷菜单 |
| **批量选择模式** | 勾选（仅选择模式特有） | 禁用 | 禁用 | 禁用 |

> 规则：
> - 批量选择模式（selectionMode=true）优先级最高：点击=勾选；长按/右键菜单禁用；左滑禁用
> - 非批量模式：点击=展开详情；长按/右键=快捷菜单；左滑=完成/跳过（仅 pending 状态）
> - done/skipped 状态任务：左滑禁用，菜单项显示「撤销」而非「完成/跳过」

---

## 五、失败与回滚策略

对所有任务操作（完成/跳过/撤销）统一采用**操作先行策略**：

### 5.1 操作成功时
1. **先执行数据操作**：调用 completeTask/skipTask
2. **操作成功后刷新列表**：reload provider
3. **播放动效**（可选，作为纯视觉反馈）：
   - 按钮/菜单触发：缩放淡出（仅视觉，不影响数据）
   - 左滑 Dismissible：保持原生滑出效果

### 5.2 操作失败时
1. **不刷新列表**：保持当前列表状态
2. **显示错误提示**：`SnackBar` 显示「操作失败，请重试」
3. **允许重试**：用户可再次点击操作
4. **不播放动效**：失败时不播放任何移除动画

> 采用「操作先行」策略确保失败时列表状态一致，避免「任务消失但未成功」的问题

---

## 六、功能规格

### 6.1 任务长按快捷菜单

#### 功能描述
用户长按首页任务卡片时，弹出上下文快捷菜单，提供常用操作的快速入口。

#### 触发条件
- 非选择模式下：长按任意任务卡片
- 任务状态为 pending / done / skipped

#### 禁用条件
- **选择模式（批量操作）下禁用**：选择模式下点击用于勾选，长按不弹菜单避免误操作
- 首页右上角进入批量选择后，所有任务卡片的 Dismissible 也应禁用滑动
- 桌面端长按非习惯操作，支持右键替代

#### 失败反馈
- 数据库操作失败时：显示 SnackBar 提示「操作失败，请重试」，任务状态保持不变（见第五章统一策略）

#### 菜单项状态矩阵

| 任务状态 | 菜单项1 | 菜单项2 | 菜单项3 |
|----------|---------|---------|---------|
| **pending** | ✓ 完成 | ⏭ 跳过 | 👁 查看详情 |
| **done** | ↩️ 撤销 | 👁 查看详情 | - |
| **skipped** | ↩️ 撤销 | 👁 查看详情 | - |

> 注：
> - 「管理标签」因涉及完整标签编辑闭环，本版本改为「查看详情」（跳转到详情页），不单独实现标签菜单项
> - 「撤销」调用现有 undoTaskStatus，用法已有

#### 桌面端支持
- 支持右键（SecondaryTap）触发同一菜单
- 在 Windows/macOS 上右键点击任务卡片等效于长按

#### 技术实现
- **新增文件**: `lib/presentation/widgets/task_context_menu.dart`
- **使用组件**: `showMenu` + `PopupMenuItem`
- **触发方式**: `GestureDetector` 的 `onLongPressStart` + `onSecondaryTapStart`

---

### 6.2 空状态引导增强

#### 功能描述
当首页无任务时，显示引导用户添加学习内容的提示和快捷入口。

#### 触发条件
- 待复习列表为空时显示（今日待复习 + 逾期 + 全部 tab 下 itemsListView 为空）
- 判定时机：home_tasks_provider 加载完成后

#### 禁用条件
- 非首页路由（如日历页、专题页）

#### 失败反馈
- 路由跳转失败时：Flutter 默认行为

#### 空状态分层

| 场景 | 判定条件 | 显示文案 | CTA 按钮 |
|------|----------|----------|----------|
| **常规空态** | 待复习列表为空 AND 全库学习内容 > 0 | 「今日任务已完成！」 | 「＋添加学习内容」 |
| **冷启动** | 全库学习内容 = 0 | 「还没有任何学习内容」 | 「＋添加学习内容」 |

#### CTA 跳转目标（写死）
- 「＋添加学习内容」→ `/input`
- 「或创建学习专题」→ `/topics`

#### 技术实现
- **修改文件**: `lib/presentation/pages/home/home_page.dart` - `_EmptyState` 组件
- **使用组件**: `GlassCard` + `FilledButton` + `TextButton`
- **数据获取**: 在 home_tasks_provider 中轻量查询全库学习内容数量（仅在列表为空时查询一次）

---

### 6.3 任务完成动画

#### 功能描述
用户完成任务时，任务卡片显示缩放+淡出的消失动画，提供视觉反馈。

#### 触发条件
- 点击任务卡片右侧「完成」按钮
- 通过长按菜单「完成」操作
- **排除**：左滑 Dismissible 完成的操作（保持原生滑出效果即可，避免动效叠加）

#### 禁用条件
- 系统开启「减少动态效果」（`MediaQuery.of(context).disableAnimations` 为 true）
- 选择模式（批量操作模式）
- 任务状态为 done / skipped（已完成任务不可重复完成）

#### 失败反馈
- 数据库操作失败时：动画不播放，SnackBar 提示「操作失败，请重试」，任务状态保持不变

#### 动画与数据刷新时序（必须遵守）

```
用户点击完成 → 1. 调用 completeTask → 2. 操作成功后 reload → 3. 播放缩放淡出动画(250ms)
```

> 关键点：采用操作先行策略，先执行数据操作，成功后再播放动画。若数据操作失败，不播放动画，任务保持不变。

#### 动画参数
- **动画时长**: 250ms（符合微交互最佳实践，上限不超过 300ms）
- **动画效果**:
  - 缩放: 1.0 → 1.15 → 消失
  - 透明度: 1.0 → 0.0
  - 曲线: `Curves.easeOut`
- **无障碍降级**: 系统减少动效时，时长设为 0 或直接跳过

#### 与左滑动画的关系
- 左滑 Dismissible 本身有滑出移除动效
- 缩放淡出动效**仅用于按钮/菜单触发的完成操作**
- 左滑保持原生滑出效果，不叠加缩放淡出

#### 技术实现
- **新增文件**: `lib/presentation/widgets/completion_animation.dart`
- **使用组件**: `AnimationController` + `Tween<double>`
- **状态管理**: 在 HomePage 中维护 `removingTaskIds` Set<int>（任务ID为int类型）

---

### 6.4 进度环动画增强

#### 功能描述
首页顶部进度环在数值变化时显示平滑的过渡动画。

#### 触发条件
- 首页进度环数值变化时（完成/跳过任务后）

#### 禁用条件
- 系统开启「减少动态效果」
- 首次加载（从无数据到有数据，不动画）

#### 失败反馈
- 无（纯 UI 动效）

#### 动画参数
- **动画时长**: 300ms
- **动画效果**: 环形进度与数值文本同步过渡
- **曲线**: `Curves.easeOutCubic`
- **无障碍降级**: 系统减少动效时，直接跳变

#### 实现建议
- **允许隐式动画实现**（如 `TweenAnimationBuilder`），不绑死 didUpdateWidget + AnimationController
- **数值文本必须同步过渡**：环形进度与百分比文本同时变化，不要环动了数字不动
- **性能预算**：滚动/刷新时保持 60fps；动效区域加 RepaintBoundary 避免整卡重绘

#### 技术实现
- **修改文件**: `lib/presentation/widgets/review_progress.dart`
- **关键点**: `CircularProgressIndicator` 与 `Text` 数值同步动画

---

### 6.5 左滑快捷操作增强

#### 功能描述
现有左滑完成/跳过操作的视觉反馈增强。

#### 触发条件
- 非选择模式下：左滑任务卡片
- 任务状态为 pending

#### 禁用条件
- **选择模式下禁用**：进入批量选择后，不为任务卡片包裹 Dismissible
- 任务状态为 done / skipped 时：不包裹 Dismissible（左滑无效）

#### 失败反馈
- 数据库操作失败时：任务卡片从「已完成」状态回弹（保持可见），SnackBar 提示「操作失败，请重试」

#### UI 增强
- **阈值**: 保持默认 0.4（当前即是如此，若需更灵敏可设为 0.35）
- **振动反馈**:
  - 仅在「确定触发完成/跳过」时给一次（松手确认时触发，即 confirmDismiss 回调中）
  - 使用 `HapticFeedback.lightImpact()`
  - 系统减少动效时禁用触觉反馈
- **现有背景保持不变**: `_SwipeBackground` 已实现半透明背景+图标+文字

#### 验收点
- 滑动过程中不振动（避免频繁触发）
- 仅在松手确认时振动一次
- 达到阈值时背景提示有视觉变化（已实现）

#### 技术实现
- **修改文件**: `lib/presentation/pages/home/home_page.dart`
- **关键实现**: 在 `Dismissible` 的 `confirmDismiss` 回调中添加振动反馈（松手确认时触发）
- **选择模式联动**: 批量选择进入时，条件性不包裹 Dismissible（参考现有 `if (selectionMode || status != pending) return card;` 结构）

---

### 6.6 复习间隔预览增强

#### 功能描述
在任务卡片上显示下次复习的时间间隔，让用户了解复习节奏。

#### 触发条件
- 任务状态为 done 或 skipped 时
- 该学习内容存在下一轮复习任务
- 下一轮复习任务未被禁用

#### 禁用条件
- 任务状态为 pending
- 该学习内容已完成全部复习轮次（当前轮次 = 最大轮次）
- 下一轮复习任务被手动禁用
- 选择模式下隐藏（避免干扰批量操作视觉）

#### 失败反馈
- 无（纯展示信息）

#### UI 设计
在已完成任务卡片底部显示：
```
下次复习：3天后（第2轮）
```
或
```
本内容已完成全部轮次
```

#### 展示口径（必须遵守）

**以下一轮任务的 scheduledDate 为准**：
- 查询同一 learningItemId 的下一轮（reviewRound + 1）任务
- 若下一轮任务不存在：显示「本内容已完成全部轮次」
- 若复习计划被手动调整：显示调整后的实际日期
- **不使用「预计」口径**，避免与自定义间隔/调整计划冲突产生信任问题

#### 实现策略（推荐策略 A）

**策略 A（推荐）- 准确数据：**
- 在 `home_tasks_provider` 加载任务列表时，为出现的 learningItemId 批量查询下一轮任务日期
- 缓存成 `Map<int, DateTime?>`（key 为 learningItemId）
- 传递给任务卡片组件

**策略 B（不推荐）- 预计口径：**
- 仅基于默认艾宾浩斯间隔推算
- UI 明确标注「预计」字样

#### 技术实现
- **修改文件**:
  - `lib/presentation/providers/home_tasks_provider.dart` - 批量查询下一轮日期
  - `lib/presentation/pages/home/home_page.dart` - 任务卡片显示
- **数据流**: 使用 `Map<int, DateTime?>` 存储 learningItemId -> nextScheduledDate，不修改 ReviewTaskViewEntity 实体

---

## 七、关键文件清单

| 序号 | 文件路径 | 操作类型 | 说明 |
|------|----------|----------|------|
| 1 | `lib/presentation/pages/home/home_page.dart` | 修改 | 空状态、滑动操作、长按菜单集成、选择模式联动 |
| 2 | `lib/presentation/widgets/task_context_menu.dart` | 新增 | 任务快捷菜单组件 |
| 3 | `lib/presentation/widgets/completion_animation.dart` | 新增 | 完成动画组件 |
| 4 | `lib/presentation/widgets/review_progress.dart` | 修改 | 进度环动画增强 |
| 5 | `lib/presentation/providers/home_tasks_provider.dart` | 修改 | 批量查询下一轮日期、可能需要扩展方法 |

---

## 八、回归范围

本次迭代可能影响的现有页面/组件：

| 页面/组件 | 影响范围 |
|-----------|----------|
| 首页（/home） | 核心影响：任务卡片、长按菜单、空状态、进度环 |
| 任务详情弹窗（/tasks/detail/:learningItemId） | 无影响 |
| 任务中心（all tab） | 与首页共享数据源，需验证 all tab 下行为一致 |
| 日历页（/calendar） | 无影响 |
| 专题页（/topics） | 无影响 |

---

## 九、验收标准

### 9.1 功能验收用例

#### 用例 1：普通模式下长按菜单
| 项目 | 内容 |
|------|------|
| **前置数据** | 首页有待复习任务（pending 状态） |
| **操作步骤** | 1. 长按任务卡片 2. 点击「完成」 |
| **期望 UI** | 弹出菜单 → 卡片缩放淡出 → 消失 |
| **期望数据变化** | 任务状态变为 done |
| **失败提示** | 「操作失败，请重试」 |

#### 用例 2：已完成任务长按菜单
| 项目 | 内容 |
|------|------|
| **前置数据** | 首页有已完成任务（done 状态） |
| **操作步骤** | 长按已完成任务卡片 |
| **期望 UI** | 弹出菜单显示「撤销」「查看详情」（无「完成」「跳过」） |

#### 用例 3：批量选择模式交互
| 项目 | 内容 |
|------|------|
| **前置数据** | 首页有待复习任务 |
| **操作步骤** | 1. 点击右上角进入批量选择 2. 长按任务卡片 3. 左滑任务卡片 |
| **期望 UI** | 长按无反应 / 不弹菜单；左滑无反应 / 卡片不移动 |
| **期望数据变化** | 无 |

#### 用例 4：空状态引导 - 常规
| 项目 | 内容 |
|------|------|
| **前置数据** | 全库有学习内容，但今日无待复习任务 |
| **操作步骤** | 进入首页 |
| **期望 UI** | 显示「今日任务已完成！」+ 添加学习内容按钮 |

#### 用例 5：空状态引导 - 冷启动
| 项目 | 内容 |
|------|------|
| **前置数据** | 全库学习内容数量为 0 |
| **操作步骤** | 进入首页 |
| **期望 UI** | 显示「还没有任何学习内容」+ 添加学习内容按钮 |

#### 用例 6：完成操作失败回滚
| 项目 | 内容 |
|------|------|
| **前置数据** | 首页有待复习任务 |
| **操作步骤** | 点击完成按钮 → 模拟数据库失败 |
| **期望 UI** | 任务保持可见 → SnackBar 显示「操作失败，请重试」 |
| **期望数据变化** | 任务状态保持 pending（未改变） |

#### 用例 7：进度环动画
| 项目 | 内容 |
|------|------|
| **前置数据** | 首页有 10 个待复习任务，0 个已完成 |
| **操作步骤** | 完成 1 个任务 |
| **期望 UI** | 进度环从 0/10 平滑过渡到 1/10（环形+数字同步） |
| **期望数据变化** | 完成数从 0 变为 1 |

#### 用例 8：左滑操作 - 选择模式禁用
| 项目 | 内容 |
|------|------|
| **前置数据** | 首页有待复习任务，已进入批量选择模式 |
| **操作步骤** | 左滑任意任务卡片 |
| **期望 UI** | 卡片不移动，无任何反馈 |

#### 用例 9：复习间隔预览 - 最后一轮
| 项目 | 内容 |
|------|------|
| **前置数据** | 学习内容已完成全部复习轮次 |
| **操作步骤** | 查看已完成任务的卡片 |
| **期望 UI** | 显示「本内容已完成全部轮次」或隐藏下次复习行 |

#### 用例 10：减少动效模式
| 项目 | 内容 |
|------|------|
| **前置数据** | 系统开启「减少动态效果」 |
| **操作步骤** | 完成任务 |
| **期望 UI** | 无缩放淡出动画；进度环数值直接跳变 |

### 9.2 视觉验收
- [ ] 空状态使用激励性图标和文案
- [ ] 动画流畅无卡顿（60fps）
- [ ] 振动反馈适度不过度
- [ ] 配色与现有主题一致

### 9.3 无障碍验收
- [ ] 系统开启「减少动态效果」时，所有动画时长为 0 或直接跳过
- [ ] 选择模式下长按菜单禁用、Dismissible 禁用
- [ ] 振动反馈遵循系统减少动效设置

### 9.4 交互一致性验收
- [ ] 桌面端右键（secondary tap）可触发菜单
- [ ] 任务状态与菜单项正确匹配（pending vs done/skipped）
- [ ] 进度环与数值文本同步过渡

---

## 十、里程碑

| 阶段 | 内容 | 预计工时 | 依赖项 |
|------|------|----------|--------|
| 阶段一 | 交互细节完善（长按菜单、空状态） | 2小时 | 需要确认「管理标签」是否延期 |
| 阶段二 | 首页体验优化（完成动画、进度环、左滑增强） | 2.5小时 | 阶段一完成后开始 |
| 阶段三 | 复习体验增强（复习间隔预览） | 1.5小时 | 阶段一完成后开始，可能需要补数据查询 |
| 测试 | 全面测试和调优 | 2小时 | 回归范围：首页、任务中心 all tab |

> 注：
> - 2.1 长按菜单「管理标签」项若不延期，需要额外工作量补全标签编辑闭环
> - 2.6 复习间隔预览推荐策略 A，需要在 provider 中补批量查询逻辑

---

## 十一、向后兼容性

本次迭代为纯体验优化，不涉及：
- 数据结构变更
- API 变更
- 现有功能逻辑变更

所有变更均为增量添加，现有功能保持不变。

---

## 十二、参考代码位置

### 12.1 关键代码对照点

以下代码位置为实现时需要修改/参考的核心位置：

| 功能 | 文件路径 | 行号 | 说明 |
|------|----------|------|------|
| 任务卡片组件 | `lib/presentation/pages/home/home_page.dart` | ~1031 | `_TaskCard` 组件，长按/点击入口 |
| 左滑 Dismissible | `lib/presentation/pages/home/home_page.dart` | ~1323 | 滑动完成/跳过实现 |
| 左滑背景 | `lib/presentation/pages/home/home_page.dart` | ~1461 | `_SwipeBackground` 背景提示 |
| 空状态组件 | `lib/presentation/pages/home/home_page.dart` | ~1551 | `_EmptyState` 现有空状态 |
| 进度环组件 | `lib/presentation/widgets/review_progress.dart` | ~130 | `CircularProgressIndicator(value: progress)` |
| 今日进度刷新 | `lib/presentation/providers/today_progress_provider.dart` | ~16 | 监听 homeTasksProvider 统计字段 |
| 任务详情路由 | `lib/infrastructure/router/app_router.dart` | ~73 | `/tasks/detail/:learningItemId` |
| 系统减少动效检测 | `lib/app.dart` | ~35 | `MediaQuery.of(context).disableAnimations` |

### 12.2 技术实现参考

- **系统减少动效检测**: 使用 `MediaQuery.of(context).disableAnimations` 判断是否开启无障碍模式
- **Dismissible 禁用**: 条件性不包裹 Dismissible，参考现有结构 `if (selectionMode || status != pending) return card;`
- **动画控制器**: 使用 `AnimationController` + `Tween<double>` 实现缩放淡出
- **批量查询**: 在 provider 层使用 `whereIn` 一次性查询多个 ID

### 12.3 现有实现约束

- **状态枚举**: 使用 `pending/done/skipped`（对应代码）
- **左滑阈值**: Dismissible 默认阈值为 0.4，当前代码未显式配置
- **进度环统计**: 按 scheduledDate 统计 done/(done+pending)
- **撤销功能**: 使用现有 `undoTaskStatus`，已实现
