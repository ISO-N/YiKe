# 规格变更文档 - 备份恢复功能

## 文档信息

- 用途：记录备份恢复功能的产品需求与规格定义
- 作者：YiKe 团队
- 创建日期：2026-02-28
- 变更类型：新功能
- 版本：v1.5

---

## 1. 背景与目标

### 1.1 需求背景

用户在日常使用中可能面临以下场景：

- 更换设备：需要将学习数据迁移到新手机
- 数据备份：担心数据丢失，希望定期备份
- 误操作恢复：误删除学习内容后希望恢复
- 数据迁移：需要在不同平台间迁移数据（如 Android → iOS）

### 1.2 目标

提供完整的备份恢复能力，确保用户数据安全性和可迁移性。

### 1.3 非目标与约束

为避免实现期反复扯皮，明确以下非目标：

**不包含：**
- 账号体系与云同步（与"本地备份"功能区分）
- 跨账号数据合并
- 端到端加密（注：密码保护为可选扩展功能 P2）
- **跨平台导入保证**（Android ↔ iOS 互导不作为 v1 必保项）

**不保证：**
- 导入后与原设备完全一致的通知ID（通知ID需重新生成）
- 系统权限状态（如通知开关、存储权限等需用户手动设置）

**数据口径：**
- 仅备份"用户可见且可编辑的数据 + 必要的派生重建信息"
- 其余数据（如通知记录、缓存）可由应用自行重建

---

## 2. 功能概述

### 2.1 核心功能

| 功能 | 说明 |
|------|------|
| 数据导出 | 将全部学习数据导出为备份文件（JSON 格式） |
| 数据导入 | 从备份文件恢复数据到应用 |
| 备份管理 | 查看备份历史、删除旧备份 |

> **注**：增量备份、自动备份、密码保护等功能作为后续扩展（详见第 10 节）。

### 2.2 导出数据范围

备份文件应包含以下数据：

| 数据类型 | 说明 |
|----------|------|
| 学习内容 | learning_items 表全部数据 |
| 复习任务 | review_tasks 表全部数据 |
| 用户设置 | app_settings 表数据 |
| 学习记录 | review_records 表数据 |

### 2.3 备份存储策略

**统一策略：应用托管备份 + 外部导出**

为解决"备份历史"与"用户自选位置"的矛盾，采用以下流程：

| 步骤 | 路径 | 管理方式 |
|------|------|----------|
| 1. 默认导出 | 应用私有目录 | 纳入备份历史，可枚举、可删除 |
| 2. 可选：另存为 | 外部目录（系统文件选择器） | 不纳入备份历史 |

**实现规则：**
1. 用户点击"导出备份"时，默认保存到应用私有目录（纳入备份历史）
2. 导出成功后，提供"分享/另存为…"按钮，允许用户导出到任意目录（不纳入备份历史）
3. 只有在用户主动点击"另存为"时才弹出系统文件保存选择器
4. 备份历史仅展示应用托管的备份记录

---

### 2.4 不导出数据

| 数据类型 | 说明 |
|----------|------|
| 通知记录 | 避免通知ID冲突 |
| 缓存数据 | 无需备份的临时数据 |

---

## 3. 技术方案

### 3.1 备份文件格式

- 格式：JSON
- 编码：UTF-8
- 文件扩展名：`.yikebackup`
- 文件名格式：`yike_backup_YYYYMMDD_HHmmss.yikebackup`

### 3.2 备份文件结构

```json
{
  "schemaVersion": "1.0",
  "appVersion": "1.5.0",
  "dbSchemaVersion": 5,
  "backupId": "550e8400-e29b-41d4-a716-446655440000",
  "createdAt": "2026-02-28T10:30:00+08:00",
  "createdAtUtc": "2026-02-28T02:30:00Z",
  "checksum": "sha256:abc123...",
  "stats": {
    "learningItems": 100,
    "reviewTasks": 500,
    "reviewRecords": 2000,
    "payloadSize": 524288
  },
  "data": {
    "learningItems": [...],
    "reviewTasks": [...],
    "reviewRecords": [...],
    "settings": {...}
  }
}
```

**字段说明：**

| 字段 | 类型 | 说明 |
|------|------|------|
| schemaVersion | string | 备份格式版本（与产品版本区分） |
| appVersion | string | 产品版本号 |
| dbSchemaVersion | int | 数据库 schema 版本（仅用于诊断/埋点，不作为导入阻断条件） |
| backupId | string | UUID（用于导入记录追踪，唯一标识一次备份） |
| createdAt | string | 本地时间（带时区，用于展示） |
| createdAtUtc | string | UTC 时间（用于跨时区一致性） |
| checksum | string | SHA-256 校验和（对 data 字段的 JSON 字符串计算，不含 checksum 本身） |
| stats | object | 各表数据条数与 data 字段规范化后的字节长度（用于预览） |

**Checksum 计算规则：**
1. 序列化 `data` 字段为规范的 JSON 字符串
   - **键按字母排序**（递归处理所有嵌套对象）
   - **数组内元素按 uuid 排序**（确保相同数据导出顺序一致）
   - 无额外空白
2. 对该字符串计算 SHA-256
3. 结果格式为 `sha256:<hex>`

**重复导入检测：**
- `backupId`：用于本机检测"是否已导入过该备份"
- `checksum`：用于检测"同文件重复导入"（文件内容未变）

**解析策略：**
- 缺字段：使用默认值
- 未知字段：**忽略**（向前兼容）
- 校验失败：提示文件已损坏，不执行导入

**文件扩展名说明：**
- `.yikebackup` 为约定扩展名
- 内容为 UTF-8 编码的 JSON
- 若未来需加密/压缩，可考虑改为容器格式（如 zip）

### 3.3 数据表对应

| 业务数据 | 数据库表 |
|----------|----------|
| 学习内容 | learning_items |
| 复习任务 | review_tasks |
| 复习记录 | review_records |
| 用户设置 | app_settings |

### 3.4 模块设计

```
lib/
├── core/
│   └── utils/
│       └── backup_utils.dart      # 备份/恢复工具类
│
├── data/
│   ├── database/
│   │   └── backup_dao.dart       # 备份数据访问
│   └── repositories/
│       └── backup_repository_impl.dart # 备份仓储实现（区分 domain 层）
│
├── domain/
│   ├── repositories/
│   │   └── backup_repository.dart # 备份仓储接口
│   └── usecases/
│       ├── export_data_usecase.dart   # 导出数据用例
│       ├── import_data_usecase.dart  # 导入数据用例
│       └── get_backup_list_usecase.dart # 获取备份列表用例
│
├── infrastructure/
│   └── storage/
│       └── backup_storage.dart    # 文件系统操作
│
└── presentation/
    └── pages/
        └── settings/
            └── backup_page.dart   # 备份设置页面
```

---

## 4. 详细设计

### 4.1 导出流程

```
用户点击"导出备份"
    ↓
执行 ExportDataUseCase
    ↓
读取数据库各表数据
    ↓
生成 backupId（UUID）
    ↓
组装 JSON 结构，计算 checksum
    ↓
写入应用私有目录（备份历史）
    ↓
返回成功，结果包含"分享/另存为"入口
    ↓
用户可选择"另存为"导出到外部（不纳入备份历史）
```

**默认路径**：导出到应用私有目录 → 进入备份历史
**可选路径**：成功后点击"另存为" → 弹出系统文件选择器 → 导出到外部

### 4.2 导入流程

```
用户点击"导入备份"
    ↓
选择备份文件（系统文件选择器）
    ↓
解析 JSON 文件，校验 checksum
    ↓
校验文件格式和版本兼容性
    ↓
显示数据预览（条数、版本、备份时间）
    ↓
选择合并策略（覆盖/合并）
    ↓
【覆盖策略】二次确认：提示将删除 N 条数据、不可撤销
    ↓
【覆盖策略】自动创建导入前快照
    ↓
执行 ImportDataUseCase（事务保护）
    ↓
写入数据库（写入顺序：items → tasks → records → settings）
    ↓
重新调度本地通知（根据新的 review_tasks）
    ↓
清理/重建缓存与派生索引
    ↓
刷新应用状态
    ↓
返回成功/失败结果
```

**覆盖导入安全保护：**
- 执行覆盖导入前自动创建快照备份
- 覆盖导入需要**二次确认**，明确提示将删除多少条数据
- 失败时可从快照一键回滚

### 4.3 合并策略与快照

#### 4.3.1 合并策略（v1 确定）

**v1 采用方案A：合并 = Upsert（存在则更新，不存在则插入）**

| 策略 | 定义 |
|------|------|
| 覆盖 | 清空全部现有数据（创建快照），再导入备份数据 |
| 合并 | 按 uuid Upsert（存在则更新，不存在则插入） |

**默认**：使用"合并"策略，避免用户误操作导致数据丢失。

#### 4.3.2 冲突处理规则（与 4.5.2 保持一致）

| 表 | 去重依据 | 冲突处理 | 不覆盖字段 |
|----|----------|----------|------------|
| learning_items | uuid | 存在则更新（以备份数据为准） | `id`, `created_at` |
| review_tasks | uuid | 存在则更新（以备份数据为准） | `id`, `learning_item_id`, `created_at` |
| review_records | uuid | **存在则跳过**（records 不可变） | - |
| app_settings | key | 主题/语言覆盖；通知类不导入 | - |

> **说明**：
> - learning_items/review_tasks：允许 Upsert（内容不同是正常的"更新"）
> - review_records：定义为**不可变**，同 uuid 不同内容 = 异常，中止导入

#### 4.3.3 导入前快照

- **快照格式**：与普通备份文件格式一致（可复用导入流程）
- **保留策略**：仅保留最近 **1 份**快照（覆盖式）
- **存储位置**：应用私有目录的 `snapshots/` 子目录
- **回滚入口**：
  - 导入失败弹窗中提供"恢复快照"按钮
  - 备份历史页面提供"从快照恢复"入口（需二次确认）

### 4.4 版本兼容性

**规则定义**：
- `schemaVersion`：决定能否导入（格式兼容）
- `appVersion`：用于展示
- `dbSchemaVersion`：仅用于诊断/埋点，**不作为导入阻断条件**

**可执行规则**：
1. **最小可导入版本**：`schemaVersion >= 1.0`（v1 的最小版本）
2. **向上兼容**：旧备份文件（schemaVersion 1.0）可导入新版本应用
3. **向下兼容**：新备份文件（schemaVersion > 1.0）导入旧版本应用时提示"备份文件版本过高，无法导入"

**缺字段/旧字段默认值策略**：
| 场景 | 处理方式 |
|------|----------|
| 缺 schemaVersion | 使用默认值 "1.0"（允许导入） |
| 缺 backupId | 自动生成 UUID（允许导入） |
| 缺 stats.* | 使用 0（允许导入） |
| 未知字段 | **忽略**（允许导入） |

### 4.5 数据一致性与冲突处理

**核心挑战：** ID 冲突与关系保持（learning_items ↔ review_tasks ↔ review_records）

#### 4.5.1 主键策略

- **v1 必选**：为以下核心实体增加稳定的 `uuid` 字段作为"合并去重的业务主键"
  - `learning_items` 表：新增 `uuid` 列（NOT NULL, **唯一约束**）
  - `review_tasks` 表：新增 `uuid` 列（NOT NULL, **唯一约束**）
  - `review_records` 表：新增 `uuid` 列（NOT NULL, **唯一约束**）

- **Drift 迁移策略**：
  1. 新增 `uuid` 列为 TEXT 类型
  2. 回填：使用 `Uuid.v4()` 为现有记录生成 uuid
  3. 添加唯一约束
  4. 新增记录时自动生成 uuid

- **导出/导入以 uuid 关联**
- 数据库内部自增 ID 保留，用于外键关联

> **备选方案（若短期无法加 uuid）**：合并=追加模式，可能产生重复数据，需在 UI 做强提示"合并可能产生重复数据"

#### 4.5.2 合并去重规则

> **注**：以下规则与 4.3.2 保持一致

| 表 | 去重依据 | 冲突处理策略 | 不覆盖字段 |
|----|----------|--------------|------------|
| learning_items | uuid | 存在则更新（以备份数据为准） | `id`, `created_at` |
| review_tasks | uuid | 存在则更新（以备份数据为准） | `id`, `learning_item_id`, `created_at` |
| review_records | uuid | **存在则跳过**（records 不可变） | - |
| app_settings | key | 主题/语言覆盖；通知类不导入 | - |

**异常处理**：
- **review_records**：若同 uuid 但内容不同，定义为数据异常
- 处理方式：提示"备份文件数据异常，导入中止"，不执行覆盖

#### 4.5.3 写入顺序与映射算法

**写入顺序**：
1. learning_items（基础数据）
2. review_tasks（依赖 items 外键）
3. review_records（依赖 tasks 外键）
4. app_settings（独立表）

**导入算法（uuid → id 映射）**：

```dart
// 1. 建立映射表
Map<String, int> itemUuidToId = {};
Map<String, int> taskUuidToId = {};

// 2. 处理 learning_items
for (item in backup.items) {
  existing = db.query("learning_items", where: "uuid = ?", item.uuid);
  if (existing != null) {
    // Upsert：更新现有记录
    db.update("learning_items", item.toMap(), where: "uuid = ?", item.uuid);
    itemId = existing.id;
  } else {
    // Insert：新插入记录
    itemId = db.insert("learning_items", item.toMap());
  }
  itemUuidToId[item.uuid] = itemId;
}

// 3. 处理 review_tasks（使用 itemUuid → itemId 映射修复外键）
for (task in backup.tasks) {
  // 找到对应的 itemId
  itemId = itemUuidToId[task.itemUuid];
  taskWithFixedFk = { ...task.toMap(), "learning_item_id": itemId };

  existing = db.query("review_tasks", where: "uuid = ?", task.uuid);
  if (existing != null) {
    db.update("review_tasks", taskWithFixedFk, where: "uuid = ?", task.uuid);
    taskId = existing.id;
  } else {
    taskId = db.insert("review_tasks", taskWithFixedFk);
  }
  taskUuidToId[task.uuid] = taskId;
}

// 4. 处理 review_records（使用 taskUuid → taskId 映射修复外键）
for (record in backup.records) {
  taskId = taskUuidToId[record.taskUuid];
  recordWithFixedFk = { ...record.toMap(), "review_task_id": taskId };

  existing = db.query("review_records", where: "uuid = ?", record.uuid);
  if (existing != null) {
    // 同 uuid 不同内容：异常处理，中止导入
    if (existing.content != record.content) {
      throw Exception("备份数据异常：uuid 冲突");
    }
    db.update("review_records", recordWithFixedFk, where: "uuid = ?", record.uuid);
  } else {
    db.insert("review_records", recordWithFixedFk);
  }
}
```

#### 4.5.4 事务与回滚

- 导入过程**必须全程事务**
- 执行覆盖导入前，**自动创建导入前快照备份**（存私有目录）
- 任何阶段失败，必须回滚到导入前状态
- 提供"从快照恢复"功能

---

### 4.6 性能与内存约束

**大数据量风险：** JSON 一次性编码可能 OOM

**实现约束：**
- 导出/导入在**后台 Isolate** 执行（至少 JSON 编解码部分）
- 支持进度展示（按阶段：读取/编码/写入/校验/完成）
- 写入采用"**临时文件 + 原子替换**"方式，避免中途失败留下半文件
- 导入先做"结构校验+统计读取"，再执行 DB 写入，减少写一半失败的概率

---

## 5. 界面设计

### 5.1 备份设置入口

位置：设置页面 → 备份与恢复

### 5.2 页面布局

```
┌─────────────────────────┐
│     备份与恢复          │ ← 标题栏
├─────────────────────────┤
│                         │
│  ┌─────┐  ┌─────┐       │
│  │导出 │  │导入 │       │ ← 快捷操作按钮
│  │备份 │  │数据 │       │
│  └─────┘  └─────┘       │
│                         │
├─────────────────────────┤
│  备份历史               │ ← 区块标题
├─────────────────────────┤
│  2026-02-28 10:30      │ ← 备份记录项
│  应用 1.5.0 / 格式 1.0 │
│  删除                   │
├─────────────────────────┤
│  2026-02-20 15:00      │
│  应用 1.4.0 / 格式 1.0 │
│  删除                   │
├─────────────────────────┤
│  [导入前快照]           │ ← 快照入口（仅覆盖导入失败后可见）
│  2026-02-28 09:00      │
│  恢复                   │
└─────────────────────────┘
```

**备份记录项显示**：
- 格式：`应用 {appVersion} / 格式 {schemaVersion}`

**快照入口**：
- 仅在"覆盖导入失败后"或"存在快照"时显示
- 标识为"[导入前快照]"（纯文本，不使用特殊符号）
- 提供"恢复"按钮（需二次确认）

### 5.3 交互流程

1. **导出备份**
   - 点击"导出备份"按钮
   - 显示加载状态（数据读取中）
   - 完成后 toast 提示"备份成功"
   - 页面更新备份历史列表
   - 提供"分享"按钮（可导出到外部）

2. **另存为（可选）**
   - 点击"分享/另存为"按钮
   - 弹出系统文件保存选择器
   - 用户选择保存位置
   - 完成后 toast 提示

3. **导入备份**
   - 点击"导入数据"按钮
   - 弹出系统文件选择器
   - 用户选择 .yikebackup 文件
   - 解析文件，显示数据预览
   - 选择合并策略
   - 确认导入
   - 显示加载状态
   - 完成后刷新页面

---

## 6. 错误处理

### 6.1 导出异常

| 错误场景 | 处理方式 |
|----------|----------|
| 存储空间不足 | 提示用户"存储空间不足，请清理后重试" |
| 文件写入失败 | 提示"导出失败，请重试" |
| 数据库读取异常 | 提示"数据读取失败，请重试" |

### 6.2 导入异常

| 错误场景 | 处理方式 |
|----------|----------|
| 文件格式错误 | 提示"备份文件格式无效" |
| 版本不兼容 | 提示"备份文件版本过高，无法导入" |
| checksum 校验失败 | 提示"文件已损坏或被篡改，导入已阻止" |
| 数据解析失败 | 提示"备份文件已损坏" |
| 数据库写入失败 | 提示"数据恢复失败，请重试" |

---

## 6.3 平台差异与权限

### 6.3.1 Android

- **Android 11+ Scoped Storage**：文件访问通过系统选择器/SAF，不依赖直接路径遍历
- 备份到应用私有目录无需额外权限
- 备份到外部目录需要用户授权

### 6.3.2 iOS

- 通过 DocumentPicker 选择文件
- "备份历史可枚举外部目录"通常不可行，仅支持应用托管备份
- 需要 Info.plist 配置 Document Types

### 6.3.3 权限取消处理

- 用户取消文件选择：属于正常路径，显示"已取消"而非"失败"

---

## 7. 安全与隐私考虑

### 7.1 数据安全

- 备份文件存储在用户选择的目录（应用私有目录或外部存储）
- 不自动上传到云端（保护用户隐私）
- 建议用户将备份文件保存到安全位置（如加密网盘）

### 7.2 导入安全

- 导入前显示数据预览
- 导入前要求用户确认
- 提供数据覆盖风险提示

### 7.3 导出风险提示（v1 必选交互）

- **v1 默认明文 JSON**：导出时弹窗明确说明
  > "备份文件为明文 JSON，可能包含敏感学习内容，建议妥善保管"
- 不导出 flutter_secure_storage 中的密钥/令牌/设备标识
- 若用户选择"另存为"到外部目录，额外提示"外部文件不受应用管理，请自行保管"

### 7.4 完整性保护

- 备份文件包含 SHA-256 checksum
- 导入时校验 checksum，若不匹配提示"文件已损坏"
- 同文件重复导入时检测 checksum 并提示用户

---

## 8. 通知与派生数据重建

导入成功后，必须执行以下重建操作：

| 操作 | 说明 |
|------|------|
| 重新调度本地通知 | 根据导入后的 review_tasks 重新生成通知ID |
| 清理缓存 | 清除旧的派生缓存数据 |
| 重建索引 | 重新计算学习进度等派生信息 |

---

## 9. 验收标准（DoD）

### 9.1 功能验收

| 场景 | 验收条件 |
|------|----------|
| 覆盖导入 | 导入后数据条数与备份一致；导入失败时数据不变 |
| 合并导入 | 去重规则生效；外键关系完整；重复导入同一备份不产生重复数据 |
| 导入前快照 | 覆盖导入前自动创建快照；失败后可回滚 |
| 校验与检测 | checksum 校验失败时阻止导入；重复导入提示用户 |

### 9.2 兼容性验收

- **最小可导入版本**：schemaVersion >= 1.0（与 4.4 规则一致）
- 支持 N-1 格式版本导入（如当前 v1.0，支持 v0.9 导入）
- 缺字段使用默认值（详见 4.4 默认值策略）
- 未知字段忽略不报错

### 9.3 性能验收

| 数据量 | 导出耗时 | 导入耗时 | 内存 |
|--------|----------|----------|------|
| 1000 条 records | < 5 秒 | < 10 秒 | 不 OOM |
| 10000 条 records | < 30 秒 | < 60 秒 | 不 OOM |

### 9.4 异常路径验收

- 用户取消文件选择：显示"已取消"，不报错
- 外部导入文件不可访问：提示用户重新选择文件
- 存储空间不足：提示用户清理存储

### 9.5 可中断/可取消验收

| 场景 | 验收条件 |
|------|----------|
| 导出过程返回/切后台 | 临时文件清理；不产生半成品文件；不计入备份历史 |
| 导入过程返回/切后台 | 事务回滚；数据保持导入前状态；不留半成品 |
| 支持取消按钮 | 用户可取消导出/导入；已执行部分回滚 |

**实现约束**：
- 导出：采用"临时文件 + 原子替换"，若被中断则只有临时文件，下次启动时清理
- 导入：事务内执行，若被中断则自动回滚

### 9.6 跨平台验收（非 v1 必保）

**备份文件新增字段**（可选）：
```json
{
  "platform": "android",  // android / ios / desktop
  "deviceModel": "Pixel 7"
}
```

**导入检测与提示**：
- 导入时检测 `platform` 字段
- 若与当前设备平台不同，提示"跨平台导入可能存在兼容性问题，是否继续？"
- 不作为 v1 必保项

---

## 10. 后续扩展

### 10.1 可选功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 自动备份 | P2 | 每日/每周自动备份到指定目录 |
| 增量备份 | P2 | 仅备份变更数据 |
| 密码保护 | P2 | 备份文件 AES-GCM 加密（用户设定密码） |
| 云端同步 | P3 | 备份到云存储服务 |

---

## 11. 待确定事项

- [ ] 备份文件最大 size 限制
- [ ] 是否需要导出为其他格式（如 CSV）
