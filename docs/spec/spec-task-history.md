# 规格变更文档 - 任务历史与全量查看

## 文档信息

- 用途：记录用户反馈的产品改进需求与对应规格变更
- 作者：YiKe 团队
- 创建日期：2026-02-28
- 变更类型：功能增强
- 版本：v1.4（排序口径调整版）

---

## 1. 问题陈述

### 1.1 用户反馈

用户在使用过程中提出以下不满：

| 序号 | 问题描述 | 影响 |
|------|----------|------|
| P1 | 缺少一个可以查看所有任务的界面，用户无法按时间顺序浏览历史任务 | 用户无法直观了解复习任务的整体情况 |
| P2 | 首页只展示「今日待复习」和「逾期任务」，已完成/已跳过的任务被直接隐藏 | 1. 无法回顾今天做了什么<br>2. 误操作（选错完成/跳过）后无法快速纠正 |

### 1.2 根本原因分析

1. **首页设计导向**：当前首页（HomePage）聚焦于「今日待办」，默认隐藏已完成/已跳过状态
2. **缺少全局视图**：日历页面需选中特定日期才能查看任务，缺乏一个全局的任务列表视图
3. **状态过滤缺失**：首页未提供「显示已完成/已跳过」的切换开关

---

## 2. 定义口径（关键）

### 2.1 时间口径定义

为避免后续实现歧义，明确以下时间字段的使用场景：

| 场景 | 使用字段 | 说明 |
|------|----------|------|
| 任务计划日期 | `scheduledDate` | 任务原本应该复习的日期 |
| 实际完成时间 | `completedAt` | 用户点击"完成"时的时间戳 |
| 实际跳过时间 | `skippedAt` | 用户点击"跳过"时的时间戳 |

**「按时间正序浏览历史任务」的语义**：
- 按任务的「发生时间」排序（从早到晚），即：
  - 待复习(pending)：使用 `scheduledDate`
  - 已完成(done)：使用 `completedAt`
  - 已跳过(skipped)：使用 `skippedAt`
- 这样用户可以清晰地看到「今天完成了什么、跳过了什么」

**边界条件**：
- 若 `status = done` 但 `completedAt` 为空（历史数据兼容），回退使用 `scheduledDate` 作为发生时间，UI 不显示完成时间
- 若 `status = skipped` 但 `skippedAt` 为空，回退使用 `scheduledDate` 作为发生时间，UI 不显示跳过时间
- 「今天」的定义：本地时区的 00:00~24:00，使用项目现有 `YikeDateUtils.atStartOfDay()` 工具

### 2.2 首页「今日已完成」的分组口径

**决策**：按**完成日/跳过日**分组，而不是按计划日分组。

**理由**：
1. 更符合用户「回顾今天做了什么」的心理模型
2. 解决「今天补做逾期任务」的归类歧义：用户今天完成的逾期任务，归入「今日已完成」

**实现规则**：
- 今日已完成列表 = 所有 `completedAt` 为今天的任务（`completedAt` 日期等于当前日期）
- 今日已跳过列表 = 所有 `skippedAt` 为今天的任务

### 2.3 首页「全部」的范围定义

首页筛选器选择「全部」时，**仅在「今日视角」范围内**展示：

| 分类 | 是否包含 | 说明 |
|------|----------|------|
| 今日待复习 | ✅ 包含 | scheduledDate = 今天 且 status = pending |
| 今日已完成 | ✅ 包含 | completedAt = 今天 |
| 今日已跳过 | ✅ 包含 | skippedAt = 今天 |
| 逾期待复习 | ✅ 包含 | scheduledDate < 今天 且 status = pending |
| 逾期已完成 | ❌ 不包含 | completedAt < 今天（历史数据不展示在首页） |
| 历史任务 | ❌ 不包含 | 仅在任务中心页面查看 |

**本质**：首页是「今日视角」，只展示与今天相关的任务；完整的全量任务在任务中心页面查看。

### 2.4 撤销操作的业务影响

撤销任务状态会产生以下副作用，需要在实现时处理：

| 影响项 | 说明 |
|--------|------|
| **日历圆点** | 撤销后，该任务不再计入当天的完成/跳过统计，可能导致历史天的日历圆点消失 |
| **统计页面** | 撤销后，该任务的统计数据从历史统计中扣除，可能影响「今日完成数」「连续打卡」等指标 |
| **连续打卡** | 打卡按 `scheduledDate` + `status = done` 计算（现有实现），撤销会影响该计划日当天的打卡记录 |
| **复习轮次** | 撤销不改变复习轮次，任务恢复为 pending 后仍处于同一轮次 |

**实现建议**：撤销操作后刷新所有相关页面的数据（首页、日历、统计）。

---

## 3. 变更方案概述

### 3.1 核心策略

| 策略 | 说明 |
|------|------|
| 新增「任务中心」页面 | 提供全局任务视图，按「发生时间」正序展示所有任务 |
| 首页状态过滤 | 首页增加「显示已完成/已跳过」的筛选开关 |
| 任务可逆操作 | 已完成/已跳过任务支持「撤销」操作 |
| 二次确认 | 撤销操作需要弹窗确认（因副作用较重） |

### 3.2 涉及模块

- **首页 (HomePage)**：增加过滤开关、状态切换、撤销功能
- **新页面：任务中心 (TaskHubPage)**：全局任务列表
- **统计页面**：撤销后数据一致性
- **数据库层**：可能需要新增索引（见 5.3 性能考量）
- **路由层**：新增路由配置

---

## 4. 详细功能设计

### 4.1 首页增强

#### 4.1.1 状态筛选器

**位置**：首页顶部，与「批量操作」入口同层级

**UI 规格**：
- 样式参考现有 `TaskFilterBar` 组件（`lib/presentation/widgets/task_filter_bar.dart`）
- 筛选模式：**单选**，选项为「全部 / 待复习 / 已完成 / 已跳过」
- 默认值：「待复习」（保持现有行为不变）

**⚠️ 状态隔离要求**：
- 首页使用**独立的 filter provider/状态**，不与日历页面的 `reviewTaskFilterProvider` 共享
- 原因：日历筛选是按选中日筛选（all/pending/done/skipped），首页是按今日视角筛选，两者语义不同
- 建议实现：新增 `homeTaskFilterProvider`（StateProvider<ReviewTaskFilter>），首页专用

**交互逻辑**：
- 点击选项后，实时筛选当前展示的任务列表
- 筛选逻辑：
  - `pending`：筛选 status = pending 且 scheduledDate ≤ 今天 的任务
  - `done`：筛选 status = done 且 completedAt = 今天 的任务
  - `skipped`：筛选 status = skipped 且 skippedAt = 今天 的任务
  - `all`：筛选与今日相关的所有任务（见 2.3 范围定义）

#### 4.1.2 首页布局调整

**现有布局**：
```
[逾期任务]
[今日待复习]
```

**新增布局**：
```
[状态筛选器] ← 新增
[逾期任务]（仅当有待处理逾期时显示）
[今日待复习] / [今日已完成] / [今日已跳过] ← 根据筛选器切换
```

**分组逻辑**：
- 「今日待复习」= scheduledDate = 今天 且 status = pending
- 「今日已完成」= completedAt = 今天（不论 scheduledDate 是什么）
- 「今日已跳过」= skippedAt = 今天（不论 scheduledDate 是什么）

#### 4.1.3 任务卡片状态展示

**待复习任务**：保持现有 UI（可完成/可跳过）
**已完成任务**：
- 卡片右上角显示绿色「已完成」标签
- 操作按钮区显示「撤销」按钮（点击后弹出确认框）
- 显示完成时间 `completedAt`（若为空则不显示）

**已跳过任务**：
- 卡片右上角显示黄色「已跳过」标签
- 操作按钮区显示「撤销」按钮（点击后弹出确认框）
- 显示跳过时间 `skippedAt`（若为空则不显示）

#### 4.1.4 撤销操作确认

**触发场景**：用户点击「撤销」按钮

**确认方式**：弹出确认对话框
- 标题：「撤销任务状态？」
- 内容：「该任务将恢复为待复习状态。此操作可能影响今日统计和连续打卡天数，是否确认撤销？」
- 按钮：「取消」「确认撤销」

**后端逻辑**：
1. 更新 `status` 为 `pending`
2. 清空 `completedAt`（如果是已完成撤销）
3. 清空 `skippedAt`（如果是已跳过撤销）
4. **触发相关页面数据刷新**：首页、日历、统计

---

### 4.2 新增：任务中心页面 (TaskHub)

#### 4.2.1 入口决策

**最终方案**：**替换「帮助」Tab**，原因：
1. 「帮助」是低频功能，用户主动访问少
2. 任务中心优先级更高，值得拥有一个底部导航入口

**底部导航调整**：
| 索引 | 原方案 | 新方案 |
|------|--------|--------|
| 0 | 首页 | 首页 |
| 1 | 日历 | 日历 |
| 2 | 统计 | 统计 |
| 3 | 帮助 | **任务中心** |
| 4 | 设置 | 设置 |

**路由调整说明**：
- 底部导航索引 3：从 `/help` 改为 `/tasks`（任务中心）
- `/help` 路由保留，但通过 **GoRouter redirect** 重定向到 `/settings/help`
- 帮助页面入口改为「设置页内入口」（如设置页底部链接）

#### 4.2.2 功能特性

| 特性 | 说明 |
|------|------|
| 入口 | 底部导航栏「任务」Tab |
| 时间线展示 | 按「发生时间」正序（见 2.1 定义） |
| 日期分组 | 同一天的任务归为一块，显示日期标题（如「今天」「昨天」「2月25日」） |
| 游标分页 | 每次滚动到底部加载下一页，避免 offset 性能问题 |
| 状态筛选 | 顶部提供筛选器：全部/待复习/已完成/已跳过（单选） |
| 任务操作 | 点击任务卡片展开详情，支持完成/跳过/撤销 |

#### 4.2.3 UI 布局

```
┌─────────────────────────────┐
│ 📋 任务中心                 │  ← 页面标题
├─────────────────────────────┤
│ [全部] [待复习] [已完成] [已跳过] │  ← 状态筛选器（单选）
├─────────────────────────────┤
│ 今天                        │  ← 日期分组标题
│ ┌─────────────────────┐    │
│ │ 任务卡片1  [已完成]  │    │
│ └─────────────────────┘    │
│ ┌─────────────────────┐    │
│ │ 任务卡片2  [已跳过]  │    │
│ └─────────────────────┘    │
├─────────────────────────────┤
│ 昨天                        │
│ ┌─────────────────────┐    │
│ │ 任务卡片3  [已完成]  │    │
│ └─────────────────────┘    │
├─────────────────────────────┤
│ 2月25日                     │
│ ┌─────────────────────┐    │
│ │ 任务卡片4  [待复习]  │    │
│ └─────────────────────┘    │
├─────────────────────────────┤
│ ...                         │  ← 滚动加载更多
└─────────────────────────────┘
```

#### 4.2.4 交互细节

- **下拉刷新**：从顶部下拉刷新当前列表
- **上拉加载**：滚动到底部自动加载下一页（每页 20 条）
- **卡片点击**：点击卡片展开/收起详情操作区
- **状态变更反馈**：完成/跳过/撤销后，Snackbar 提示并更新列表
- **日期标题语义**：
  - 「今天」= 发生时间 = 今天
  - 「昨天」= 发生时间 = 昨天
  - 「MM月DD日」= 具体日期

#### 4.2.5 游标分页设计

**排序规则**：
- 一级排序：按「发生时间」正序
- 二级排序：同一 occurredAt 内按 `taskId` 正序（确保稳定排序）

**游标定义**（二元组）：
```
cursor = (occurredAt, taskId)
```
- `occurredAt`：该条任务的「发生时间」（pending 用 scheduledDate，done 用 completedAt，skipped 用 skippedAt）
- `taskId`：确保同一时间多条记录时排序稳定

**下一页查询条件**（采用方案1）：
```sql
WHERE (occurredAt, taskId) > (cursor.occurredAt, cursor.taskId)
ORDER BY occurredAt ASC, taskId ASC
LIMIT 20
```

**边界条件**：
- 首页查询：`occurredAt = 今天` 的任务
- 向后查询：`occurredAt > cursor.occurredAt` 或 `occurredAt = cursor.occurredAt AND taskId > cursor.taskId`

---

## 5. 数据模型与性能

### 5.1 现有模型复用

无需新增数据表，复用现有 `ReviewTaskEntity` 和 `ReviewTaskViewEntity`：

```dart
// 任务视图实体（已有字段）
class ReviewTaskViewEntity {
  final int taskId;
  final int learningItemId;
  final String title;
  final String? note;
  final List<String> tags;
  final int reviewRound;
  final DateTime scheduledDate;      // 计划日期
  final ReviewTaskStatus status;     // pending/done/skipped
  final DateTime? completedAt;       // 完成时间
  final DateTime? skippedAt;         // 跳过时间
}
```

### 5.2 新增 UseCase

| UseCase | 用途 |
|---------|------|
| `GetTodayCompletedTasksUseCase` | 获取今日已完成任务（按 completedAt = 今天） |
| `GetTodaySkippedTasksUseCase` | 获取今日已跳过任务（按 skippedAt = 今天） |
| `GetTasksByTimeUseCase` | 按「发生时间」获取全局任务列表，支持游标分页与状态筛选 |
| `UndoTaskStatusUseCase` | 撤销任务状态（done/skipped → pending），并触发相关数据刷新 |

### 5.3 性能考量

**现有索引**：
- `review_tasks` 表已有索引：`scheduledDate`, `status`

**新增查询需求**：
- 按 `completedAt = 今天` 查询
- 按 `skippedAt = 今天` 查询
- 按（`completedAt` 或 `skippedAt`）排序

**性能方案选择**：

| 方案 | 说明 | 成本 |
|------|------|------|
| 方案A：接受全表扫描 | 数据量 < 1万条时可接受，加载慢但功能正确 | 无需变更 |
| 方案B：新增索引 | 新增 `(completedAt, status)` 和 `(skippedAt, status)` 复合索引 | 需数据库迁移 |

**建议**：
- v1.2 先采用方案A（接受一定性能损耗），同时在文档中标注
- 若上线后用户反馈卡顿，升级到方案B

**降级策略**：
- 首次加载限制为最近 7 天数据，而非 30 天
- 分页每页 20 条，避免单次加载过多

---

## 6. 路由配置

### 6.1 路由路径

| 路径 | 页面 | 说明 |
|------|------|------|
| `/tasks` | TaskHubPage | 任务中心页面（底部导航索引 3） |
| `/home` | HomePage | 首页（现有） |
| `/calendar` | CalendarPage | 日历页面（现有） |
| `/statistics` | StatisticsPage | 统计页面（现有） |
| `/settings` | SettingsPage | 设置页面（现有） |
| `/settings/help` | HelpPage | 帮助页面（从设置页进入） |
| `/help` | HelpPage | 重定向到 `/settings/help`（GoRouter redirect） |

### 6.2 底部导航栏调整

**ShellScaffold 调整**：
- 将索引 3 从 `/help` 改为 `/tasks`
- 帮助入口改为从设置页进入

```dart
// 调整后的索引映射
int _locationToIndex(String location) {
  if (location.startsWith('/settings')) return 4;
  if (location.startsWith('/tasks')) return 3;  // 任务中心
  if (location.startsWith('/statistics')) return 2;
  if (location.startsWith('/calendar')) return 1;
  return 0;
}

void _onTap(BuildContext context, int index) {
  switch (index) {
    case 0: context.go('/home'); return;
    case 1: context.go('/calendar'); return;
    case 2: context.go('/statistics'); return;
    case 3: context.go('/tasks'); return;      // 任务中心
    case 4: context.go('/settings'); return;
  }
}
```

---

## 7. 验收标准

### 7.1 首页增强

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC1.1 | 首页顶部显示状态筛选器，默认选中「待复习」 | 打开首页，检查筛选器存在且默认选项正确 |
| AC1.2 | 筛选器为单选模式，点击「已完成」后，首页仅显示今日已完成的任务 | 选择已完成筛选项，验证列表内容 |
| AC1.3 | 今日已完成的定义：completedAt = 今天（不论 scheduledDate） | 完成一条昨日的逾期任务，验证出现在今日已完成列表 |
| AC1.4 | 首页筛选器状态独立，不受日历页面筛选器影响 | 在日历切换筛选，再回首页检查状态独立 |
| AC1.5 | 已完成任务卡片显示「已完成」标签和完成时间 | 完成一条任务后，检查卡片展示 |
| AC1.6 | 已完成任务显示「撤销」按钮，点击后弹出确认框 | 点击撤销按钮，检查对话框内容包含副作用提示 |
| AC1.7 | 确认撤销后，任务状态恢复为待复习 | 确认撤销，刷新页面验证状态变为 pending |
| AC1.8 | 撤销后，刷新日历和统计页面数据 | 撤销一条已完成任务，检查日历圆点和统计是否更新 |
| AC1.9 | 选择「全部」时，首页展示：今日待复习 + 今日已完成 + 今日已跳过 + 逾期待复习 | 选择全部，检查各分类任务都出现 |

### 7.2 任务中心页面

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC2.1 | 底部导航栏第4个 Tab 改为「任务」入口 | 检查导航栏 |
| AC2.2 | 点击「任务」进入任务中心页面 | 点击导航，验证页面跳转 |
| AC2.3 | 任务按「发生时间」正序排列：pending 用 scheduledDate，done 用 completedAt，skipped 用 skippedAt | 完成/跳过任务后，检查列表排序 |
| AC2.4 | 日期分组显示（如「今天」「昨天」「2月25日」） | 查看列表，验证分组正确 |
| AC2.5 | 顶部筛选器（单选）可切换状态筛选 | 选择不同筛选项，验证列表更新 |
| AC2.6 | 滚动到底部自动加载更多任务（游标分页） | 滚动列表，验证分页加载 |
| AC2.7 | 点击任务卡片可展开操作区 | 点击卡片，验证展开效果 |
| AC2.8 | 支持完成/跳过/撤销操作 | 执行各操作，验证状态变更 |
| AC2.9 | 撤销任务后，任务中心列表同步更新 | 撤销任务，检查列表刷新 |

### 7.3 通用验收

| 编号 | 验收点 | 测试方法 |
|------|--------|----------|
| AC3.1 | 状态变更后 Snackbar 提示用户 | 执行操作，检查提示 |
| AC3.2 | 撤销确认框中包含副作用提示（影响统计/打卡） | 打开撤销对话框，检查提示文字 |
| AC3.3 | 数据变更后相关页面（首页/日历/统计）同步刷新 | 完成/撤销后，切换页面验证数据一致性 |
| AC3.4 | 帮助页面可从设置页进入 | 检查设置页是否有帮助入口 |
| AC3.5 | `/help` 路由重定向到 `/settings/help` | 直接访问 /help 应自动跳转到设置页帮助入口 |

---

## 8. 优先级与排期

| 优先级 | 功能 | 说明 |
|--------|------|------|
| P0 | 首页状态筛选器 + 撤销功能 | 解决用户核心痛点 |
| P0 | 撤销后数据一致性（首页/日历/统计刷新） | 避免数据不一致 |
| P0 | 首页筛选器状态独立（独立 provider） | 避免状态耦合 |
| P1 | 任务中心页面 | 提供全局任务视图 |
| P1 | 底部导航栏调整（替换帮助 Tab） | 信息架构落地 |
| P2 | 任务中心分页加载（游标分页） | 优化大数据量体验 |
| P2 | 性能优化（必要时的索引新增） | 上线后根据反馈决定 |
| P3 | 搜索功能（可选） | 后续版本规划 |

---

## 9. 附录

### 9.1 相关文件

- 首页实现：`lib/presentation/pages/home/home_page.dart`
- 筛选组件：`lib/presentation/widgets/task_filter_bar.dart`
- 底部导航：`lib/presentation/pages/shell/shell_scaffold.dart`
- 任务实体：`lib/domain/entities/review_task.dart`
- 路由配置：`lib/infrastructure/router/app_router.dart`
- 数据库表：`lib/data/database/tables/review_tasks_table.dart`
- 日期工具：`lib/core/utils/date_utils.dart`（YikeDateUtils）

### 9.2 术语表

| 术语 | 定义 |
|------|------|
| 待复习 (pending) | 任务状态为待执行 |
| 已完成 (done) | 用户点击完成后的状态 |
| 已跳过 (skipped) | 用户点击跳过后的状态 |
| 撤销 | 将已完成/已跳过状态恢复为待复习 |
| 发生时间 | 完成用 completedAt，跳过用 skippedAt，待复习用 scheduledDate |
| 游标分页 | 使用 (发生时间, taskId) 二元组作为游标，避免 offset 性能问题 |
| 今日视角 | 首页筛选的上下文范围：今日待复习 + 今日已完成 + 今日已跳过 + 逾期待复习 |

### 9.3 修订历史

| 版本 | 日期 | 修订内容 |
|------|------|----------|
| v1.0 | 2026-02-28 | 初始版本 |
| v1.1 | 2026-02-28 | 补充口径定义、修正筛选设计为单选、定稿底部导航方案、明确游标分页 |
| v1.2 | 2026-02-28 | 明确首页筛选器状态独立、补充首页「全部」范围定义、严格化游标分页二元组定义、补充数据库性能说明和边界条件（completedAt/skippedAt 空值回退）、修正文案错误、统一路由方案 |
| v1.3 | 2026-02-28 | 修复游标分页排序与查询条件不匹配（改为DESC+DESC）、明确/help重定向到/settings/help、写死连续打卡按scheduledDate计算 |
| v1.4 | 2026-02-28 | 任务中心排序口径调整为发生时间正序（ASC+ASC），并同步更新游标分页口径与验收点 |
