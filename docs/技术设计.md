# 忆刻 (YiKe) — 技术设计文档

## 文档概述

本文档是忆刻产品的技术设计提纲，涵盖技术架构、核心设计、各版本技术要点等内容。详细技术设计请参考各版本 TDD 文档。

---

## 1. 技术架构

### 1.1 整体架构

采用 **Clean Architecture** 分层架构：

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                   │
│  (Pages, Widgets, Providers, States)                  │
├─────────────────────────────────────────────────────────┤
│                      Domain Layer                        │
│  (Entities, Use Cases, Repository Interfaces)           │
├─────────────────────────────────────────────────────────┤
│                       Data Layer                         │
│  (Repository Implementations, Data Sources, Models)     │
├─────────────────────────────────────────────────────────┤
│                    Infrastructure                         │
│  (Database, Notifications, Widget, Platform Services)   │
└─────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

| 类别 | 技术方案 | 版本 |
|------|----------|------|
| 跨端框架 | Flutter | SDK ^3.11.0 |
| 状态管理 | Riverpod | flutter_riverpod ^2.5.1 |
| 本地数据库 | Drift (SQLite) | drift ^2.16.0 |
| 路由管理 | GoRouter | go_router ^14.0.0 |
| 日期处理 | intl | intl ^0.19.0 |
| 本地通知 | flutter_local_notifications | ^17.0.0 |
| 桌面小组件 | home_widget | ^0.6.0 |
| 加密存储 | flutter_secure_storage | ^9.0.0 |

---

## 2. 目录结构

```
lib/
├── main.dart                         # 应用入口
├── app.dart                          # App 根组件
│
├── core/                             # 核心模块
│   ├── constants/                    # 颜色、字体、间距常量
│   ├── theme/                        # 应用主题配置
│   ├── utils/                        # 工具函数
│   └── extensions/                   # Dart 扩展
│
├── data/                             # 数据层
│   ├── database/                      # 数据库、Table、DAO
│   ├── repositories/                  # Repository 实现
│   └── models/                       # 数据模型
│
├── domain/                           # 领域层
│   ├── entities/                     # 业务实体
│   ├── repositories/                 # Repository 接口
│   └── usecases/                     # 用例
│
├── presentation/                     # 展示层
│   ├── providers/                    # Riverpod Provider
│   ├── pages/                        # 页面组件
│   └── widgets/                      # 通用小组件
│
├── infrastructure/                    # 基础设施层
│   ├── notification/                 # 通知服务
│   ├── widget/                       # 桌面小组件服务
│   ├── storage/                      # 安全存储服务
│   └── router/                       # 路由配置
│
└── di/                               # 依赖注入
    └── providers.dart                # Provider 定义
```

---

## 3. 数据库设计

### 3.1 核心数据表

#### 学习内容表 (learning_items)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| title | String | 标题（必填，≤50字） |
| note | String? | 备注（可选） |
| tags | String | 标签列表（JSON 格式） |
| learningDate | DateTime | 学习日期 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime? | 更新时间 |

#### 复习任务表 (review_tasks)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| learningItemId | Int | 外键，关联学习内容 |
| reviewRound | Int | 复习轮次（1-5） |
| scheduledDate | DateTime | 计划复习日期 |
| status | String | 状态：pending/done/skipped |
| completedAt | DateTime? | 完成时间 |
| skippedAt | DateTime? | 跳过时间 |
| createdAt | DateTime | 创建时间 |

#### 应用设置表 (app_settings)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| key | String | 设置键名（唯一） |
| value | String | 设置值（JSON 格式） |
| updatedAt | DateTime | 更新时间 |

### 3.2 v2.1 新增数据表

#### 学习模板表 (learning_templates)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| name | String | 模板名称 |
| titlePattern | String | 标题模板（含占位符） |
| notePattern | String? | 备注模板 |
| tags | String | 默认标签（JSON） |
| sortOrder | Int | 排序 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime? | 更新时间 |

#### 学习主题表 (learning_topics)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| name | String | 主题名称 |
| description | String? | 主题描述 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime? | 更新时间 |

#### 主题-内容关联表 (topic_item_relations)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| topicId | Int | 外键，关联主题 |
| learningItemId | Int | 外键，关联学习内容 |
| createdAt | DateTime | 创建时间 |

---

## 4. 状态管理 (Riverpod)

### 4.1 核心 Provider

| Provider | 类型 | 用途 |
|----------|------|------|
| `learningItemProvider` | StateNotifier | 学习内容列表 |
| `todayTasksProvider` | StateNotifier | 今日复习任务 |
| `settingsProvider` | StateNotifier | 应用设置 |
| `calendarProvider` | StateNotifier | 日历视图任务 |
| `statisticsProvider` | StateNotifier | 统计数据 |
| `themeModeProvider` | StateNotifier | 主题模式 |

### 4.2 ThemeMode 枚举

```dart
enum AppThemeMode {
  system('system', '跟随系统'),
  light('light', '浅色'),
  dark('dark', '深色');
}
```

---

## 5. 路由设计 (GoRouter)

### 5.1 路由结构

```dart
// 底部导航（4个 Tab）
ShellRoute
├── /home           # 首页 - 今日任务
├── /calendar       # 日历视图
├── /statistics     # 学习统计
├── /settings       # 设置页
│
// Modal 页面
├── /input          # 录入页面
├── /settings/export    # 数据导出
├── /input/import      # 批量导入预览
├── /input/templates   # 模板管理
├── /topics            # 主题管理
└── /topics/:id        # 主题详情
```

---

## 6. 各版本技术要点

### 6.1 v1.0 MVP

**核心功能实现：**

- **学习内容录入**：LearningItemEntity + CreateLearningItemUseCase
- **艾宾浩斯复习计划**：默认间隔 [1,2,4,7,15] 天自动生成 5 个复习任务
- **任务完成**：CompleteReviewTaskUseCase 更新状态
- **通知提醒**：flutter_local_notifications + WorkManager 定时检查
- **桌面小组件**：home_widget 数据同步

### 6.2 v2.0

**新增依赖：**

| 包 | 用途 |
|----|------|
| table_calendar | 日历组件 |
| fl_chart | 图表组件 |
| share_plus | 系统分享 |

**新增功能：**

- **日历视图**：月份任务统计 + 日期任务列表
- **学习统计**：连续打卡天数、完称率、标签分布
- **数据导出**：JSON/CSV 文件生成 + 系统分享

### 6.3 v2.1

**新增依赖：**

| 包 | 用途 |
|----|------|
| file_picker | 文件选择 |
| csv | CSV 解析 |
| speech_to_text | 语音识别 |
| google_mlkit_text_recognition | OCR 文字识别 |
| image_picker | 图片选择 |
| permission_handler | 权限管理 |

**新增功能：**

- **批量导入**：文件解析器支持 TXT/CSV/Markdown
- **快速模板**：模板 CRUD + 占位符替换
- **语音输入**：speech_to_text 封装
- **OCR 识别**：ML Kit 文字识别
- **复习预览**：自定义间隔配置面板
- **内容关联**：主题管理 + 关联关系

### 6.4 v2.2

**技术方案：**

- **深色主题**：`AppTheme.dark()` 返回深色 ThemeData
- **跟随系统**：Flutter ThemeMode.system 自动响应
- **主题存储**：app_settings 表，key = 'theme_mode'

**核心改动：**

- 扩展 AppColors 深色配色常量
- 修改 GlassCard 组件支持动态主题适配
- 新增 GradientBackground 渐变背景组件
- 新增 ThemeProvider 状态管理

---

## 7. 通知服务

### 7.1 通知类型

| 类型 | 用途 | 触发条件 |
|------|------|----------|
| 每日提醒 | 复习任务提醒 | 每日固定时间（默认 09:00） |
| 复习提醒 | 特定任务到期 | 任务计划日期当天 |

### 7.2 实现方案

- 使用 flutter_local_notifications 实现本地推送
- 使用 WorkManager 定时检查（精度约 ±30 分钟）
- 支持免打扰时段设置

---

## 8. 性能优化

### 8.1 性能指标

| 指标 | 目标值 |
|------|--------|
| 冷启动时间 | ≤ 2s |
| 页面切换 | ≤ 300ms |
| 列表滚动 | 60 FPS |
| 数据库查询 | ≤ 100ms |

### 8.2 优化策略

- 数据库查询使用索引加速
- 批量插入减少事务次数
- 使用 `const` 构造函数
- 使用 `select` 减少不必要的重建

---

## 9. 安全考虑

| 措施 | 说明 |
|------|------|
| 本地加密 | flutter_secure_storage 加密敏感配置 |
| 导出数据 | 提供 JSON 格式导出 |

---

## 10. 错误处理

### 异常类型

| 异常类型 | 说明 | 处理方式 |
|----------|------|----------|
| DatabaseException | 数据库操作失败 | 显示错误提示，提供重试 |
| NotificationException | 通知权限/发送失败 | 引导用户开启权限 |
| StorageException | 本地存储失败 | 提示并记录日志 |
| ValidationException | 数据验证失败 | 输入框显示错误信息 |

---

## 11. 文档更新日志

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2025-02-25 | v1.0 | 创建初始文档 |
| 2026-02-25 | v2.0 | 添加日历视图、统计、导出技术设计 |
| 2026-02-26 | v2.1 | 添加录入功能升级技术设计 |
| 2026-02-26 | v2.2 | 添加主题功能升级技术设计 |
| 2026-02-26 | v3.0 | 添加跨平台与同步技术设计 |

---

*本文档是技术设计文档的提纲，详细技术设计请参考：*
- `docs/tdd/技术设计-v1.md` - MVP 技术设计
- `docs/tdd/技术设计-v2.md` - v2.0 技术设计
- `docs/tdd/技术设计-v2.1.md` - v2.1 技术设计
- `docs/tdd/技术设计-v2.2.md` - v2.2 技术设计
- `docs/tdd/技术设计-v3.0.md` - v3.0 跨平台与同步技术设计
